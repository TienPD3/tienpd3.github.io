<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Pro - TienPD3</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2014-11-29/FileSaver.min.js"></script>
    <link href="website/css/spreadjs/gc.spread.sheets.excel2016colorful.16.0.2.css" rel="stylesheet" type="text/css" />
    <script type="text/javascript" src="website/scripts/spreadjs/gc.spread.sheets.all.16.0.2.min.js"></script>
    <script type="text/javascript" src="website/scripts/spreadjs/interop/gc.spread.excelio.16.0.2.min.js"></script>
    <script type="text/javascript" src="website/license/spreadjs/license-30trail.js"></script>
    <script type="text/javascript" src="website/common/function.fireant.js"> </script>
    <script type="text/javascript" src="website/common/function.update.js"> </script>
    <script type="text/javascript" src="website/common/const.js"> </script>
    <script type="text/javascript" src="website/common/spreadjs.js"> </script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script> 

    <script type="text/javascript" src="website/scripts/select2/select2.full.min.js"> </script>
    <link href='website/css/select2/select2.min.css' rel='stylesheet' type='text/css'>
    <script type="text/javascript" src="https://e.cafef.vn/kby.ashx"> </script>

    <!-- aui.atlassian.com -->
    <script type="text/javascript" src="website/common/function.simplize.js"> </script>
    <link rel="stylesheet" type="text/css" href="https://unpkg.com/@atlassian/aui@9.5.1/dist/aui/aui-prototyping.css"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sinon.js/1.15.4/sinon.js"></script>
    <script src="https://unpkg.com/@atlassian/aui@9.5.1/dist/aui/aui-prototyping.js"></script>
    <!-- / aui.atlassian.com -->

    <script>
        $(document).ready(function() {
            buildUrlSimplize();
            var firstValue = buildDropdownStockList($('#idStockList'));
            initBuildDropdownStockCode(firstValue.id, firstValue.symbol, firstValue.rules)

            $(document).on('change', '#drpdStockList', function() {
                const id = $(this).find('option:selected').attr('id');
                const rules = $(this).find('option:selected').attr('rules');
                initBuildDropdownStockCode(id, rules)
                var drpdSelected = JSON.parse(localStorage.getItem('drpdSelected')) || {};
                drpdSelected.stockListSelected = id;
                localStorage.setItem('drpdSelected', JSON.stringify(drpdSelected))
            });

            $(document).on('change', '#drpdStockCode', function() {
                onChangeStockCode();
            });

        });

        function initBuildDropdownStockCode(pId, pRules) {

            buildDropdownStockCode($('#idStockCode'), pId, pRules);
            AJS.$("#drpdStockCode").auiSelect2();
            
            onChangeStockCode();
        }

        function onChangeStockCode() {
            var pSymbol = $('#drpdStockCode').find('option:selected').attr('id');
            var filter = $(oc).filter(function (i, elm) {
                return elm.c === pSymbol
            })[0];
            loadData(filter.c, filter.m, filter.san);
            var drpdSelected = JSON.parse(localStorage.getItem('drpdSelected')) || {};
            drpdSelected.stockCodeSelected = pSymbol;
            localStorage.setItem('drpdSelected', JSON.stringify(drpdSelected))
        }
    </script>
    <script>
        var spread, excelIO;
        window.onload = function () {
            spread = new GC.Spread.Sheets.Workbook(document.getElementById("spreadSheet"));
            
        }

        function loadData(pSymbol, pName, pExchange) {
            
            setParameter(pSymbol, pName, pExchange);
            loadFile(pSymbol, pName);
        }

        function loadFile(pSymbol, pName) {

            resetData();
            excelIo = new GC.Spread.Excel.IO();
            var excelUrl = document.getElementById("importUrl").value + '?cache=' + uuidv4();

            var oReq = new XMLHttpRequest();
            oReq.open('get', excelUrl, true);
            oReq.responseType = 'blob';
            oReq.onload = function () {
                var blob = oReq.response;
                excelIo.open(blob, function (json) {

                    var spreadJson = JSON.stringify(json);
                    
                    // LNST 4 qúy gần nhất
                    var tmpEconomicInformation = getEconomicInformation();
                    var tmpObjectLNST = listLNST();
                    var tmpArrayLNST = tmpObjectLNST.arrayLNST;
                    var tmpArrayLNSTYear = tmpObjectLNST.year;
                    for (let i = 0; i < tmpArrayLNST.length; i++) {

                        // Chuyển năm hoặc quý
                        const strLNSTYear = tmpArrayLNSTYear[i];
                        spreadJson = spreadJson.replace("#QFY" + i, strLNSTYear);

                        const strLNST = tmpArrayLNST[i];
                        if (tmpEconomicInformation.isYear) {
                            if (i !== tmpArrayLNST.length - 1) {
                                spreadJson = spreadJson.replace('"#Q' + i +'"', '0.00');
                            }
                        }
                        spreadJson = spreadJson.replace('"#Q' + i +'"', strLNST);
                    }

                    // Chuyển 1 năm hay 4 quý
                    if (tmpEconomicInformation.isYear) {
                        spreadJson = spreadJson.replace('#QGN', '1 năm gấn nhất');
                    } else {
                        spreadJson = spreadJson.replace('#QGN', '4 quý gấn nhất');
                    }

                    // Chuyển mã chứng khoán
                    spreadJson = spreadJson.replace('#SYMBOL', pSymbol + ': ' + pName);

                    // LỢI NHUẬN SAU THUẾ 4 QUÝ GẦN NHẤT (tỷ đồng)
                    // VỐN CHỦ SỞ HỮU HIỆN TẠI (tỷ đồng)
                    var tmpLatestVCSH = getLatestVCSH();
                    // if (tmpEconomicInformation.isYear) {
                    //     tmpStrLatestVCSH = (tmpStrLatestVCSH / 4).round();
                    // }
                    
                    spreadJson = spreadJson.replace("#VCSHFY", tmpLatestVCSH.latestVCSHYear);
                    spreadJson = spreadJson.replace('"#VCSH"', tmpLatestVCSH.latestVCSH);
                    // TỶ LỆ CỔ TỨC (tính theo mệnh giá)
                    var tmpArrayLatestCT = getLatestCT();
                    spreadJson = spreadJson.replace("#TLCT", tmpArrayLatestCT.dividendPercent);
                    spreadJson = spreadJson.replace("#CT", tmpArrayLatestCT.dividend);
                    // THỊ GIÁ CỔ PHIẾU (đồng/cp)
                    var tmpStrLatestTGCP = getLatestTGCP();
                    spreadJson = spreadJson.replace('"#TGCP"', tmpStrLatestTGCP);
                    // TỔNG SỐ LƯỢNG CỔ PHIẾU (triệu cp)
                    var tmpStrKPCPDLH = getKPCPDLH();
                    spreadJson = spreadJson.replace('"#TSLCP"', tmpStrKPCPDLH);

                    // NHỮNG TIÊU CHUẨN ĐỂ ĐỊNH GIÁ MỘT DOANH NGHIỆP TÔT
                    var tmpFinancial = getFinancialIndicators();
                    // Doanh thu tăng đều theo biểu đồ (Đạt = 1, Không đạt = 0)
                    var tmpIsUpDTT = isGrowUpDTT();
                    spreadJson = spreadJson.replace('"#DTUP"', tmpIsUpDTT);
                    // Lợi nhuận gộp tăng đều theo biểu đồ (Đạt=1, Không đạt = 0)  
                    var tmpIsUpLNG = isGrowUpLNG();
                    spreadJson = spreadJson.replace('"#LNGUP"', tmpIsUpLNG);
                    // Tỷ lệ lãi gộp lớn hơn hoặc bằng 15%
                    spreadJson = spreadJson.replace('"#GOS"', tmpFinancial.LAI_GOP);
                    // Tỷ lệ lãi ròng lớn hơn hoặc bằng 5
                    spreadJson = spreadJson.replace('"#NPM"', tmpFinancial.LAI_RONG);
                    // ROA lớn hơn hoặc bằng 5%
                    spreadJson = spreadJson.replace('"#ROA"', tmpFinancial.ROA);
                    // ROE lớn hơn hoặc bằng 15%
                    spreadJson = spreadJson.replace('"#ROE"', tmpFinancial.ROE);
                    // ROIC lớn hơn hoặc bằng 10%
                    spreadJson = spreadJson.replace('"#ROIC"', tmpFinancial.ROIC);
                    // Nợ/VCSH nhỏ hơn hoặc =1
                    spreadJson = spreadJson.replace('"#NOVCSH"', tmpFinancial.NOVCSH);
                    // P/E <15(có thể 20) nhỏ hơn hoặc bằng 15
                    spreadJson = spreadJson.replace('"#PE"', tmpFinancial.PE);
                    // P/B<2(nhỏ hơn hoặc bằng 2)
                    spreadJson = spreadJson.replace('"#PB"', tmpFinancial.PB);

                    // Ban lãnh đạo mua bán cố phần (Đạt = 1, Không đạt = 0)
                    var tmpIsBLDMB = isLatestBLDMB();
                    spreadJson = spreadJson.replace('"#BLDMB"', tmpIsBLDMB);
                    // Dòng tiền từ hoạt động Kinh doanh dương (Đạt = 1, Không đạt = 0)
                    var tmpIsPositiveLNTHDKD = isPositiveLNTHDKD();
                    spreadJson = spreadJson.replace('"#DTP"', tmpIsPositiveLNTHDKD);
                    // Nợ dài hạn/LNST (quý hiện tại) nhỏ hơn  hoặc bằng 5
                    var tmpLatestNDH = getLatestNDH();
                    var tmpLatestLNST = getLatestLNST();
                    spreadJson = spreadJson.replace("#NDHLNSTFY", tmpLatestLNST.latestLNSTYear);
                    spreadJson = spreadJson.replace('"#NDHLNST"', (tmpLatestNDH / tmpLatestLNST.latestLNST).round());

                    getAjaxFullBusinessResults();
                    spreadJson = JSON.parse(spreadJson);
                    
                    spread.fromJSON(spreadJson);
                    hideEvaluationVersion(spread);
                    activeSheet(spread, 'ĐỊNH GIÁ');
                    spread.options.showVerticalScrollbar = false;
                    spread.options.scrollbarShowMax = false;
                    
                }, function (message) {
                    console.log(message);
                });
            };
            oReq.send(null);
        }
    </script>
</head>
<body>
    <form class="aui">
        <div class="field-group" id="idStockList">
            <label for="drpdStockList">Bộ lọc chứng khoán</label>
        </div>
        <div class="field-group" id="idStockCode">
            <label for="drpdStockCode">Mã chứng khoán</label>
            <select class="select" id="drpdStockCode" name="drpdStockCode" placeholder="Vui lòng chọn mã chứng khoán">
            </select>
        </div>
    </form>

    <!-- Dropdown -->       
    <div id="spreadSheet" style="width: 100%; height: 498px;"></div>
    <input type="hidden" id="importUrl" value="website/file/template.xlsx" />
</body>
</html>
