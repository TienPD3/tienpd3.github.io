<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Pro - TienPD3</title>

    <!-- spreadjs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2014-11-29/FileSaver.min.js"></script>
    <link rel="stylesheet" type="text/css" href="website/css/spreadjs/gc.spread.sheets.excel2016colorful.16.0.2.css"></link>
    <script type="text/javascript" src="website/scripts/spreadjs/gc.spread.sheets.all.16.0.2.min.js"></script>
    <script type="text/javascript" src="website/scripts/spreadjs/interop/gc.spread.excelio.16.0.2.min.js"></script>
    <script type="text/javascript" src="website/license/spreadjs/license-30trail.js"></script>
    <!-- / spreadjs -->
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script> 

    <!-- aui.atlassian.com -->
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/aui/9.5.1/aui/aui-prototyping.min.css"></link>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/sinon.js/15.0.1/sinon.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/aui/9.5.1/aui/aui-prototyping.min.js"></script>
    <!-- / aui.atlassian.com -->

    <!-- common -->
    <script type="text/javascript" src="website/common/function.fireant.js"> </script>
    <script type="text/javascript" src="website/common/function.simplize.js"></script>
    <script type="text/javascript" src="website/common/function.update.js"></script>
    <script type="text/javascript" src="website/common/const.js"> </script>
    <script type="text/javascript" src="website/common/spreadjs.js"> </script>
    <!-- / common -->

    <!-- site -->
    <script type="text/javascript" src="https://e.cafef.vn/kby.ashx"> </script>
    <!-- / site -->

    <script>
        $(document).ready(function() {
            buildUrlSimplize();
            var firstValue = buildDropdownStockList($('#idStockList'));
            initBuildDropdownStockCode(firstValue.id, firstValue.rules)

            $(document).on('change', '#drpdStockList', function() {
                const id = $(this).find('option:selected').attr('id');
                const rules = $(this).find('option:selected').attr('rules');
                initBuildDropdownStockCode(id, rules)
                var drpdSelected = JSON.parse(localStorage.getItem('drpdSelected')) || {};
                drpdSelected.stockListSelected = id;
                localStorage.setItem('drpdSelected', JSON.stringify(drpdSelected))
            });

            $(document).on('change', '#drpdStockCode', function() {
                onChangeStockCode();
            });

            $(document).on('click', '#btnNext', function() {
                $('#drpdStockCode > option:selected').next().attr('selected', 'selected');
                onChangeStockCode();
            });
        });

        function initBuildDropdownStockCode(pId, pRules) {

            buildDropdownStockCode($('#idStockCode'), pId, pRules);
            AJS.$("#drpdStockCode").auiSelect2();
            
            onChangeStockCode();
        }

        function onChangeStockCode() {
            AJS.$("#drpdStockCode").auiSelect2();
            var pSymbol = $('#drpdStockCode').find('option:selected').attr('id');
            var filter = $(oc).filter(function (i, elm) {
                return elm.c === pSymbol
            })[0];
            loadData(filter.c, filter.m, filter.san);
            var drpdSelected = JSON.parse(localStorage.getItem('drpdSelected')) || {};
            drpdSelected.stockCodeSelected = pSymbol;
            localStorage.setItem('drpdSelected', JSON.stringify(drpdSelected))
        }
    </script>
    <script>
        var spread, excelIO;
        window.onload = function () {
            spread = new GC.Spread.Sheets.Workbook(document.getElementById("spreadSheet"));
            
        }

        function loadData(pSymbol, pName, pExchange) {
            
            setParameter(pSymbol, pName, pExchange);
            loadFile(pSymbol, pName);
        }

        function loadFile(pSymbol, pName) {

            resetData();
            excelIo = new GC.Spread.Excel.IO();
            var excelUrl = document.getElementById('importUrl').value + '?cache=' + uuidv4();

            var oReq = new XMLHttpRequest();
            oReq.open('get', excelUrl, true);
            oReq.responseType = 'blob';
            oReq.onload = function () {
                var blob = oReq.response;
                excelIo.open(blob, function (json) {

                    var spreadJson = JSON.stringify(json);
                    
                    // LNST 4 qúy gần nhất
                    var tmpEconomicInformation = getEconomicInformation();
                    var tmpObjectLNST = listLNST();
                    var tmpArrayLNST = tmpObjectLNST.arrayLNST;
                    var tmpArrayLNSTYear = tmpObjectLNST.year;
                    for (let i = 0; i < tmpArrayLNST.length; i++) {

                        // Chuyển năm hoặc quý
                        const strLNSTYear = tmpArrayLNSTYear[i];
                        spreadJson = spreadJson.replaceExcel('#QFY' + i, strLNSTYear);

                        const strLNST = tmpArrayLNST[i];
                        if (tmpEconomicInformation.isYear) {
                            if (i !== tmpArrayLNST.length - 1) {
                                spreadJson = spreadJson.replace('#Q' + i, '0.00');
                            }
                        }
                        spreadJson = spreadJson.replaceExcel('#Q' + i, strLNST);
                    }

                    // Chuyển 1 năm hay 4 quý
                    if (tmpEconomicInformation.isYear) {
                        spreadJson = spreadJson.replaceExcel('#QGN', '1 năm gấn nhất');
                    } else {
                        spreadJson = spreadJson.replaceExcel('#QGN', '4 quý gấn nhất');
                    }

                    // Chuyển mã chứng khoán
                    spreadJson = spreadJson.replaceExcel('#SYMBOL', pSymbol + ': ' + pName);

                    // LỢI NHUẬN SAU THUẾ 4 QUÝ GẦN NHẤT (tỷ đồng)
                    // VỐN CHỦ SỞ HỮU HIỆN TẠI (tỷ đồng)
                    var tmpLatestVCSH = getLatestVCSH();
                    
                    spreadJson = spreadJson.replaceExcel('#VCSHFY', tmpLatestVCSH.latestVCSHYear);
                    spreadJson = spreadJson.replaceExcel('#VCSH', tmpLatestVCSH.latestVCSH);
                    // TỶ LỆ CỔ TỨC (tính theo mệnh giá)
                    var tmpArrayLatestCT = getLatestCT();
                    spreadJson = spreadJson.replaceExcel('#TLCT', tmpArrayLatestCT.dividendPercent);
                    spreadJson = spreadJson.replaceExcel('#CT', tmpArrayLatestCT.dividend);
                    // THỊ GIÁ CỔ PHIẾU (đồng/cp)
                    var tmpStrLatestTGCP = getLatestTGCP();
                    spreadJson = spreadJson.replaceExcel('#TGCP', tmpStrLatestTGCP);
                    // TỔNG SỐ LƯỢNG CỔ PHIẾU (triệu cp)
                    var tmpStrKPCPDLH = getKPCPDLH();
                    spreadJson = spreadJson.replaceExcel('#TSLCP', tmpStrKPCPDLH);

                    // NHỮNG TIÊU CHUẨN ĐỂ ĐỊNH GIÁ MỘT DOANH NGHIỆP TÔT
                    var tmpFinancial = getFinancialIndicators();
                    // Doanh thu tăng đều (Đạt = 1, Không đạt = 0)
                    var tmpIsUpDTT = isGrowUpDTT();
                    spreadJson = spreadJson.replaceExcel('#DTUP', tmpIsUpDTT);
                    // Lợi nhuận gộp tăng đều  (Đạt=1, Không đạt = 0)  
                    var tmpIsUpLNG = isGrowUpLNG();
                    spreadJson = spreadJson.replaceExcel('#LNGUP', tmpIsUpLNG);
                    // Tỷ lệ lãi gộp (>= 15%)
                    spreadJson = spreadJson.replaceExcel('#GOS', tmpFinancial.LAI_GOP);
                    // Tỷ lệ lãi ròng (>= 5)
                    spreadJson = spreadJson.replaceExcel('#NPM', tmpFinancial.LAI_RONG);
                    // ROA (>= 5%)
                    spreadJson = spreadJson.replaceExcel('#ROA', tmpFinancial.ROA);
                    // ROE (>= 15%)
                    spreadJson = spreadJson.replaceExcel('#ROE', tmpFinancial.ROE);
                    // ROIC (>= 10%)
                    spreadJson = spreadJson.replaceExcel('#ROIC', tmpFinancial.ROIC);
                    // Nợ/VCSH (<= 1)
                    spreadJson = spreadJson.replaceExcel('#NOVCSH', tmpFinancial.NOVCSH);
                    // P/E <15(có thể 20) <=15
                    spreadJson = spreadJson.replaceExcel('#PE', tmpFinancial.PE);
                    // P/B<2(<= 2)
                    spreadJson = spreadJson.replaceExcel('#PB', tmpFinancial.PB);
                    // Mô hình đơn giản tập chung (Đạt = 1, Không đạt = 0)
                    // Pending
                    // BBan lãnh đạo mua/bán cố phần (Đạt = 1, Không đạt = 0)
                    var tmpIsBLDMB = isLatestBLDMB();
                    spreadJson = spreadJson.replaceExcel('#BLDMB', tmpIsBLDMB);
                    // Dòng tiền từ HĐKD dương (Đạt = 1, Không đạt = 0)
                    var tmpIsPositiveLNTHDKD = isPositiveLNTHDKD();
                    spreadJson = spreadJson.replaceExcel('#DTP', tmpIsPositiveLNTHDKD);
                    // Nợ dài hạn(N/A)/LNST(N/A) (Q3/2022) <= 5
                    var tmpLatestNDH = getLatestNDH();
                    var tmpLatestLNST = getLatestLNST();
                    spreadJson = spreadJson.replaceExcel('#NDHLNSTFY', tmpLatestLNST.latestLNSTYear);
                    var tmpNDHLNST = 'N/A';
                    if (tmpLatestNDH !== undefined && tmpLatestLNST.latestLNST !== undefined) {
                        tmpNDHLNST = (convertZero(tmpLatestNDH) / tmpLatestLNST.latestLNST).round()
                    } 
                    spreadJson = spreadJson.replaceExcel('#NDHLNST', tmpNDHLNST);
                    spreadJson = spreadJson.replaceExcel('#NDH', tmpLatestNDH, true);
                    spreadJson = spreadJson.replaceExcel('#LNST', tmpLatestLNST.latestLNST, true);

                    // getAjaxFullBusinessResults();
                    spreadJson = JSON.parse(spreadJson);
                    
                    spread.fromJSON(spreadJson);
                    hideEvaluationVersion(spread);
                    activeSheet(spread, 'ĐỊNH GIÁ');
                    spread.options.showVerticalScrollbar = false;
                    spread.options.scrollbarShowMax = false;
                    
                }, function (message) {
                    console.log(message);
                });
            };
            oReq.send(null);
        }
    </script>
</head>
<body>
    <form class="aui">
        <label for="drpdStockList">Bộ lọc chứng khoán</label>
        <div id="idStockList"></div>
        <label for="drpdStockCode">Mã chứng khoán</label>
        <div id="idStockCode">
            <select class="select" id="drpdStockCode" name="drpdStockCode" placeholder="Vui lòng chọn mã chứng khoán"></select>
        </div>
    </form>

    <div id="spreadSheet" style="width: 100%; height: 470px;"></div>
    <input type="hidden" id="importUrl" value="website/file/template.xlsx" />

    <button id="btnNext" class="aui-button aui-button-primary">Kiểm tra mã tiếp theo</button>
</body>
</html>
