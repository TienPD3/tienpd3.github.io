<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="referrer" content="no-referrer">
    <link rel="shortcut icon" type="image/x-icon" href="/website/images/kanji/favicon.ico">
    <link rel="apple-touch-icon" sizes="180x180" href="/website/images/kanji/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/website/images/kanji/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/website/images/kanji/favicon-16x16.png">
    <title>Kanji</title>
    <link rel="stylesheet" href="../css/common/function.kanji.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script defer src="/website/scripts/kuroshiro/kuroshiro.min.js"></script>
    <script defer src="/website/scripts/kuroshiro/kuroshiro-analyzer-kuromoji.min.js"></script>
    <script defer src="/website/scripts/wanakana/wanakana.min.js"></script>
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  </head>
  <body>
  <div class="container">
    <h1>Hack não Kanji </h1>
    <h3><a href="#" onclick="reloadKanji(event)">Học từ mới</a></h3>
    <div class="question">
        <p>
          Đây là「<strong id="idQuenstion"></strong>」 
          <span class="tooltip-icon" onclick="toggleTooltip(event)">
            <i class="fas fa-question-circle"></i>
            <span class="tooltip" id="idSuggest"></span>
          </span>
          <span class="speaker-icon" onclick="speakAnswer(event)">
            <audio controls id="tts-audio" class="hidden"/>
            <i class="fas fa-volume-up"></i>
          </span>
        </p>
        <input type="text" value="" id="txtAnswer" onkeyup="submitAnswer(event)" placeholder="Vui lòng nhập kết quả Hiragana">
    </div>
    <div class="messageArea info" data-type="info">
      <i class="fas fa-check-circle"></i>
      <span></span>
    </div>
    <div class="messageArea error" data-type="error">
      <i class="fas fa-times-circle"></i>
      <span></span>
    </div>
    <div class="messageArea warn" data-type="warn">
      <i class="fas fa-exclamation-triangle"></i>
      <span></span>
    </div>
  </div>

  <!-- Custom Spinner -->
  <div class="spinner-overlay" id="spinner">
    <div class="spinner">
        <i class="fas fa-spinner fa-spin spinner-icon"></i>
        <div class="loading-text">Loading...</div>
    </div>
  </div>

  <script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbzBECKFNcuxyy9nPu7TK-AzDglyUA_JcR6Y1PDD3McLq5VM4mOPmN6n2-GwBsj-8OB-yQ/exec';
    let historyIndex = 1;
    let kuroshiro;

    document.addEventListener('DOMContentLoaded', async () => {
      kuroshiro = new Kuroshiro();
      try {
        await kuroshiro.init(new KuromojiAnalyzer());
        const input = document.getElementById('txtAnswer');
        wanakana.bind(input);
        onInitData();
      } catch (error) {
        console.error('Error initializing Kuroshiro:', error);
      }
    });

    function onInitData() {
      fetch(API_URL)
        .then(response => response.json())
        .then(data => setData(data))
        .catch(error => hideSpinner());
    }

    async function setData(resp) {
      hideSpinner(); 
      document.getElementById('idQuenstion').textContent = resp.kanji;
      historyIndex = resp.index;
      const kanjiQuestion = resp.kanji.trim();
      const hiraganaTooltip = await convertKanjiToHiragana(kanjiQuestion);
      document.getElementById('idSuggest').textContent = hiraganaTooltip;
      document.querySelector('.container').style.display = 'block';
    }

    function updataData() {
      const postData = {
        'index': historyIndex, 
        'action': 0
      };
      
      showSpinner();

      fetch(API_URL, {
        method: 'POST',
        body: JSON.stringify(postData),
        headers: {
          'Content-Type': 'application/json'
        }
      })
      .then(response => response.json())
      .then(data => setData(data))
      .catch(error => hideSpinner());
    }

    async function convertKanjiToHiragana(kanji) {
      try {
        const hiragana = await kuroshiro.convert(kanji, { to: 'hiragana' });
        return hiragana;
      } catch (error) {
        return '';
      }
    }

    async function submitAnswer(e) {
      hideMessageArea();

      const key = e.keyCode || e.which;
      if (key == 13 || key == 1) {
        const kanjiQuestion = document.getElementById('idQuenstion').textContent.trim();
        const hiraganaAnswer = document.getElementById('txtAnswer').value.trim();
      
        if (hiraganaAnswer !== '') {
          const hiraganaQuestion = await convertKanjiToHiragana(kanjiQuestion);
          if (hiraganaAnswer == hiraganaQuestion) {
            showMessageAreaInfo(`Đúng rồi quá đỉnh!「${kanjiQuestion}」→「${hiraganaAnswer}」`);
            speakAnswer(kanjiQuestion);
            updataData();
          } else {
            const wrapper = highlightIncorrect(hiraganaAnswer, hiraganaQuestion);
            showMessageAreaError(`Tuyệt vời, đúng phải là「${hiraganaAnswer}」→「${wrapper}」`);
            speakAnswer(kanjiQuestion);
          }
        } else {
          showMessageAreaWarn("Vui lòng nhập câu trả lời");
        }
        document.getElementById('txtAnswer').value = '';
      }
    }

    async function reloadKanji(e) {
      const postData = {
        'index': historyIndex, 
        'action': 1
      };

      showSpinner();

      fetch(API_URL, {
        method: 'POST',
        body: JSON.stringify(postData),
        headers: {
          'Content-Type': 'application/json'
        }
      })
      .then(response => response.json())
      .then(data => setData(data))
      .catch(error => hideSpinner());
    }

    function speakAnswer(e) {
      const kanjiQuestion = document.getElementById('idQuenstion').textContent.trim();
      if (kanjiQuestion !== '') {
        if ('speechSynthesis' in window) {
          const utterance = new SpeechSynthesisUtterance(kanjiQuestion);
          utterance.lang = 'ja-JP';
          utterance.onstart = function(event) {
            const audio = new Audio();
            audio.play().catch(error => {});
          };
          window.speechSynthesis.speak(utterance);
        } else {
          playTTS(encodeURIComponent(kanjiQuestion), 'ja-JP');
      }
    }

    const playTTS = (text, lang) => {
      // Get the audio element
      const audioEl = document.getElementById('tts-audio');
      const url= `https://translate.google.com/translate_tts?ie=UTF-8&tl=${lang}&client=tw-ob&q=${text}`;

      // add the sound to the audio element
      audioEl.src = url;
      //For auto playing the sound
      audioEl.play();
    };

    function highlightIncorrect(input, expected) {
      let highlightedText = '';
      let inputIndex = 0;
      let expectedIndex = 0;

      while (expectedIndex < expected.length) {
        if (inputIndex < input.length && input[inputIndex] === expected[expectedIndex]) {
          highlightedText += expected[expectedIndex];
          inputIndex++;
        } else {
          highlightedText += `<span class="highlight-incorrect">${expected[expectedIndex]}</span>`;
          if (inputIndex < input.length) {
            inputIndex++;
          }
        }
        expectedIndex++;
      }

      return highlightedText;
    }

    function showMessageAreaInfo(message) {
      showMessageArea('info', message);
    }

    function showMessageAreaError(message) {
      showMessageArea('error', message);
    }

    function showMessageAreaWarn(message) {
      showMessageArea('warn', message);
    }

    function showMessageArea(type, message) {
      hideMessageArea();
      document.querySelector(`.messageArea.${type} > span`).innerHTML = message;
      document.querySelector(`.messageArea.${type}`).style.display = 'block';
    }

    function hideMessageArea() {
      document.querySelectorAll('.messageArea').forEach(el => el.style.display = 'none');
    }

    function showSpinner() {
      document.querySelector('.spinner-overlay').style.display = 'flex';
    }

    function hideSpinner() {
      document.querySelector('.spinner-overlay').style.display = 'none';
    }

    function toggleTooltip(e) {
      const tooltip = e.currentTarget.querySelector('.tooltip');
      if (tooltip.style.display === 'block') {
        tooltip.style.display = 'none';
      } else {
        tooltip.style.display = 'block';
      }
    }

  </script>
  </body>
</html>