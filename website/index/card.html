<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1" name="viewport" />
  <title>Từ vựng N4 bài 26 | Minna no Nihongo</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
    rel="stylesheet"
  />
  <link
    href="https://fonts.googleapis.com/css2?family=Roboto&family=Roboto+Slab&display=swap"
    rel="stylesheet"
  />
  <style>
    body {
      margin: 0;
      font-family: "Roboto", sans-serif;
      background-color: #67b37a;
    }
    .japanese-kanji {
      font-family: "Roboto Slab", serif;
      font-weight: 500;
    }
    .handwritten {
      font-family: "Comic Sans MS", cursive, sans-serif;
    }
    /* Custom underline for 「KIẾN, CHẨN」 with exact width and color */
    .underline-custom {
      width: 5rem; /* 80px */
      border-bottom: 1px solid #a3c9b3;
      margin-top: 0.25rem;
      align-self: center;
    }
  </style>
</head>
<body class="relative min-h-screen flex justify-center items-center bg-[#67b37a]">
  <div class="relative w-full max-w-[1024px] aspect-[16/9] flex flex-col">
    <!-- Dropdown for lesson selection at top -->
    <div class="flex justify-center mt-4 items-center space-x-4">
      <select id="lesson-select" class="p-2 rounded text-black text-lg">
        <option value="all">Tất cả bài học</option>
      </select>
      <label for="toggle-meaning" class="text-white select-none cursor-pointer flex items-center space-x-1">
        <input type="checkbox" id="toggle-meaning" checked />
        <span>Ẩn nghĩa</span>
      </label>
    </div>
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const toggleMeaningCheckbox = document.getElementById('toggle-meaning');
        const meaningDiv = document.getElementById('meaning');
        toggleMeaningCheckbox.addEventListener('change', () => {
          if (toggleMeaningCheckbox.checked) {
            meaningDiv.style.display = 'none';
          } else {
            meaningDiv.style.display = '';
          }
        });
        // Initialize visibility based on checkbox state
        if (toggleMeaningCheckbox.checked) {
          meaningDiv.style.display = 'none';
        }
      });
    </script>

    <!-- Top left text "「KIẾN, CHẨN」" with underline, aligned left but underline centered under text -->
    <div
      class="absolute top-[5%] left-[3%] text-[#3f1f1f] text-[28px] font-light tracking-wide font-serif flex flex-col items-start select-none"
      style="line-height: 1.2; width: max-content;"
    >
      <div class="relative w-full text-left" id="hanviet-text">
        「KIẾN, CHẨN」
        <div class="underline-custom absolute left-1/2 -translate-x-1/2 bottom-0"></div>
      </div>
    </div>

    <!-- Center big text and small text -->
    <div
      class="flex justify-between items-center px-[5%] pt-[15%] pb-[10%] h-[60%] box-border"
    >
      <div class="flex flex-col justify-center h-full">
        <div class="flex space-x-10 items-center" id="card-content">
          <!-- Dynamic content will be inserted here -->
        </div>
        <div id="meaning" class="mt-16 text-black text-[32px] font-normal font-sans select-none text-center">
          <!-- Meaning text -->
        </div>
      </div>

      <!-- Right side nurse and patient illustration -->
      <div class="w-[220px] h-[220px] flex-shrink-0">
        <img
          alt="Illustration of a nurse in white uniform checking a patient sitting on a chair with IV drip"
          class="object-contain w-full h-full"
          height="220"
          src="https://storage.googleapis.com/a1aa/image/83cd1446-a53a-4785-7a6c-c4515de33bf6.jpg"
          width="220"
          decoding="async"
          loading="lazy"
        />
      </div>
    </div>

    <!-- Navigation buttons -->
    <div class="flex justify-center space-x-10 mb-4">
      <div id="prev-btn" class="nav-button select-none"><</div>
      <div id="next-btn" class="nav-button select-none">></div>
    </div>

    <!-- Bottom text bars -->
    <div class="absolute bottom-[5%] left-0 w-full">
      <div
        class="bg-[#2f3a35cc] text-white text-[24px] font-sans text-center py-2 font-light tracking-wide select-none"
        style="line-height: 1.4"
      >
        お腹が痛いので、診ていただけませんか？
      </div>
      <div
        class="bg-[#c7c9c7] text-black text-[20px] font-sans text-center py-2 font-light tracking-wide select-none"
        style="line-height: 1.4"
      >
        Tôi bị đau bụng, xem giúp tôi có được không?
      </div>
    </div>
  </div>
  <style>
    .nav-button {
      cursor: pointer;
      font-size: 2rem;
      font-weight: bold;
      color: white;
      user-select: none;
      padding: 0 1rem;
      background-color: #3f1f1f88;
      border-radius: 0.5rem;
      transition: background-color 0.3s ease;
    }
    .nav-button:hover {
      background-color: #3f1f1fcc;
    }
  </style>
  <script src="/website/scripts/kuroshiro/kuroshiro.min.js"></script>
  <script src="/website/scripts/kuroshiro/kuroshiro-analyzer-kuromoji.min.js"></script>
  <script>
    let kuroshiro = new Kuroshiro();
    let kuroshiroInitPromise = kuroshiro.init(new KuromojiAnalyzer());
    let data = [];
    let filteredData = [];
    let currentIndex = 0;

    async function loadData() {
      try {
        const response = await fetch('/website/file/jp/n4.json');
        if (!response.ok) {
          throw new Error('Network response was not ok');
        }
        data = await response.json();

        populateLessonDropdown();

        // Initially show all data
        filteredData = data;
        if (filteredData.length > 0) {
          currentIndex = 0;
          await displayCard(currentIndex);
        }
      } catch (error) {
        console.error('Failed to load data:', error);
      }
    }

    function populateLessonDropdown() {
      const lessonSelect = document.getElementById('lesson-select');
      // Extract unique lessons from data
      const lessons = [...new Set(data.map(item => item.Lesson))].filter(Boolean);
      lessons.forEach(lesson => {
        const option = document.createElement('option');
        option.value = lesson;
        option.textContent = lesson;
        lessonSelect.appendChild(option);
      });

      lessonSelect.addEventListener('change', () => {
        filterByLesson(lessonSelect.value);
      });
    }

    function filterByLesson(lesson) {
      if (lesson === 'all') {
        filteredData = data;
      } else {
        filteredData = data.filter(item => item.Lesson === lesson);
      }
      currentIndex = 0;
      displayCard(currentIndex);
    }

    async function displayCard(index) {
      const cardContent = document.getElementById('card-content');
      const meaningDiv = document.getElementById('meaning');
      const hanvietTextDiv = document.getElementById('hanviet-text');
      const entry = filteredData[index];

      if (entry.HanViet) {
        hanvietTextDiv.textContent = `「${entry.HanViet}」`;
      } else {
        hanvietTextDiv.textContent = ''
      }

      let textToConvert = entry.Kanji ? entry.Kanji : entry.HiraKata;
      let convertedText = textToConvert;
      // Play sound for the displayed text
      speakAnswer(textToConvert);

      try {
        await kuroshiroInitPromise;
        convertedText = await kuroshiro.convert(textToConvert, { to: "hiragana", mode: "furigana" });
      } catch (e) {
        console.error("Kuroshiro conversion error:", e);
      }

      cardContent.innerHTML = `
        <div
          class="text-white text-[66px] handwritten leading-none select-none relative"
          style="line-height: 1"
        >
          <div
            class="text-[32px] absolute -top-8 left-6"
            style="line-height: 1"
          >
          </div>
          <div class="japanese-kanji font-bold" id="japanese-kanji">${convertedText}</div>
        </div>
      `;

      // Add click event listener to copy kanji text to clipboard
      const kanjiDiv = document.getElementById('japanese-kanji');
      if (kanjiDiv) {
        kanjiDiv.style.cursor = 'pointer';
        kanjiDiv.title = 'Click to copy Kanji to clipboard';
        kanjiDiv.addEventListener('click', () => {
          const textToCopy = entry.Kanji ? entry.Kanji : entry.HiraKata;
          if (navigator.clipboard) {
            navigator.clipboard.writeText(textToCopy).then(() => {
              console.log('Kanji copied to clipboard:', textToCopy);
            }).catch(err => {
              console.error('Failed to copy Kanji:', err);
            });
          } else {
            // Fallback for older browsers
            const textarea = document.createElement('textarea');
            textarea.value = textToCopy;
            document.body.appendChild(textarea);
            textarea.select();
            try {
              document.execCommand('copy');
              console.log('Kanji copied to clipboard (fallback):', textToCopy);
            } catch (err) {
              console.error('Fallback: Oops, unable to copy', err);
            }
            document.body.removeChild(textarea);
          }
        });
      }

      meaningDiv.textContent = entry.Meaning || '';


    }

    function speakAnswer(speak) {
      if (speak !== '') {
        if ('speechSynthesis' in window) {
          const utterance = new SpeechSynthesisUtterance(speak);
          utterance.lang = 'ja-JP';
          utterance.onstart = function(event) {
            const audio = new Audio();
            audio.play().catch(error => {});
          };
          window.speechSynthesis.speak(utterance);
        } else {
          playTTS(encodeURIComponent(speak), 'ja-JP');
        }
      }
    }

    const playTTS = (text, lang) => {
      // Get the audio element
      let audioEl = document.getElementById('tts-audio');
      if (!audioEl) {
        audioEl = document.createElement('audio');
        audioEl.id = 'tts-audio';
        document.body.appendChild(audioEl);
      }
      const url= `https://translate.google.com/translate_tts?ie=UTF-8&tl=${lang}&client=tw-ob&q=${text}`;

      // add the sound to the audio element
      audioEl.src = url;
      //For auto playing the sound
      audioEl.play();
    }

    document.getElementById('prev-btn').addEventListener('click', () => {
      if (currentIndex > 0) {
        currentIndex--;
        displayCard(currentIndex);
      }
    });

    document.getElementById('next-btn').addEventListener('click', () => {
      if (currentIndex < filteredData.length - 1) {
        currentIndex++;
        displayCard(currentIndex);
      }
    });

    loadData();

    // Add keyboard navigation for next and previous buttons and toggle meaning with 'q'
    document.addEventListener('keydown', (event) => {
      const key = event.key;
      if (key === 'ArrowRight') {
        // Next
        if (currentIndex < filteredData.length - 1) {
          currentIndex++;
          displayCard(currentIndex);
        }
      } else if (key === 'ArrowLeft') {
        // Previous
        if (currentIndex > 0) {
          currentIndex--;
          displayCard(currentIndex);
        }
      } else if (key === 'q' || key === 'Q') {
        // Toggle meaning visibility
        const meaningDiv = document.getElementById('meaning');
        const toggleCheckbox = document.getElementById('toggle-meaning');
        if (meaningDiv.style.display === 'none') {
          meaningDiv.style.display = '';
          toggleCheckbox.checked = false;
        } else {
          meaningDiv.style.display = 'none';
          toggleCheckbox.checked = true;
        }
      }
    });
  </script>
</body>
</html>
