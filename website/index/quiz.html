        <!DOCTYPE html>
        <html lang="vi">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Quiz Tr·∫Øc Nghi·ªám - Udemy Style</title>
            <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
            <style>
                @font-face {
                    font-family: 'UTM Bauhaus';
                    src: url('../css/fonts/UTM-Bauhaus-Light.ttf') format('truetype');
                    font-weight: normal;
                    font-style: normal;
                }
                body, button, input {
                    font-family: 'UTM Bauhaus', sans-serif !important;
                }
                body {
                    background: #f8f9fa;
                    margin: 0;
                    padding: 20px;
                    text-align: center;
                }
                .container {
                    background: white;
                    padding: 20px 20px 45px 20px;
                    border-radius: 10px;
                    box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.1);
                    margin: auto;
                }
                h2 {
                    color: #333;
                    font-weight: 600;
                }
                .settings {
                    text-align: left;
                    margin-bottom: 15px;
                }
                .settings label {
                    font-weight: 600;
                }
                .question {
                    font-size: 18px;
                    font-weight: 600;
                    margin-bottom: 10px;
                    text-align: left;
                }
                .options {
                    text-align: left;
                    padding-left: 10px;
                }
                .options label {
                    display: block;
                    padding: 8px;
                    border-radius: 5px;
                    transition: 0.3s;
                    cursor: pointer;
                }
                .options input {
                    margin-right: 10px;
                }
                .btn {
                    background: #28a745;
                    color: white;
                    border: none;
                    padding: 12px 20px;
                    cursor: pointer;
                    margin-top: 10px;
                    border-radius: 5px;
                    font-weight: 600;
                    transition: 0.3s;
                    font-size: 16px;
                }
                .btn:hover {
                    background: #218838;
                }
                .result {
                    margin-top: 20px;
                    font-size: 18px;
                    font-weight: 600;
                }
                .correct { background: #d4edda; color: #155724; }
                .incorrect { background: #f8d7da; color: #721c24; }
                #submitQuiz {
                    position: fixed;
                    bottom: 20px;
                    right: 20px;
                    z-index: 1000;
                }
                #retest {
                    position: fixed;
                    bottom: 20px;
                    right: 130px;
                    z-index: 1000;
                }
                #resetting {
                    position: fixed;
                    bottom: 20px;
                    left: 20px;
                    z-index: 1000;
                }
            </style>
        </head>
        <body>

        <div class="container">
            <h2>Tr·∫Øc Nghi·ªám Business Analysis</h2>

            <!-- C√†i ƒë·∫∑t Quiz -->
            <div class="settings">
                <label>Ch·ªçn file JSON:</label>
                <select id="jsonFileName"></select>
                <br />

                <label>T·ª´ c√¢u:</label>
                <input type="number" id="startQuestion" value="1" min="1" style="width: 50px;">

                <label>ƒê·∫øn c√¢u:</label>
                <input type="number" id="endQuestion" value="" min="1" style="width: 50px;">
                <br />

                <label>S·ªë c√¢u h·ªèi ng·∫´u nhi√™n:</label>
                <input type="number" id="randomQuestionCount" value="5" min="1" style="width: 50px;">

                <br />
                <label>
                    <input type="radio" name="order" value="ordered" checked> Theo th·ª© t·ª±
                </label>
                <label>
                    <input type="radio" name="order" value="random"> Ng·∫´u nhi√™n
                </label>

                <br />
                <label>
                    <input type="checkbox" id="shuffleAnswers"> Ng·∫´u nhi√™n c√¢u tr·∫£ l·ªùi
                </label>
            </div>

            <button class="btn" id="startQuiz">B·∫Øt ƒë·∫ßu</button>

            <div id="quizContainer" style="display: none;">
                <div id="quiz"></div>
                <button class="btn" id="resetting">Setting</button>
                <button class="btn" id="retest">L√†m l·∫°i</button>
                <button class="btn" id="submitQuiz">N·ªôp b√†i</button>
                <div id="result" class="result"></div>
            </div>
        </div>

        <script>
            let questions = [];  // L∆∞u d·ªØ li·ªáu t·ª´ JSON
            let selectedQuestions = [];
            let allFileNames = [];
            
            $(function() {
                loadOptions();
                restoreSettingsFromLocalStorage();
            });

            // H√†m l∆∞u d·ªØ li·ªáu v√†o localStorage
            function saveSettingsToLocalStorage() {
                localStorage.setItem('quizSettings', JSON.stringify({
                    fileName: $("#jsonFileName").val(),
                    startQuestion: $("#startQuestion").val(),
                    endQuestion: $("#endQuestion").val(),
                    randomQuestionCount: $("#randomQuestionCount").val(),
                    order: $("input[name='order']:checked").val(),
                    shuffleAnswers: $("#shuffleAnswers").is(":checked")
                }));
            }

            // G·∫Øn s·ª± ki·ªán thay ƒë·ªïi ƒë·ªÉ t·ª± ƒë·ªông l∆∞u
            $(document).on("change input", "#jsonFileName, #startQuestion, #endQuestion, #randomQuestionCount, input[name='order'], #shuffleAnswers", saveSettingsToLocalStorage);

            // H√†m kh√¥i ph·ª•c d·ªØ li·ªáu t·ª´ localStorage
            function restoreSettingsFromLocalStorage() {
                const saved = localStorage.getItem('quizSettings');
                if (saved) {
                    const settings = JSON.parse(saved);

                    // Kh√¥i ph·ª•c select sau khi load options
                    setTimeout(() => {
                        $("#jsonFileName").val(settings.fileName);
                    }, 300);

                    $("#startQuestion").val(settings.startQuestion);
                    $("#endQuestion").val(settings.endQuestion);
                    $("#randomQuestionCount").val(settings.randomQuestionCount);
                    $(`input[name='order'][value='${settings.order}']`).prop("checked", true);
                    $("#shuffleAnswers").prop("checked", settings.shuffleAnswers);
                }
            }
        
            // B·∫Øt ƒë·∫ßu quiz
            $("#startQuiz, #retest").click(function () {
                let fileName = $("#jsonFileName").val();
                if (!fileName) {
                    alert("Vui l√≤ng ch·ªçn t√™n file JSON!");
                    return;
                }

                const isAll = fileName === "__ALL__";
                const filesToLoad = isAll ? allFileNames : [fileName];

                // Load t·∫•t c·∫£ c√°c file JSON, r·ªìi g·ªôp l·∫°i
                Promise.all(filesToLoad.map(f => $.getJSON(`../file/quiz/${f}`)))
                    .then(fileDataList => {
                        questions = fileDataList.flat();
                        if (questions.length === 0) {
                            alert("Kh√¥ng c√≥ c√¢u h·ªèi n√†o!");
                            return;
                        }

                        let start = parseInt($("#startQuestion").val());
                        let end = parseInt($("#endQuestion").val()) || questions.length;

                        if (start < 1 || end > questions.length || start > end) {
                            alert(`Vui l√≤ng ch·ªçn kho·∫£ng t·ª´ 1 ƒë·∫øn ${questions.length} v√† ƒë·∫£m b·∫£o 'T·ª´ c√¢u' nh·ªè h∆°n 'ƒê·∫øn c√¢u'.`);
                            return;
                        }

                        let isRandom = $("input[name='order']:checked").val() === "random";
                        selectedQuestions = questions.slice(start - 1, end);

                        if (isRandom) {
                            selectedQuestions = selectedQuestions.sort(() => Math.random() - 0.5);
                            let questionCount = parseInt($("#randomQuestionCount").val() || selectedQuestions.length);
                            selectedQuestions = selectedQuestions.slice(0, questionCount);
                        }

                        renderQuiz();
                        $("#quizContainer").show();
                        $("#result").hide().empty();
                        $('.settings').hide();
                        $('#startQuiz').hide();
                    })
                    .catch((e) => {
                        console.error(e);
                    });
            });

            function renderQuiz() {
                $("#quiz").empty();
                selectedQuestions.forEach((q, index) => {
                    if (!q.options || typeof q.options !== 'object') {
                        console.warn(`C√¢u h·ªèi s·ªë ${index + 1} b·ªã thi·∫øu 'options' ho·∫∑c sai ƒë·ªãnh d·∫°ng.`);
                        return;
                    }

                    let optionsArray = q.options;
                    if ($("#shuffleAnswers").is(":checked")) {
                        optionsArray = Object.entries(q.options);
                        optionsArray.sort(() => Math.random() - 0.5);
                    }

                    let tmpNo = ['A', 'B', 'C', 'D'];
                    let idxNo = -1
                    let optionsHtml = "";
                    $.each(optionsArray, function (tmpKey, tmpValue) {
                        let key = tmpKey;
                        let value = tmpValue;
                        if ($("#shuffleAnswers").is(":checked")) {
                            key = tmpValue[0];
                            value = tmpValue[1];
                        }
                        idxNo++;

                        let isLast = (idxNo === optionsArray.length - 1);
                        optionsHtml += `
                            <div data-index="${index}" style="display: flex; align-items: center; justify-content: space-between;">
                                <label style="flex: 1;">
                                    <input type="radio" name="q${index}" value="${key}">
                                    ${tmpNo[idxNo]}. ${value}
                                </label>
                                ${isLast ? `<button class="btn check-answer" data-index="${index}" style="padding: 6px 12px; font-size: 14px;">Ki·ªÉm tra</button>` : ''}
                            </div>
                        `;
                    });

                    $("#quiz").append(`
                        <div class="question" style="position: relative;">
                            ${index + 1}. ${q.question}
                            <span class="translate-icon" data-index="${index}" title="D·ªãch c√¢u h·ªèi" 
                                style="cursor:pointer; margin-left:10px; font-size:18px; color:#007bff;">üîÑ</span>
                            <span class="chatgpt-icon" data-index="${index}" title="H·ªèi ChatGPT"
                                style="cursor:pointer; margin-left:10px; font-size:18px; color:#28a745;">ü§ñ</span>
                            <div class="translation" style="color: #555; margin-top: 5px; display:none;"></div>
                        </div>
                        <div class="options">${optionsHtml}</div>
                        <hr>
                    `);
                });
            }

            // B·∫Øt s·ª± ki·ªán click icon ChatGPT - copy prompt + m·ªü tab ChatGPT
            $(document).on('click', '.chatgpt-icon', function () {
                const index = $(this).data('index');
                const questionObj = selectedQuestions[index];

                let fullText = `1. D·ªãch v·ª´a c√≥ ti·∫øng anh v√† ti·∫øng vi·ªát\n`
                fullText += `2. Tr√≠ch d·∫´n t·ª´ BABOK V3 ·ªü c√¢u ƒë√∫ng\n`
                fullText += `C√¢u h·ªèi: ${questionObj.question}\n`;

                for (const key in questionObj.options) {
                    fullText += `${key}. ${questionObj.options[key]}\n`;
                }

                fullText += `\nƒê√°p √°n c·ªßa t√¥i l√†: ${questionObj.correct_answer}`;

                // Copy v√†o clipboard
                navigator.clipboard.writeText(fullText)
                    .then(() => {
                        window.open("https://chatgpt.com/?temporary-chat=true", '_blank');
                    })
                    .catch(err => {
                        alert("Kh√¥ng th·ªÉ copy v√†o clipboard. Vui l√≤ng th·ª≠ l·∫°i.");
                        console.error(err);
                    });
            });

            // B·∫Øt s·ª± ki·ªán click icon d·ªãch
            $(document).on('click', '.translate-icon', function () {
                const index = $(this).data('index');
                const questionObj = selectedQuestions[index];

                // N·ªëi c√¢u h·ªèi + t·ª´ng ƒë√°p √°n th√†nh 1 chu·ªói
                let fullText = questionObj.question + '\n';
                for (const key in questionObj.options) {
                    fullText += `${key}. ${questionObj.options[key]}\n`;
                }

                // M√£ h√≥a v√† m·ªü tab m·ªõi Google Translate
                const url = `https://translate.google.com/?sl=en&tl=vi&text=${encodeURIComponent(fullText)}&op=translate`;
                window.open(url, '_blank');
            });

            $(document).on("click", ".check-answer", function () {
                const index = $(this).data("index");
                const selected = $(`input[name='q${index}']:checked`).val();
                const correct = selectedQuestions[index].correct_answer;

                if (!selected) {
                    alert("Vui l√≤ng ch·ªçn m·ªôt ƒë√°p √°n tr∆∞·ªõc khi ki·ªÉm tra!");
                    return;
                }

                $(`input[name='q${index}']`).prop("disabled", true);

                $(`input[name='q${index}'][value='${correct}']`).parent().addClass("correct");
                if (selected !== correct) {
                    $(`input[name='q${index}'][value='${selected}']`).parent().addClass("incorrect");
                }

                $(this).hide();
            });

            $("#submitQuiz").click(function () {
                let score = 0;
                $("#result").empty();

                selectedQuestions.forEach((q, index) => {
                    let userAnswer = $(`input[name='q${index}']:checked`).val();
                    let correctAnswer = q.correct_answer;
                    
                    if (userAnswer === correctAnswer) {
                        score++;
                        $(`input[name='q${index}'][value='${correctAnswer}']`).parent().addClass("correct");
                    } else {
                        $(`input[name='q${index}'][value='${correctAnswer}']`).parent().addClass("correct");
                        if (userAnswer) {
                            $(`input[name='q${index}'][value='${userAnswer}']`).parent().addClass("incorrect");
                        }
                    }
                });

                // Hi·ªán k·∫øt qu·∫£ c≈© khi b·∫Øt ƒë·∫ßu l·∫°i
                $("#result").show();
                $("#result").html(`B·∫°n tr·∫£ l·ªùi ƒë√∫ng ${score}/${selectedQuestions.length} c√¢u.`);
            });

            $("#resetting").click(function () {
                window.scrollTo(0, 0)
                $('.settings').show();
                $('#startQuiz').show();
                $('#quizContainer').hide();
            });

            function loadOptions() {
                let listFileName = `../file/quiz/data-file-name.json`;
                fetch(listFileName)
                    .then(response => {
                        if (!response.ok) throw new Error("Kh√¥ng t√¨m th·∫•y file JSON");
                        return response.json();
                    })
                    .then(data => {
                        const select = document.getElementById('jsonFileName');
                        select.innerHTML = '<option disabled selected>-- Ch·ªçn m·ªôt m·ª•c --</option>';
                        select.innerHTML += '<option value="__ALL__">ALL</option>';
                        allFileNames = data.map(u => u.value);  // L∆∞u danh s√°ch t·∫•t c·∫£ file

                        data.forEach(item => {
                            const option = document.createElement('option');
                            option.value = item.value;
                            option.textContent = item.key;
                            select.appendChild(option);
                        });
                    })
                    .catch(err => {
                        alert("L·ªói khi t·∫£i file JSON: " + err.message);
                    });
            }

        </script>

        </body>
        </html>
