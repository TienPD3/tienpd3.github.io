<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Quiz Tr·∫Øc Nghi·ªám - Udemy Style</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        @font-face {
            font-family: 'UTM Bauhaus';
            src: url('../css/fonts/UTM-Bauhaus-Light.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }
        body, button, input {
            font-family: 'UTM Bauhaus', sans-serif !important;
        }
        body {
            background: #f8f9fa;
            margin: 0;
            padding: 20px;
            text-align: center;
        }
        .container {
            background: white;
            padding: 20px 20px 45px 20px;
            border-radius: 10px;
            box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.1);
            margin: auto;
            max-width: 1024px;
        }
        h2 {
            color: #333;
            font-weight: 600;
        }
        .settings {
            text-align: left;
            margin-bottom: 15px;
        }
        .settings label {
            font-weight: 600;
        }
        .question {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 10px;
            text-align: left;
        }
        .options {
            text-align: left;
            padding-left: 10px;
        }
        .options label {
            display: block;
            padding: 8px;
            border-radius: 5px;
            transition: 0.3s;
            cursor: pointer;
        }
        .options input {
            margin-right: 10px;
        }
        .btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 20px;
            cursor: pointer;
            margin-top: 10px;
            border-radius: 5px;
            font-weight: 600;
            transition: 0.3s;
            font-size: 16px;
        }
        .btn:hover {
            background: #218838;
        }
        .correct { background: #d4edda; color: #155724; }
        .incorrect { background: #f8d7da; color: #721c24; }
        #submitQuiz {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }
        #retest {
            position: fixed;
            bottom: 20px;
            right: 130px;
            z-index: 1000;
        }
        #resetting {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 1000;
        }
        .options label:hover {
            background-color: #e9e9f5;
            color: #155724;
        }

        /* Dropdown v·ªõi checkbox */
        .dropdown-checkbox {
            position: relative;
            display: inline-block;
            width: 100%;
            max-width: 500px;
            user-select: none;
        }
        .dropdown-checkbox button {
            width: 100%;
            padding: 10px;
            text-align: left;
            background: white;
            border: 1px solid #ccc;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
        }
        .dropdown-checkbox button:after {
            content: "‚ñº";
            float: right;
            margin-left: 10px;
            font-size: 12px;
            color: #555;
        }
        .dropdown-content {
            position: absolute;
            background: white;
            border: 1px solid #ccc;
            border-radius: 5px;
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
            z-index: 10000;
            display: none;
            margin-top: 5px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        #fileListCheckboxes {
            padding: 10px;
            /* B·ªè scroll trong v√πng checkbox, ƒë·ªÉ scroll ch·ªâ xu·∫•t hi·ªán ·ªü dropdown-content */
            max-height: none !important;
            overflow-y: visible !important;
        }
        #fileListCheckboxes label {
            display: block;
            cursor: pointer;
            margin-bottom: 5px;
            user-select: none;
        }
        #fileListCheckboxes input[type=checkbox] {
            margin-right: 8px;
            cursor: pointer;
        }
        body {
            padding-top: 40px; /* B·∫±ng ho·∫∑c l·ªõn h∆°n height c·ªßa #quizStatusBar */
        }
        #quizStatusBar {
            position: fixed;
            top: 0;
            right: 0;
            /* B·ªè left:0 ƒë·ªÉ kh√¥ng k√©o full chi·ªÅu ngang */
            background: #007bff;
            color: white;
            padding: 8px 15px;
            font-weight: 600;
            font-size: 16px;
            z-index: 2000;
            display: none;
            border-bottom-left-radius: 10px; /* bo tr√≤n g√≥c tr√°i d∆∞·ªõi */
            max-width: 320px; /* ho·∫∑c width c·ªë ƒë·ªãnh n·∫øu mu·ªën */
            white-space: nowrap; /* kh√¥ng xu·ªëng d√≤ng */
        }
    </style>
</head>
<body>

<div id="quizStatusBar">
    ƒê√£ l√†m 0/0 c√¢u | ƒê√∫ng 0 | Sai 0
</div>

<div class="container">
    <h2>Tr·∫Øc Nghi·ªám Business Analysis</h2>

    <!-- C√†i ƒë·∫∑t Quiz -->
    <div class="settings">
        <div class="dropdown-checkbox" id="dropdownCheckboxWrapper">
            <button type="button" id="dropdownButton" aria-haspopup="true" aria-expanded="false">Ch·ªçn file JSON</button>
            <div class="dropdown-content" id="dropdownContent">
                <div id="fileListCheckboxes">
                    <!-- Checkbox files s·∫Ω load ·ªü ƒë√¢y -->
                </div>
            </div>
        </div>

        <br />

        <label>T·ª´ c√¢u:</label>
        <input type="number" id="startQuestion" value="1" min="1" style="width: 50px;">

        <label>ƒê·∫øn c√¢u:</label>
        <input type="number" id="endQuestion" value="" min="1" style="width: 50px;">
        <br>

        <label>S·ªë c√¢u h·ªèi ng·∫´u nhi√™n:</label>
        <input type="number" id="randomQuestionCount" value="5" min="1" style="width: 50px;">
        <br>

        <label><input type="radio" name="order" value="ordered" checked> Theo th·ª© t·ª±</label>
        <label><input type="radio" name="order" value="random"> Ng·∫´u nhi√™n</label>
        <br>

        <label><input type="checkbox" id="shuffleAnswers"> Ng·∫´u nhi√™n c√¢u tr·∫£ l·ªùi</label>
    </div>

    <button class="btn" id="startQuiz">B·∫Øt ƒë·∫ßu</button>

    <div id="quizContainer" style="display: none;">
        <div id="quiz"></div>
        <button class="btn" id="resetting">Setting</button>
        <button class="btn" id="retest">L√†m l·∫°i</button>
        <button class="btn" id="submitQuiz">N·ªôp b√†i</button>
    </div>
</div>

<script>
    let questions = [];
    let selectedQuestions = [];
    let allFileNames = [];

    $(function() {
        loadOptions();
        restoreSettingsFromLocalStorage();
        setupDropdownEvents();
    });

    function updateQuizStatusBar() {
        let total = selectedQuestions.length;
        let done = 0;    // s·ªë c√¢u ƒë√£ ch·ªçn ƒë√°p √°n
        let correctCount = 0;
        let wrongCount = 0;

        selectedQuestions.forEach((q, index) => {
            let userAnswer = $(`input[name='q${index}']:checked`).val();
            if (userAnswer) {
                done++;
                if (userAnswer === q.correct_answer) {
                    correctCount++;
                } else {
                    wrongCount++;
                }
            }
        });

        $("#quizStatusBar").text(`ƒê√£ l√†m ${done}/${total} c√¢u | ƒê√∫ng ${correctCount} | Sai ${wrongCount}`);

        if (total > 0) {
            $("#quizStatusBar").show();
        } else {
            $("#quizStatusBar").hide();
        }
    }

    function saveSettingsToLocalStorage() {
        localStorage.setItem('quizSettings', JSON.stringify({
            fileNames: $("input[name='jsonFiles']:checked").map(function () { return this.value }).get(),
            startQuestion: $("#startQuestion").val(),
            endQuestion: $("#endQuestion").val(),
            randomQuestionCount: $("#randomQuestionCount").val(),
            order: $("input[name='order']:checked").val(),
            shuffleAnswers: $("#shuffleAnswers").is(":checked")
        }));
    }

    $(document).on("change input", "#startQuestion, #endQuestion, #randomQuestionCount, input[name='order'], #shuffleAnswers", saveSettingsToLocalStorage);

    function restoreSettingsFromLocalStorage() {
        const saved = localStorage.getItem('quizSettings');
        if (saved) {
            const settings = JSON.parse(saved);
            $("#startQuestion").val(settings.startQuestion);
            $("#endQuestion").val(settings.endQuestion);
            $("#randomQuestionCount").val(settings.randomQuestionCount);
            $(`input[name='order'][value='${settings.order}']`).prop("checked", true);
            $("#shuffleAnswers").prop("checked", settings.shuffleAnswers);

            // Sau khi checkbox load xong s·∫Ω set checked theo settings
            setTimeout(() => {
                $("input[name='jsonFiles']").each(function () {
                    if (settings.fileNames.includes(this.value)) {
                        this.checked = true;
                    }
                });
                updateDropdownButtonText();
            }, 500);
        }
    }

    $("#startQuiz, #retest").click(function () {
        let selectedFiles = $("input[name='jsonFiles']:checked").map(function () {
            return this.value;
        }).get();

        if (selectedFiles.length === 0) {
            alert("Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt file JSON!");
            return;
        }

        Promise.all(selectedFiles.map(f => $.getJSON(`../file/quiz/${f}`)))
            .then(fileDataList => {
                questions = fileDataList.flat();
                if (questions.length === 0) {
                    alert("Kh√¥ng c√≥ c√¢u h·ªèi n√†o!");
                    return;
                }

                let start = parseInt($("#startQuestion").val());
                let end = parseInt($("#endQuestion").val()) || questions.length;

                if (start < 1 || end > questions.length || start > end) {
                    alert(`Vui l√≤ng ch·ªçn kho·∫£ng t·ª´ 1 ƒë·∫øn ${questions.length} v√† ƒë·∫£m b·∫£o 'T·ª´ c√¢u' nh·ªè h∆°n 'ƒê·∫øn c√¢u'.`);
                    return;
                }

                let isRandom = $("input[name='order']:checked").val() === "random";
                selectedQuestions = questions.slice(start - 1, end);

                if (isRandom) {
                    selectedQuestions = selectedQuestions.sort(() => Math.random() - 0.5);
                    let questionCount = parseInt($("#randomQuestionCount").val() || selectedQuestions.length);
                    selectedQuestions = selectedQuestions.slice(0, questionCount);
                }

                renderQuiz();
                $("#quizContainer").show();
                $('.settings').hide();
                $('#startQuiz').hide();
            })
            .catch((e) => {
                console.error(e);
                alert("L·ªói khi load file JSON!");
            });
    });

    function renderQuiz() {
        $("#quiz").empty();
        selectedQuestions.forEach((q, index) => {
            let optionsArray = q.options;
            if ($("#shuffleAnswers").is(":checked")) {
                optionsArray = Object.entries(q.options);
                optionsArray.sort(() => Math.random() - 0.5);
            }

            let tmpNo = ['A', 'B', 'C', 'D'];
            let idxNo = -1;
            let optionsHtml = "";
            $.each(optionsArray, function (tmpKey, tmpValue) {
                let key = tmpKey;
                let value = tmpValue;
                if ($("#shuffleAnswers").is(":checked")) {
                    key = tmpValue[0];
                    value = tmpValue[1];
                }
                idxNo++;
                let isLast = (idxNo === optionsArray.length - 1);
                optionsHtml += `
                    <div data-index="${index}" style="display: flex; align-items: center; justify-content: space-between;">
                        <label style="flex: 1;">
                            <input type="radio" name="q${index}" value="${key}">
                            ${tmpNo[idxNo]}. ${value}
                        </label>
                        ${isLast ? `<button class="btn check-answer" data-index="${index}" style="padding: 6px 12px; font-size: 14px;">Ki·ªÉm tra</button>` : ''}
                    </div>
                `;
            });

            $("#quiz").append(`
            <div class="question" style="position: relative;">
                            ${index + 1}. ${q.question}
                            <span class="translate-icon" data-index="${index}" title="D·ªãch c√¢u h·ªèi" 
                                style="cursor:pointer; margin-left:10px; font-size:18px; color:#007bff;">üîÑ</span>
                            <span class="chatgpt-icon" data-index="${index}" title="H·ªèi ChatGPT"
                                style="cursor:pointer; margin-left:10px; font-size:18px; color:#28a745;">ü§ñ</span>
                            <div class="translation" style="color: #555; margin-top: 5px; display:none;"></div>
                        </div>
                <div class="options">${optionsHtml}</div>
                <hr>
            `);
        });
        updateQuizStatusBar();
    }
    // B·∫Øt s·ª± ki·ªán click icon ChatGPT - copy prompt + m·ªü tab ChatGPT
    $(document).on('click', '.chatgpt-icon', function () {
        const index = $(this).data('index');
        const questionObj = selectedQuestions[index];

        let fullText = `1. D·ªãch v·ª´a c√≥ ti·∫øng anh v√† ti·∫øng vi·ªát\n`
        fullText += `2. Tr√≠ch d·∫´n t·ª´ BABOK V3 ·ªü c√¢u ƒë√∫ng\n`
        fullText += `C√¢u h·ªèi: ${questionObj.question}\n`;

        for (const key in questionObj.options) {
            fullText += `${key}. ${questionObj.options[key]}\n`;
        }

        fullText += `\nƒê√°p √°n c·ªßa t√¥i l√†: ${questionObj.correct_answer}`;

        // Copy v√†o clipboard
        navigator.clipboard.writeText(fullText)
            .then(() => {
                window.open("https://chatgpt.com/?temporary-chat=true", '_blank');
            })
            .catch(err => {
                alert("Kh√¥ng th·ªÉ copy v√†o clipboard. Vui l√≤ng th·ª≠ l·∫°i.");
                console.error(err);
            });
    });

    // B·∫Øt s·ª± ki·ªán click icon d·ªãch
    $(document).on('click', '.translate-icon', function () {
        const index = $(this).data('index');
        const questionObj = selectedQuestions[index];

        // N·ªëi c√¢u h·ªèi + t·ª´ng ƒë√°p √°n th√†nh 1 chu·ªói
        let fullText = questionObj.question + '\n';
        for (const key in questionObj.options) {
            fullText += `${key}. ${questionObj.options[key]}\n`;
        }

        // M√£ h√≥a v√† m·ªü tab m·ªõi Google Translate
        const url = `https://translate.google.com/?sl=en&tl=vi&text=${encodeURIComponent(fullText)}&op=translate`;
        window.open(url, '_blank');
    });

    $(document).on("click", ".check-answer", function () {
        const index = $(this).data("index");
        const selected = $(`input[name='q${index}']:checked`).val();
        const correct = selectedQuestions[index].correct_answer;

        if (!selected) {
            alert("Vui l√≤ng ch·ªçn m·ªôt ƒë√°p √°n tr∆∞·ªõc khi ki·ªÉm tra!");
            return;
        }

        $(`input[name='q${index}']`).prop("disabled", true);

        $(`input[name='q${index}'][value='${correct}']`).parent().addClass("correct");
        if (selected !== correct) {
            $(`input[name='q${index}'][value='${selected}']`).parent().addClass("incorrect");
        }

        updateQuizStatusBar();

        $(this).hide();
    });

    $("#submitQuiz").click(function () {
        let score = 0;

        selectedQuestions.forEach((q, index) => {
            let userAnswer = $(`input[name='q${index}']:checked`).val();
            let correctAnswer = q.correct_answer;

            if (userAnswer === correctAnswer) {
                score++;
                $(`input[name='q${index}'][value='${correctAnswer}']`).parent().addClass("correct");
            } else {
                $(`input[name='q${index}'][value='${correctAnswer}']`).parent().addClass("correct");
                if (userAnswer) {
                    $(`input[name='q${index}'][value='${userAnswer}']`).parent().addClass("incorrect");
                }
            }
        });

        updateQuizStatusBar();
    });

    $("#resetting").click(function () {
        window.scrollTo(0, 0);
        $('.settings').show();
        $('#startQuiz').show();
        $('#quizContainer').hide();
    });

    function loadOptions() {
        let listFileName = `../file/quiz/data-file-name.json`;
        fetch(listFileName)
            .then(response => {
                if (!response.ok) throw new Error("Kh√¥ng t√¨m th·∫•y file JSON");
                return response.json();
            })
            .then(data => {
                const container = document.getElementById('fileListCheckboxes');
                container.innerHTML = `
                    <label><input type="checkbox" id="checkAllFiles"><em>Ch·ªçn t·∫•t c·∫£</em></label>
                `;
                allFileNames = data.map(u => u.value);

                data.forEach(item => {
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.name = 'jsonFiles';
                    checkbox.value = item.value;
                    checkbox.id = `chk_${item.value}`;

                    const label = document.createElement('label');
                    label.htmlFor = checkbox.id;
                    label.appendChild(checkbox);
                    label.append(` ${item.key}`);

                    container.appendChild(label);
                });

                // Check All toggle
                document.getElementById('checkAllFiles').addEventListener('change', function () {
                    const checkboxes = document.querySelectorAll("input[name='jsonFiles']");
                    checkboxes.forEach(cb => cb.checked = this.checked);
                    updateDropdownButtonText();
                    saveSettingsToLocalStorage();
                });

                // Khi checkbox thay ƒë·ªïi, c·∫≠p nh·∫≠t n√∫t v√† l∆∞u, v√† ƒë√≥ng dropdown
                document.querySelectorAll("#fileListCheckboxes input[name='jsonFiles']").forEach(cb => {
                    cb.addEventListener('change', function () {
                        updateCheckAllState();
                        updateDropdownButtonText();
                        saveSettingsToLocalStorage();

                        // ƒê√≥ng dropdown khi ch·ªçn checkbox
                        // document.getElementById('dropdownContent').style.display = 'none';
                        // document.getElementById('dropdownButton').setAttribute('aria-expanded', 'false');
                    });
                });

                // C·∫≠p nh·∫≠t tr·∫°ng th√°i checkAll n·∫øu c·∫ßn
                updateCheckAllState();
                updateDropdownButtonText();
            })
            .catch(err => {
                alert("L·ªói khi t·∫£i file JSON: " + err.message);
            });
    }

    function updateCheckAllState() {
        const allCheckboxes = document.querySelectorAll("input[name='jsonFiles']");
        const checkedBoxes = document.querySelectorAll("input[name='jsonFiles']:checked");
        const checkAll = document.getElementById('checkAllFiles');
        if (checkedBoxes.length === allCheckboxes.length) {
            checkAll.checked = true;
            checkAll.indeterminate = false;
        } else if (checkedBoxes.length > 0) {
            checkAll.checked = false;
            checkAll.indeterminate = true;
        } else {
            checkAll.checked = false;
            checkAll.indeterminate = false;
        }
    }

    function updateDropdownButtonText() {
        const checkedBoxes = document.querySelectorAll("input[name='jsonFiles']:checked");
        const button = document.getElementById('dropdownButton');
        if (checkedBoxes.length === 0) {
            button.textContent = 'Ch·ªçn file JSON';
        } else if (checkedBoxes.length === 1) {
            button.textContent = checkedBoxes[0].parentNode.textContent.trim();
        } else {
            button.textContent = `ƒê√£ ch·ªçn ${checkedBoxes.length} file`;
        }
    }

    function setupDropdownEvents() {
        const dropdownButton = document.getElementById('dropdownButton');
        const dropdownContent = document.getElementById('dropdownContent');

        dropdownButton.addEventListener('click', (e) => {
            e.stopPropagation();
            if (dropdownContent.style.display === 'block') {
                dropdownContent.style.display = 'none';
                dropdownButton.setAttribute('aria-expanded', 'false');
            } else {
                dropdownContent.style.display = 'block';
                dropdownButton.setAttribute('aria-expanded', 'true');
            }
        });

        // ƒê√≥ng dropdown n·∫øu click ngo√†i
        document.addEventListener('click', () => {
            dropdownContent.style.display = 'none';
            dropdownButton.setAttribute('aria-expanded', 'false');
        });

        // NgƒÉn kh√¥ng cho dropdown ƒë√≥ng khi click trong n·ªôi dung
        dropdownContent.addEventListener('click', e => {
            e.stopPropagation();
        });
    }
</script>

</body>
</html>
