<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Trang Trắc Nghiệm Bootstrap Mới</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script defer src="/website/scripts/kuroshiro/kuroshiro.min.js"></script>
    <script defer src="/website/scripts/kuroshiro/kuroshiro-analyzer-kuromoji.min.js"></script>
    <style>
        @font-face {
            font-family: 'UTM Bauhaus';
            src: url('../css/fonts/UTM-Bauhaus-Light.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }
        body, button, input {
            font-family: 'UTM Bauhaus', sans-serif !important;
        }
        body.dark-mode {
            background-color: #121212;
            color: #e0e0e0;
        }
        body.dark-mode .card {
            background-color: #1e1e1e;
            color: #e0e0e0;
        }
        #timer {
            font-weight: bold;
            font-size: 1.2rem;
        }
        #toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            min-width: 250px;
            padding: 10px 20px;
            background-color: #000000cc;
            color: white;
            border-radius: 5px;
            display: none;
            z-index: 1050;
        }
    </style>
</head>
<body class="bg-light">

    <div class="container my-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2>Trắc Nghiệm Bootstrap Mới</h2>
        </div>

        <div class="mb-3">
            <label for="lessonSelect" class="form-label">Chọn bài học:</label>
            <select id="lessonSelect" class="form-select" aria-label="Chọn bài học">
                <option value="all" selected>Tất cả</option>
            </select>
        </div>

        <div class="mb-3">
            <label class="form-label">Chọn chế độ học:</label>
            <div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="studyMode" id="modeMeaning" value="meaning" checked>
                    <label class="form-check-label" for="modeMeaning">Học nghĩa</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="studyMode" id="modeKanji" value="kanji">
                    <label class="form-check-label" for="modeKanji">Học Kanji</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="studyMode" id="modeHanViet" value="hanviet">
                    <label class="form-check-label" for="modeHanViet">Học Hán-Việt</label>
                </div>
            </div>
        </div>

        <div id="quizStatus" class="mb-3">
            Câu hỏi <span id="currentQuestionNumber">0</span> / <span id="totalQuestions">0</span>
        </div>

        <div id="timer" class="mb-3 text-end">
            Thời gian còn lại: <span id="timeRemaining">00:00</span>
        </div>

        <div id="quizContainer" class="card p-4 mb-3">
            <!-- All questions will be rendered here -->
        </div>

        <div class="d-flex justify-content-end">
            <button id="submitBtn" class="btn btn-success" disabled>Nộp bài</button>
        </div>

    <div id="result" class="mt-4" style="display:none;">
        <h4>Kết quả</h4>
        <p>Đúng: <span id="correctCount">0</span></p>
        <p>Sai: <span id="wrongCount">0</span></p>
    </div>
</div>

<div id="toast"></div>

<!-- Bootstrap Bundle JS (includes Popper) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
    $(function() {
        let questions = [];
        let filteredQuestions = [];
        let userAnswers = [];
        let timerDuration = 5 * 60; // 5 minutes in seconds
        let timerInterval = null;
        let currentStudyMode = 'meaning';
        let questionsData = [];

        let kuroshiro;
        let kuroshiroInitPromise;

        const $quizContainer = $('#quizContainer');
        const $submitBtn = $('#submitBtn');
        const $timeRemaining = $('#timeRemaining');
        const $result = $('#result');
        const $correctCountElem = $('#correctCount');
        const $wrongCountElem = $('#wrongCount');
        const $toast = $('#toast');
        const $quizStatus = $('#quizStatus');
        const $currentQuestionNumber = $('#currentQuestionNumber');
        const $totalQuestions = $('#totalQuestions');
        const $lessonSelect = $('#lessonSelect');

        function showToast(message) {
            $toast.text(message).fadeIn();
            setTimeout(() => {
                $toast.fadeOut();
            }, 3000);
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        async function wrapWithMeaning(text) {
            await kuroshiroInitPromise;
            return await kuroshiro.convert(text.trim(), { to: 'hiragana', mode: 'furigana' });
        }

        function generateQuestions(data) {

            const meanings = data.map(item => item.Meaning);
            const kanjis = data.map(item => item.Kanji);
            questions = data.map(item => {
                // Prepare answers based on study mode
                let answers, questionText, correctAnswer;

                if (currentStudyMode === 'meaning') {

                    // Question shows Kanji only, answers are meanings
                    let distractors = meanings.filter(m => m !== item.Meaning);
                    shuffleArray(distractors);
                    answers = [item.Meaning].concat(distractors.slice(0, 3));
                    shuffleArray(answers);
                    questionText = `${item.HiraKata}`;
                    if (item.Kanji.trim().length > 0) {
                        questionText = `${item.Kanji} (${item.HanViet})`;
                    }
                    correctAnswer = item.Meaning;
                } else if (currentStudyMode === 'kanji') {
                    // Question shows Kanji, answers are Word
                    let words = data.map(i => i.HiraKata);
                    let distractors = words.filter(w => w !== item.HiraKata);
                    shuffleArray(distractors);
                    answers = [item.HiraKata].concat(distractors.slice(0, 3));
                    shuffleArray(answers);
                    questionText = `${item.Kanji} (${item.HanViet})`;
                    correctAnswer = item.HiraKata;
                } else {
                    // Question shows Kanji, answers are HanViet
                    let words = data.map(i => i.HanViet);
                    let distractors = words.filter(w => w !== item.HanViet && w !== '');
                    shuffleArray(distractors);
                    answers = [item.HanViet].concat(distractors.slice(0, 3));
                    shuffleArray(answers);
                    questionText = `${item.Kanji}`;
                    correctAnswer = item.HanViet;
                }
                return {
                    lesson: item.Lesson,
                    question: questionText,
                    answers: answers,
                    correctAnswer: correctAnswer
                };
            });
            userAnswers = new Array(questions.length).fill(null);
        }

        function filterQuestionsByLesson(lesson) {
            if (lesson === 'all') {
                filteredQuestions = questions;
            } else {
                filteredQuestions = questions.filter(q => q.lesson === lesson);
            }
            userAnswers = new Array(filteredQuestions.length).fill(null);
        }

        async function renderAllQuestions() {
            $quizContainer.empty();
            for (let qIndex = 0; qIndex < filteredQuestions.length; qIndex++) {
                const q = filteredQuestions[qIndex];
                const $questionDiv = $('<div>').addClass('mb-4');
                const wrappedQuestion = await wrapWithMeaning(q.question);
                const $questionText = $('<div>').addClass('mb-2 fs-5').html(`Câu ${qIndex + 1}: ${wrappedQuestion}`);
                $questionDiv.append($questionText);

                const $answersList = $('<div>').addClass('list-group');
                for (let aIndex = 0; aIndex < q.answers.length; aIndex++) {
                    const answer = q.answers[aIndex];
                    const wrappedAnswer = await wrapWithMeaning(answer);
                    const $answerItem = $('<button>')
                        .attr('type', 'button')
                        .addClass('list-group-item list-group-item-action')
                        .html(wrappedAnswer);
                    if (userAnswers[qIndex] === aIndex) {
                        $answerItem.addClass('active');
                    }
                    $answerItem.on('click', function() {
                        userAnswers[qIndex] = aIndex;
                        updateAnswerSelection(qIndex, $answersList);
                        updateSubmitButton();
                    });
                    $answersList.append($answerItem);
                }

                $questionDiv.append($answersList);

                // Add submit button for each question
                const $questionSubmitBtn = $('<button>')
                    .attr('type', 'button')
                    .addClass('btn btn-primary mt-3')
                    .text('Kiểm tra')
                    .prop('disabled', userAnswers[qIndex] === null)
                    .on('click', function() {
                        if (userAnswers[qIndex] === null) {
                            showToast('Vui lòng chọn câu trả lời trước khi kiểm tra.');
                            return;
                        }
                        // Disable submit button after submission
                        $(this).prop('disabled', true);
                        // Disable answer buttons after submission
                        $answersList.children('button').prop('disabled', true).off('click');
                        // Show correct and incorrect answer with icons
                        const $selectedAnswerBtn = $answersList.children('button').eq(userAnswers[qIndex]);
                        if (q.answers[userAnswers[qIndex]] === q.correctAnswer) {
                            $selectedAnswerBtn.addClass('list-group-item-success');
                            $selectedAnswerBtn.prepend('✔ '); // checkmark
                        } else {
                            $selectedAnswerBtn.addClass('list-group-item-danger');
                            $selectedAnswerBtn.prepend('✖ '); // cross before text
                            // Highlight correct answer
                            $answersList.children('button').each(function(idx) {
                                if (q.answers[idx] === q.correctAnswer) {
                                    $(this).addClass('list-group-item-success').prepend('✔ '); // checkmark before text
                                }
                            });
                        }
                    });

                // Enable submit button when an answer is selected
                $answersList.on('click', 'button', function() {
                    if (!$questionSubmitBtn.prop('disabled')) return;
                    $questionSubmitBtn.prop('disabled', false);
                });

                $questionSubmitBtn.addClass('float-end');
                $questionDiv.append($questionSubmitBtn);

                $quizContainer.append($questionDiv);
            }
            $totalQuestions.text(filteredQuestions.length);
            $currentQuestionNumber.text(filteredQuestions.length);
            $quizStatus.hide();
        }

        function updateAnswerSelection(questionIndex, $answersList) {
            $answersList.children('button').each(function(idx) {
                $(this).toggleClass('active', userAnswers[questionIndex] === idx);
            });
        }

        function updateSubmitButton() {
            $submitBtn.prop('disabled', userAnswers.includes(null));
        }

        function showResult() {
            let correct = 0;
            let wrong = 0;
            $.each(userAnswers, function(idx, answerIndex) {
                if (filteredQuestions[idx].answers[answerIndex] === filteredQuestions[idx].correctAnswer) {
                    correct++;
                } else {
                    wrong++;
                }
            });
            $correctCountElem.text(correct);
            $wrongCountElem.text(wrong);
            $result.show();
            showToast('Bài làm đã được nộp!');
        }

        function startTimer() {
            let timeLeft = timerDuration;
            updateTimerDisplay(timeLeft);
            timerInterval = setInterval(() => {
                timeLeft--;
                updateTimerDisplay(timeLeft);
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    showToast('Hết thời gian làm bài!');
                    submitQuiz();
                }
            }, 1000);
        }

        function updateTimerDisplay(seconds) {
            const m = Math.floor(seconds / 60).toString().padStart(2, '0');
            const s = (seconds % 60).toString().padStart(2, '0');
            $timeRemaining.text(`${m}:${s}`);
        }

        function submitQuiz() {
            clearInterval(timerInterval);
            showResult();
            $submitBtn.prop('disabled', true);
        }

        $submitBtn.on('click', () => {
            if (!userAnswers.includes(null)) {
                submitQuiz();
            } else {
                showToast('Vui lòng trả lời hết các câu hỏi trước khi nộp bài.');
            }
        });

        $lessonSelect.on('change', function() {
            const selectedLesson = $(this).val();
            filterQuestionsByLesson(selectedLesson);
            renderAllQuestions();
            updateSubmitButton();
        });

        $('input[name="studyMode"]').on('change', function() {
            currentStudyMode = $(this).val();
            // Regenerate questions based on new study mode
            generateQuestions(questionsData);
            filterQuestionsByLesson($lessonSelect.val());
            renderAllQuestions();
            updateSubmitButton();
        });

        // Load quiz data from JSON file and initialize
        $.getJSON('../file/jp/n4.json', async function(data) {
            questionsData = data;
            kuroshiro = new Kuroshiro();
            kuroshiroInitPromise = kuroshiro.init(new KuromojiAnalyzer());

            generateQuestions(questionsData);

            // Populate lesson select options
            const lessons = [...new Set(data.map(item => item.Lesson))].sort();
            lessons.forEach(lesson => {
                $lessonSelect.append($('<option>').val(lesson).text(`Bài học ${lesson}`));
            });

            currentStudyMode = $('input[name="studyMode"]:checked').val();

            filterQuestionsByLesson('all');
            await renderAllQuestions();
            startTimer();
            updateSubmitButton();
        }).fail(function() {
            showToast('Không thể tải dữ liệu câu hỏi.');
        });
    });
</script>

</body>
</html>
