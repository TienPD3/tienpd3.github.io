<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Trắc nghiệm Kanji</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        .hidden { display: none; }
        #toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            min-width: 250px;
            padding: 10px 20px;
            background-color: #000000cc;
            color: white;
            border-radius: 5px;
            display: none;
            z-index: 1050;
        }
        .list-group-item.correct {
            background-color: #d1e7dd;
            border-color: #a3cfbb;
        }
        .list-group-item.incorrect {
            background-color: #f8d7da;
            border-color: #f5c2c7;
        }
    </style>
</head>
<body>

    <div class="container my-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2>Trắc nghiệm Kanji</h2>
        </div>

        <div class="quizSettings card p-3 mb-4">
            <div class="mb-3">
                <label for="lessonSelect" class="form-label">Chọn bài học:</label>
                <select id="lessonSelect" class="form-select" aria-label="Chọn bài học">
                    <option value="all" selected>Tất cả</option>
                </select>
            </div>
    
            <div class="mb-3 row">
                <div class="col-md-6">
                    <label for="startQuestion" class="form-label">Từ câu:</label>
                    <input type="number" id="startQuestion" value="1" min="1" step="5" class="form-control">
                </div>
                <div class="col-md-6">
                    <label for="endQuestion" class="form-label">Đến câu:</label>
                    <input type="number" id="endQuestion" value="" min="5" step="5" class="form-control">
                </div>
            </div>
    
            <div class="mb-3">
                <button id="startQuizBtn" class="btn btn-primary w-100">Bắt đầu</button>
            </div>
        </div>

        <div id="quizMain" class="hidden">
            <div id="quizContainer" class="card p-4 mb-3">
                <!-- Questions will be rendered here -->
            </div>
        </div>
    </div>

    <div id="toast"></div>

    <!-- Bootstrap Bundle JS (includes Popper) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        let allQuestions = [];
        let filteredQuestions = [];
        let userAnswers = [];

        const $quizContainer = $('#quizContainer');
        const $toast = $('#toast');
        const $lessonSelect = $('#lessonSelect');

        function showToast(message) {
            $toast.text(message).fadeIn();
            setTimeout(() => $toast.fadeOut(), 3000);
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        // This function now directly uses the questions from the JSON file
        function prepareQuestions(data) {
            // Shuffle options for each question to make it more challenging
            data.forEach(q => {
                const correctAnswerText = q.options[q.answer];
                shuffleArray(q.options);
                // Find the new index of the correct answer after shuffling
                q.newAnswerIndex = q.options.indexOf(correctAnswerText);
            });
            return data;
        }

        function renderAllQuestions() {
            $quizContainer.empty();
            filteredQuestions.forEach((q, qIndex) => {
                const $questionDiv = $('<div>').addClass('mb-4');
                const $questionText = $('<div>').addClass('mb-2 fs-5').html(`<b>Câu ${qIndex + 1}:</b> ${q.question}`);
                $questionDiv.append($questionText);

                const $answersList = $('<div>').addClass('list-group');
                q.options.forEach((answer, aIndex) => {
                    const $answerItem = $('<button>')
                        .attr('type', 'button')
                        .addClass('list-group-item list-group-item-action')
                        .html(answer)
                        .on('click', function() {
                            userAnswers[qIndex] = aIndex;
                            $(this).addClass('active').siblings().removeClass('active');
                            $questionDiv.find('.check-btn').prop('disabled', false);
                        });
                    $answersList.append($answerItem);
                });
                $questionDiv.append($answersList);

                const $checkBtn = $('<button>').addClass('btn btn-success mt-3 float-end check-btn').text('Kiểm tra').prop('disabled', true);
                $checkBtn.on('click', function() {
                    $(this).prop('disabled', true);
                    $answersList.children('button').prop('disabled', true).off('click');

                    const isCorrect = userAnswers[qIndex] === q.newAnswerIndex;
                    const correctAnswerText = q.options[q.newAnswerIndex];

                    if (isCorrect) {
                        $answersList.children().eq(userAnswers[qIndex]).addClass('correct').prepend('✔ ');
                        speakAnswer(correctAnswerText);
                    } else {
                        $answersList.children().eq(userAnswers[qIndex]).addClass('incorrect').prepend('✖ ');
                        $answersList.children().eq(q.newAnswerIndex).addClass('correct').prepend('✔ ');
                    }

                    const $explanation = $('<p>').addClass('mt-2 alert alert-info').html(q.explanation);
                    $questionDiv.append($explanation);
                });
                $questionDiv.append($checkBtn);
                $quizContainer.append($questionDiv);
            });
        }

        function speakAnswer(text) {
            if (!text || !('speechSynthesis' in window)) return;
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'ja-JP';
            window.speechSynthesis.speak(utterance);
        }

        function loadAndPrepareData() {
            $.getJSON('../assets/storage/kanji.json')
                .done(data => {
                    allQuestions = data;
                    const lessons = [...new Set(data.map(item => item.lesson))].sort();
                    $lessonSelect.append(lessons.map(lesson => $('<option>').val(lesson).text(lesson)));
                })
                .fail(() => showToast('Không thể tải dữ liệu câu hỏi.'));
        }

        $('#startQuizBtn').on('click', function() {
            const selectedLesson = $lessonSelect.val();

            let baseData = (selectedLesson === 'all') ? allQuestions : allQuestions.filter(q => q.lesson === selectedLesson);
            
            let questionsForQuiz = prepareQuestions(JSON.parse(JSON.stringify(baseData))); // Use a deep copy

            const startQ = parseInt($('#startQuestion').val()) || 1;
            let endQ = parseInt($('#endQuestion').val());
            if (!endQ || endQ > questionsForQuiz.length) {
                endQ = questionsForQuiz.length;
            }
            
            filteredQuestions = questionsForQuiz.slice(startQ - 1, endQ);
            shuffleArray(filteredQuestions);
            userAnswers = new Array(filteredQuestions.length).fill(null);

            renderAllQuestions();
            $('.quizSettings').hide();
            $('#quizMain').removeClass('hidden');
        });

        $(document).ready(function() {
            loadAndPrepareData();
        });
    </script>

</body>
</html>

</body>
</html>