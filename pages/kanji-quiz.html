<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Trắc nghiệm Kanji</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        .hidden { display: none; }
        #toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            min-width: 250px;
            padding: 10px 20px;
            background-color: #000000cc;
            color: white;
            border-radius: 5px;
            display: none;
            z-index: 1050;
        }
        .list-group-item.correct {
            background-color: #d1e7dd;
            border-color: #a3cfbb;
        }
        .list-group-item.incorrect {
            background-color: #f8d7da;
            border-color: #f5c2c7;
        }
        .dropdown-menu {
            max-height: 300px;
            overflow-y: auto;
        }
        .dropdown-menu .form-check {
            padding-left: 3rem; /* Add padding to align checkboxes */
        }
        .dropdown-menu .form-check-input {
            margin-left: -1.5rem;
        }
    </style>
</head>
<body>

    <div class="container my-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2>Trắc nghiệm Kanji</h2>
        </div>

        <div class="quizSettings card p-3 mb-4">
            <div class="mb-3">
                <label class="form-label">Chọn bài học:</label>
                <div class="dropdown">
                    <button class="btn btn-outline-secondary dropdown-toggle w-100" type="button" id="lessonDropdownBtn" data-bs-toggle="dropdown" aria-expanded="false">
                        Tất cả
                    </button>
                    <ul class="dropdown-menu w-100" aria-labelledby="lessonDropdownBtn" id="lessonList">
                        <!-- Lesson checkboxes will be populated here -->
                    </ul>
                </div>
            </div>
    
            <div class="mb-3 row">
                <div class="col-md-6">
                    <label for="startQuestion" class="form-label">Từ câu:</label>
                    <input type="number" id="startQuestion" value="1" min="1" step="5" class="form-control">
                </div>
                <div class="col-md-6">
                    <label for="endQuestion" class="form-label">Đến câu:</label>
                    <input type="number" id="endQuestion" value="" min="5" step="5" class="form-control">
                </div>
            </div>
    
            <div class="mb-3">
                <button id="startQuizBtn" class="btn btn-primary w-100">Bắt đầu</button>
            </div>
        </div>

        <div id="quizMain" class="hidden">
            <div id="quizContainer" class="card p-4 mb-3">
                <!-- Questions will be rendered here -->
            </div>
        </div>
    </div>

    <div id="toast"></div>

    <!-- Bootstrap Bundle JS (includes Popper) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        let allQuestions = [];
        let filteredQuestions = [];
        let userAnswers = [];

        const $quizContainer = $('#quizContainer');
        const $toast = $('#toast');
        const $lessonList = $('#lessonList');

        function showToast(message) {
            $toast.text(message).fadeIn();
            setTimeout(() => $toast.fadeOut(), 3000);
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        // This function now directly uses the questions from the JSON file
        function prepareQuestions(data) {
            // Shuffle options for each question to make it more challenging
            data.forEach(q => {
                const correctAnswerText = q.options[q.answer];
                shuffleArray(q.options);
                // Find the new index of the correct answer after shuffling
                q.newAnswerIndex = q.options.indexOf(correctAnswerText);
            });
            return data;
        }

        function renderAllQuestions() {
            $quizContainer.empty();
            filteredQuestions.forEach((q, qIndex) => {
                const $questionDiv = $('<div>').addClass('mb-4');
                const $questionText = $('<div>').addClass('mb-2 fs-5').html(`<b>Câu ${qIndex + 1}:</b> ${q.question}`);
                $questionDiv.append($questionText);

                const $answersList = $('<div>').addClass('list-group');
                q.options.forEach((answer, aIndex) => {
                    const $answerItem = $('<button>')
                        .attr('type', 'button')
                        .addClass('list-group-item list-group-item-action')
                        .html(answer)
                        .on('click', function() {
                            userAnswers[qIndex] = aIndex;
                            $(this).addClass('active').siblings().removeClass('active');
                            $questionDiv.find('.check-btn').prop('disabled', false);
                        });
                    $answersList.append($answerItem);
                });
                $questionDiv.append($answersList);

                const $checkBtn = $('<button>').addClass('btn btn-success mt-3 float-end check-btn').text('Kiểm tra').prop('disabled', true);
                $checkBtn.on('click', function() {
                    $(this).prop('disabled', true);
                    $answersList.children('button').prop('disabled', true).off('click');

                    const isCorrect = userAnswers[qIndex] === q.newAnswerIndex;
                    const correctAnswerText = q.options[q.newAnswerIndex];

                    if (isCorrect) {
                        $answersList.children().eq(userAnswers[qIndex]).addClass('correct').prepend('✔ ');
                        speakAnswer(correctAnswerText);
                    } else {
                        $answersList.children().eq(userAnswers[qIndex]).addClass('incorrect').prepend('✖ ');
                        $answersList.children().eq(q.newAnswerIndex).addClass('correct').prepend('✔ ');
                    }

                    const $explanation = $('<p>').addClass('mt-2 alert alert-info').html(q.explanation);
                    $questionDiv.append($explanation);
                });
                $questionDiv.append($checkBtn);
                $quizContainer.append($questionDiv);
            });
        }

        function speakAnswer(text) {
            if (!text || !('speechSynthesis' in window)) return;
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'ja-JP';
            window.speechSynthesis.speak(utterance);
        }

        function loadAndPrepareData() {
            $.getJSON('../assets/storage/kanji.json')
                .done(data => {
                    allQuestions = data;
                    const lessons = ['all', ...[...new Set(data.map(item => item.lesson))].sort()];
                    
                    lessons.forEach(lesson => {
                        const $li = $('<li>');
                        const $div = $('<div>').addClass('form-check dropdown-item-text');
                        const $input = $('<input>').addClass('form-check-input').attr({
                            type: 'checkbox',
                            value: lesson,
                            id: `chk-lesson-${lesson}`
                        });
                        if (lesson === 'all') {
                            $input.prop('checked', true);
                        }
                        const $label = $('<label>').addClass('form-check-label').attr('for', `chk-lesson-${lesson}`).text(lesson === 'all' ? 'Tất cả' : lesson);
                        
                        $div.append($input, $label);
                        $li.append($div);
                        $lessonList.append($li);
                    });

                    loadLessonSelection(); // Load saved selections

                    // Prevent dropdown from closing when clicking on an item
                    $lessonList.on('click', function(e) {
                        e.stopPropagation();
                    });

                    // Handle checkbox logic
                    $lessonList.find('input[type="checkbox"]').on('change', function() {
                        const isAllChecked = $('#chk-lesson-all').is(':checked');
                        if ($(this).val() === 'all' && this.checked) {
                            // If 'All' is checked, uncheck others
                            $lessonList.find('input[type="checkbox"]').not(this).prop('checked', false);
                        } else if ($(this).val() !== 'all' && this.checked) {
                            // If another option is checked, uncheck 'All'
                            $('#chk-lesson-all').prop('checked', false);
                        }

                        // If no checkboxes are checked, check 'All'
                        if ($lessonList.find('input:checked').length === 0) {
                            $('#chk-lesson-all').prop('checked', true);
                        }
                        updateDropdownButtonText();
                    });
                })
                .fail(() => showToast('Không thể tải dữ liệu câu hỏi.'));
        }

        $('#startQuizBtn').on('click', function() {
            // Save current selection on start
            saveLessonSelection();

            const selectedLessons = $lessonList.find('input:checked').map(function() { return $(this).val(); }).get();

            if (selectedLessons.length === 0) {
                showToast('Vui lòng chọn ít nhất một bài học.');
                return;
            }

            let baseData = (selectedLessons.includes('all')) ? allQuestions : allQuestions.filter(q => selectedLessons.includes(q.lesson));
            
            let questionsForQuiz = prepareQuestions(JSON.parse(JSON.stringify(baseData))); // Use a deep copy

            const startQ = parseInt($('#startQuestion').val()) || 1;
            let endQ = parseInt($('#endQuestion').val());
            if (!endQ || endQ > questionsForQuiz.length) {
                endQ = questionsForQuiz.length;
            }
            
            filteredQuestions = questionsForQuiz.slice(startQ - 1, endQ);
            shuffleArray(filteredQuestions);
            userAnswers = new Array(filteredQuestions.length).fill(null);

            renderAllQuestions();
            $('.quizSettings').hide();
            $('#quizMain').removeClass('hidden');
        });

        function updateDropdownButtonText() {
            const $checked = $lessonList.find('input:checked');
            const $button = $('#lessonDropdownBtn');
            if ($checked.length === 0) {
                $button.text('Chọn bài học');
            } else if ($checked.length === 1) {
                const val = $checked.val();
                $button.text(val === 'all' ? 'Tất cả' : val);
            } else if ($checked.length > 1) {
                $button.text(`Đã chọn ${$checked.length} bài`);
            } else if ($('#chk-lesson-all').is(':checked')) {
                $button.text('Tất cả');
            }
        }

        function saveLessonSelection() {
            const selectedLessons = $lessonList.find('input:checked').map(function() {
                return $(this).val();
            }).get();
            localStorage.setItem('kanjiQuizSelectedLessons', JSON.stringify(selectedLessons));

            const scrollPosition = $lessonList.scrollTop();
            localStorage.setItem('kanjiQuizDropdownScroll', scrollPosition);
        }

        function loadLessonSelection() {
            const savedLessons = JSON.parse(localStorage.getItem('kanjiQuizSelectedLessons'));
            if (savedLessons && savedLessons.length > 0) {
                $lessonList.find('input[type="checkbox"]').prop('checked', false); // Uncheck all first
                savedLessons.forEach(lesson => {
                    $lessonList.find(`input[value="${lesson}"]`).prop('checked', true);
                });

                if ($lessonList.find('input:checked').length === 0) {
                    $('#chk-lesson-all').prop('checked', true);
                }
            } else {
                $('#chk-lesson-all').prop('checked', true);
            }
            updateDropdownButtonText();
        }

        $(document).ready(function() {
            loadAndPrepareData();

            const dropdownElement = document.getElementById('lessonDropdownBtn');
            dropdownElement.addEventListener('hide.bs.dropdown', function () {
                saveLessonSelection();
            });

            dropdownElement.addEventListener('shown.bs.dropdown', function () {
                const savedScroll = localStorage.getItem('kanjiQuizDropdownScroll');
                if (savedScroll) {
                    $lessonList.scrollTop(savedScroll);
                }
            });
        });
    </script>

</body>
</html>

</body>
</html>