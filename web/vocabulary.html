<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªçc T·ª´ V·ª±ng Ti·∫øng Nh·∫≠t</title>
    <style>
        @font-face {
            font-family: 'UTM Bauhaus';
            src: url('./css/fonts/UTM-Bauhaus-Light.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'UTM Bauhaus', sans-serif !important;
        }

        body {
            font-family: 'UTM Bauhaus', sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: white;
            min-height: 100vh;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #eee;
        }

        .header h1 {
            font-size: 2.5rem;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .lesson-selector {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            padding: 10px;
            margin-bottom: 10px;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);
            position: relative;
            overflow: visible;
        }

        .lesson-selector::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="white" opacity="0.1"/><circle cx="75" cy="75" r="1" fill="white" opacity="0.1"/><circle cx="50" cy="10" r="0.5" fill="white" opacity="0.1"/><circle cx="10" cy="60" r="0.5" fill="white" opacity="0.1"/><circle cx="90" cy="40" r="0.5" fill="white" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
            pointer-events: none;
        }

        .lesson-selector-content {
            position: relative;
            z-index: 1;
        }

        .selector-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .selector-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .selector-title {
            color: white;
            font-size: 18px;
            font-weight: 600;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .select-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            padding: 8px 16px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .select-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
            transform: translateY(-1px);
        }

        .selected-lessons {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 15px;
            margin-top: 15px;
            display: none;
            backdrop-filter: blur(10px);
        }

        .selected-lessons h4 {
            margin: 0 0 12px 0;
            color: white;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .lesson-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .lesson-tag {
            background: rgba(255, 255, 255, 0.9);
            color: #667eea;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .lesson-tag:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .remove-btn {
            background: #ff6b6b;
            border: none;
            color: white;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            cursor: pointer;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            font-weight: bold;
        }

        .remove-btn:hover {
            background: #ff5252;
            transform: scale(1.1);
        }

        .progress-section {
            margin-bottom: 10px;
        }

        .counter {
            text-align: center;
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
        }

        .vocabulary-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9ff 100%);
            border: 2px solid #e3f2fd;
            border-radius: 20px;
            padding: 10px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.1), 0 4px 15px rgba(0, 0, 0, 0.05);
            min-height: 400px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
            overflow: hidden;
        }

        .vocabulary-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2, #f093fb);
            border-radius: 20px 20px 0 0;
        }

        .vocabulary-card::after {
            content: '';
            position: absolute;
            top: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: radial-gradient(circle, rgba(102, 126, 234, 0.1) 0%, transparent 70%);
            border-radius: 50%;
            pointer-events: none;
        }

        .lesson-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            display: inline-block;
            margin-bottom: 25px;
            font-weight: 600;
            min-height: 36px;
            line-height: 20px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .lesson-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 25px;
            gap: 15px;
        }

        .lesson-header .nav-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            min-width: 80px;
            height: 36px;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .lesson-header .nav-btn:hover:not(:disabled) {
            background: #2980b9;
            transform: translateY(-1px);
        }

        .lesson-header .nav-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
        }

        .lesson-header .audio-controls {
            flex-shrink: 0;
            margin: 0;
            min-height: auto;
            flex-direction: row;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 56px;
        }

        .lesson-header .audio-controls .audio-btn,
        .lesson-header .audio-controls .tts-btn {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            display: inline-block;
            margin-bottom: 0;
            font-weight: 600;
            min-height: 36px;
            line-height: 20px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border: none;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .lesson-header .audio-controls .audio-btn:hover,
        .lesson-header .audio-controls .tts-btn:hover {
            background: linear-gradient(135deg, #229954 0%, #27ae60 100%);
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(39, 174, 96, 0.4);
        }

        .lesson-header .lesson-info {
            margin-bottom: 0;
            flex: 1;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 40px;
        }

        .lesson-header .show-answer-controls {
            flex-shrink: 0;
            margin: 0;
            min-height: auto;
            flex-direction: row;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 40px;
        }

        .lesson-header .show-answer-controls .show-answer-btn {
            margin: 0;
            padding: 10px 20px;
            font-size: 12px;
            white-space: nowrap;
            min-width: 120px;
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
            border-radius: 25px;
            display: inline-block;
            font-weight: 600;
            min-height: 36px;
            line-height: 20px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .lesson-header .show-answer-controls .show-answer-btn:hover {
            background: linear-gradient(135deg, #229954 0%, #27ae60 100%);
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(39, 174, 96, 0.4);
        }

        .word {
            font-size: 2.4rem;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 20px;
            min-height: 72px;
            line-height: 1.2;
            display: flex;
            align-items: center;
            justify-content: center;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            background: rgba(102, 126, 234, 0.05);
            padding: 8px 16px;
            border-radius: 15px;
            border: 1px solid rgba(102, 126, 234, 0.1);
            position: relative;
            overflow: hidden;
        }

        .word-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            cursor: crosshair;
            pointer-events: auto;
            z-index: 10;
        }

        .kanji-canvas,
        .meaning-canvas,
        .origin-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            cursor: crosshair;
            pointer-events: auto;
            z-index: 10;
        }

        .word-drawing-toggle {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(102, 126, 234, 0.8);
            color: white;
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 20;
            transition: all 0.3s ease;
        }

        .kanji-drawing-toggle,
        .meaning-drawing-toggle,
        .origin-drawing-toggle {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(102, 126, 234, 0.8);
            color: white;
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 20;
            transition: all 0.3s ease;
        }

        .word-drawing-toggle:hover {
            background: rgba(102, 126, 234, 1);
            transform: scale(1.1);
        }

        .kanji-drawing-toggle:hover,
        .meaning-drawing-toggle:hover,
        .origin-drawing-toggle:hover {
            background: rgba(102, 126, 234, 1);
            transform: scale(1.1);
        }

        .word-drawing-toggle.active {
            background: rgba(240, 147, 251, 0.8);
        }

        .kanji-drawing-toggle.active,
        .meaning-drawing-toggle.active,
        .origin-drawing-toggle.active {
            background: rgba(240, 147, 251, 0.8);
        }

        /* Study Mode Styles */
        .study-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .study-dropdown {
            position: relative;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            padding: 8px 16px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            min-width: 180px;
            user-select: none;
            z-index: 99999;
        }

        .study-dropdown:hover {
            background-color: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
            transform: translateY(-1px);
        }

        .study-dropdown.active {
            border-color: rgba(255, 255, 255, 0.8);
            background-color: rgba(255, 255, 255, 0.25);
        }

        .study-dropdown-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .study-dropdown-text {
            flex: 1;
        }

        .study-dropdown-arrow {
            width: 20px;
            height: 20px;
            transition: transform 0.3s ease;
        }

        .study-dropdown.active .study-dropdown-arrow {
            transform: rotate(180deg);
        }

        .study-dropdown-options {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid rgba(102, 126, 234, 0.3);
            border-radius: 15px;
            margin-top: 5px;
            padding: 10px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            backdrop-filter: blur(10px);
            z-index: 99999 !important;
            display: none;
            max-height: 200px;
            overflow-y: auto;
            pointer-events: auto;
        }

        .study-dropdown.active .study-dropdown-options {
            display: block !important;
        }

        .study-option {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 8px;
            transition: background-color 0.2s ease;
            color: #333;
            font-size: 14px;
        }

        .study-option:hover {
            background-color: rgba(102, 126, 234, 0.1);
        }

        .study-option input[type="checkbox"] {
            margin-right: 10px;
            width: 16px;
            height: 16px;
            accent-color: #667eea;
        }

        .study-option.selected {
            background-color: rgba(102, 126, 234, 0.15);
            font-weight: 500;
        }

        .hidden-text {
            color: transparent !important;      /* M√†u trong su·ªët */
            opacity: 0 !important;              /* Ho√†n to√†n trong su·ªët */
            visibility: hidden !important;      /* ·∫®n kh·ªèi viewport */
            user-select: none;                  /* Kh√¥ng th·ªÉ select */
            position: relative;                 /* Position context */
            display: inline-block;              /* Display type */
        }

        .hidden-text::after {
            position: absolute;
            top: 0;
            left: 0;
            color: #ccc;
            font-size: inherit;
            font-weight: inherit;
            pointer-events: none;
        }

        .show-answer-btn {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            display: inline-block;
        }

        .show-answer-btn:hover {
            background: linear-gradient(135deg, #229954 0%, #27ae60 100%);
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(39, 174, 96, 0.4);
        }

        .study-mode-active .word,
        .study-mode-active .kanji,
        .study-mode-active .meaning,
        .study-mode-active .vietnamese-origin {
            position: relative;
        }

        .study-mode-active .hidden-text {
            color: transparent !important;
        }

        .study-mode-active .hidden-text::after {
            position: absolute;
            top: 0;
            left: 0;
            color: #ccc;
            font-size: inherit;
            font-weight: inherit;
        }

        .kanji {
            font-size: 2rem;
            color: #667eea;
            margin-bottom: 20px;
            min-height: 48px;
            line-height: 1.2;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            position: relative;
            overflow: hidden;
            background: rgba(102, 126, 234, 0.05);
            padding: 8px 16px;
            border-radius: 15px;
            border: 1px solid rgba(102, 126, 234, 0.1);
        }

        .meaning {
            font-size: 1.5rem;
            color: #34495e;
            margin-bottom: 20px;
            font-weight: 500;
            min-height: 58px;
            line-height: 1.2;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
            background: rgba(102, 126, 234, 0.05);
            padding: 8px 16px;
            border-radius: 15px;
            border: 1px solid rgba(102, 126, 234, 0.1);
        }

        .vietnamese-origin {
            font-size: 1rem;
            color: #7f8c8d;
            font-style: italic;
            margin-bottom: 30px;
            min-height: 24px;
            line-height: 1.2;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
            background: rgba(102, 126, 234, 0.05);
            padding: 8px 16px;
            border-radius: 15px;
            border: 1px solid rgba(102, 126, 234, 0.1);
        }

        .audio-btn {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            display: inline-block;
            margin-bottom: 25px;
            font-weight: 600;
            min-height: 36px;
            line-height: 20px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .audio-btn:hover {
            background: linear-gradient(135deg, #229954 0%, #27ae60 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(39, 174, 96, 0.4);
        }

        .audio-btn:disabled {
            background: linear-gradient(135deg, #bdc3c7 0%, #95a5a6 100%);
            cursor: not-allowed;
            transform: none;
            box-shadow: 0 4px 15px rgba(189, 195, 199, 0.3);
        }

        .audio-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 48px;
            flex-direction: column;
            gap: 15px;
        }

        .show-answer-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 48px;
            flex-direction: column;
            gap: 15px;
        }

        .show-answer-btn {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            display: inline-block;
            margin-bottom: 25px;
            font-weight: 600;
            min-height: 36px;
            line-height: 20px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .tts-btn {
            background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            min-height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 6px 20px rgba(155, 89, 182, 0.3);
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .tts-btn:hover {
            background: linear-gradient(135deg, #8e44ad 0%, #7d3c98 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(155, 89, 182, 0.4);
        }

        .tts-btn:disabled {
            background: linear-gradient(135deg, #bdc3c7 0%, #95a5a6 100%);
            cursor: not-allowed;
            transform: none;
            box-shadow: 0 4px 15px rgba(189, 195, 199, 0.3);
        }

        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
        }

        .nav-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            min-width: 100px;
        }

        .nav-btn:hover:not(:disabled) {
            background: #2980b9;
        }

        .nav-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }

        .empty-state {
            text-align: center;
            color: #7f8c8d;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
        }

        .empty-state h3 {
            font-size: 1.5rem;
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .loading {
            text-align: center;
            color: #7f8c8d;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
        }

        .spinner {
            border: 4px solid #ecf0f1;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 20px;
            border-radius: 6px;
            border: 1px solid #f5c6cb;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #2c3e50;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #333;
        }

        .select-all-section {
            margin-bottom: 20px;
            padding: 15px;
            background: #ecf0f1;
            border-radius: 6px;
        }

        .select-all-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin: 0 5px;
        }

        .select-all-btn:hover {
            background: #2980b9;
        }

        .lesson-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .lesson-checkbox {
            display: none;
        }

        .lesson-label {
            display: block;
            padding: 10px;
            background: #ecf0f1;
            border: 2px solid #bdc3c7;
            border-radius: 6px;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            color: #2c3e50;
        }

        .lesson-label:hover {
            background: #d5dbdb;
        }

        .lesson-checkbox:checked + .lesson-label {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }

        .modal-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
        }

        .modal-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }

        .modal-btn.primary {
            background: #3498db;
            color: white;
        }

        .modal-btn.primary:hover {
            background: #2980b9;
        }

        .modal-btn.secondary {
            background: #95a5a6;
            color: white;
        }

        .modal-btn.secondary:hover {
            background: #7f8c8d;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
                margin: 0;
                box-shadow: none;
            }

            .header h1 {
                font-size: 2rem;
            }

            .lesson-header {
                flex-direction: column;
                gap: 15px;
                align-items: stretch;
            }

            .lesson-header .nav-btn {
                height: 36px;
                min-width: 100px;
                flex: 1;
                max-width: 150px;
                align-self: center;
            }

            .lesson-header .audio-controls {
                justify-content: center;
                height: auto;
                min-height: 56px;
                margin-bottom: 0;
            }

            .lesson-header .lesson-info {
                text-align: center;
                height: auto;
                min-height: 56px;
                margin-bottom: 0;
            }

            .lesson-header .show-answer-controls {
                justify-content: center;
                height: auto;
                min-height: 56px;
                margin-bottom: 0;
            }

            .lesson-header .audio-controls .audio-btn,
            .lesson-header .audio-controls .tts-btn,
            .lesson-header .show-answer-controls .show-answer-btn {
                height: 40px;
                width: 100%;
                max-width: 200px;
            }

            .word {
                font-size: 2.5rem;
            }

            .kanji {
                font-size: 1.5rem;
            }

            .meaning {
                font-size: 1.25rem;
            }

            .controls {
                flex-direction: column;
                gap: 15px;
            }

            .nav-btn {
                width: 100%;
            }

            .modal-content {
                margin: 10% auto;
                padding: 20px;
                width: 95%;
            }

            .lesson-grid {
                grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
                gap: 8px;
            }

            .lesson-label {
                padding: 8px;
                font-size: 14px;
            }
        }

        @media (max-width: 480px) {
            .vocabulary-card {
                padding: 20px;
            }

            .word {
                font-size: 2rem;
            }

            .kanji {
                font-size: 1.25rem;
            }

            .meaning {
                font-size: 1.125rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="lesson-selector">
            <div class="lesson-selector-content">
                <div class="selector-header">
                    <h2 class="selector-title">üìö Qu·∫£n l√Ω b√†i h·ªçc</h2>
                    <div class="selector-controls">
                        <div class="study-dropdown" id="selStudyMode">
                            <div class="study-dropdown-header">
                                <div class="study-dropdown-text">üìö Hi·ªán t·∫•t c·∫£</div>
                                <svg class="study-dropdown-arrow" fill="white" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M7 10l5 5 5-5z"/>
                                </svg>
                            </div>
                            <div class="study-dropdown-options">
                                <div class="study-option" data-value="all">
                                    <input type="checkbox" id="chkAll" checked>
                                    <label for="chkAll">üìö Hi·ªán t·∫•t c·∫£</label>
                                </div>
                                <div class="study-option" data-value="word">
                                    <input type="checkbox" id="chkWord">
                                    <label for="chkWord">·∫®n t·ª´ v·ª±ng</label>
                                </div>
                                <div class="study-option" data-value="kanji">
                                    <input type="checkbox" id="chkKanji">
                                    <label for="chkKanji">·∫®n kanji</label>
                                </div>
                                <div class="study-option" data-value="meaning">
                                    <input type="checkbox" id="chkMeaning">
                                    <label for="chkMeaning">·∫®n nghƒ©a</label>
                                </div>
                                <div class="study-option" data-value="origin">
                                    <input type="checkbox" id="chkOrigin">
                                    <label for="chkOrigin">·∫®n g·ªëc Vi·ªát</label>
                                </div>
                            </div>
                        </div>
                        <button class="select-btn" id="btnSelectLesson">
                            Ch·ªçn b√†i h·ªçc
                        </button>
                    </div>
                </div>
                <div class="selected-lessons" id="divSelectedLessons">
                    <h4>‚úÖ B√†i h·ªçc ƒë√£ ch·ªçn</h4>
                    <div class="lesson-tags" id="divLessonTags"></div>
                </div>
            </div>
        </div>

        <div class="progress-section">
            <div class="counter" id="spnCounter">0 / 0</div>
        </div>

        <div id="divContent">
            <div class="loading">
                <div class="spinner"></div>
                <p>ƒêang t·∫£i d·ªØ li·ªáu...</p>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div id="mdlLessonSelector" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">üìñ Ch·ªçn B√†i H·ªçc</div>
                <span class="close" id="btnCloseModal">&times;</span>
            </div>
            
            <div class="select-all-section">
                <button class="select-all-btn" id="btnSelectAll">Ch·ªçn t·∫•t c·∫£</button>
                <button class="select-all-btn" id="btnDeselectAll">B·ªè ch·ªçn t·∫•t c·∫£</button>
                <button class="select-all-btn" id="btnSelectRange">Ch·ªçn kho·∫£ng</button>
            </div>

            <div class="lesson-grid" id="grdLessons">
                <!-- Lesson checkboxes will be generated here -->
            </div>

            <div class="modal-actions">
                <button class="modal-btn secondary" id="btnCancel">H·ªßy</button>
                <button class="modal-btn primary" id="btnApply">√Åp d·ª•ng</button>
            </div>
        </div>
    </div>

    <script>
        // Performance optimizations
        let arrVocabularyData = [];
        let arrFilteredData = [];
        let numCurrentIndex = 0;
        let elAudioElement = null;
        let objSelectedLessons = new Set();
        let objAllLessons = new Set();
        let blnRandomMode = false; // Th√™m flag cho random mode
        
        // Word drawing variables
        let blnWordDrawingMode = false;
        let objWordCanvas = null;
        let objWordContext = null;
        let blnIsWordDrawing = false;
        let arrWordLastPoint = null;
        let blnIsIPad = false; // Flag to detect iPad
        
        // Canvas variables for other elements
        let blnKanjiDrawingMode = false;
        let objKanjiCanvas = null;
        let objKanjiContext = null;
        let blnIsKanjiDrawing = false;
        let arrKanjiLastPoint = null;
        
        let blnMeaningDrawingMode = false;
        let objMeaningCanvas = null;
        let objMeaningContext = null;
        let blnIsMeaningDrawing = false;
        let arrMeaningLastPoint = null;
        
        let blnOriginDrawingMode = false;
        let objOriginCanvas = null;
        let objOriginContext = null;
        let blnIsOriginDrawing = false;
        let arrOriginLastPoint = null;
        
        // Study mode variables
        let strCurrentStudyMode = '';
        let objHiddenElements = new Set();
        let objSelectedStudyOptions = new Set(['all']); // Track selected options
        let blnStudyModeInitialized = false; // Flag to prevent duplicate event listeners
        let objStudyModeObserver = null; // MutationObserver for study mode
        
        // Cache DOM elements
        const objDOMCache = {
            divContent: null,
            spnCounter: null,
            divSelectedLessons: null,
            divLessonTags: null,
            mdlLessonSelector: null,
            grdLessons: null
        };

        // Function random t√°ch ri√™ng ƒë·ªÉ s·ª≠ d·ª•ng chung
        function fnRandomizeVocabulary() {
            if (arrFilteredData.length <= 1) return;
            
            // Fisher-Yates shuffle algorithm
            for (let i = arrFilteredData.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arrFilteredData[i], arrFilteredData[j]] = [arrFilteredData[j], arrFilteredData[i]];
            }
            
            numCurrentIndex = 0;
            blnRandomMode = true;
        }

        // Function ƒë·ªÉ reset v·ªÅ th·ª© t·ª± ban ƒë·∫ßu
        function fnResetToOriginalOrder() {
            if (!blnRandomMode) return;
            
            // L·ªçc l·∫°i d·ªØ li·ªáu theo th·ª© t·ª± ban ƒë·∫ßu
            arrFilteredData = arrVocabularyData.filter(item => objSelectedLessons.has(item.lesson));
            numCurrentIndex = 0;
            blnRandomMode = false;
        }

        // Function ƒë·ªÉ ph√°t hi·ªán iPad
        function fnDetectIPad() {
            const strUserAgent = navigator.userAgent.toLowerCase();
            const strPlatform = navigator.platform.toLowerCase();
            
            // Ki·ªÉm tra c√°c d·∫•u hi·ªáu c·ªßa iPad
            blnIsIPad = (
                strUserAgent.includes('ipad') ||
                (strUserAgent.includes('macintosh') && 'ontouchend' in document) ||
                (strPlatform === 'macintel' && navigator.maxTouchPoints > 1) ||
                (strUserAgent.includes('safari') && !strUserAgent.includes('chrome') && 'ontouchend' in document && navigator.maxTouchPoints > 1)
            );
            
            console.log('iPad detected:', blnIsIPad);
            return blnIsIPad;
        }

        // Debounce function
        function fnDebounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Throttle function
        function fnThrottle(func, limit) {
            let inThrottle;
            return function() {
                const args = arguments;
                const context = this;
                if (!inThrottle) {
                    func.apply(context, args);
                    inThrottle = true;
                    setTimeout(() => inThrottle = false, limit);
                }
            }
        }

        // Cache DOM elements
        function fnCacheDOMElements() {
            objDOMCache.divContent = document.getElementById('divContent');
            objDOMCache.spnCounter = document.getElementById('spnCounter');
            objDOMCache.divSelectedLessons = document.getElementById('divSelectedLessons');
            objDOMCache.divLessonTags = document.getElementById('divLessonTags');
            objDOMCache.mdlLessonSelector = document.getElementById('mdlLessonSelector');
            objDOMCache.grdLessons = document.getElementById('grdLessons');
        }

        // Save selected lessons
        const fnSaveSelectedLessonsDebounced = fnDebounce(function() {
            localStorage.setItem('selectedLessons', JSON.stringify(Array.from(objSelectedLessons)));
        }, 300);

        function fnSaveSelectedLessons() {
            fnSaveSelectedLessonsDebounced();
        }

        // Load selected lessons
        function fnLoadSelectedLessons() {
            const strSaved = localStorage.getItem('selectedLessons');
            if (strSaved) {
                return new Set(JSON.parse(strSaved));
            }
            return new Set(objAllLessons);
        }

        // Save study mode state
        function fnSaveStudyModeState() {
            localStorage.setItem('studyModeState', JSON.stringify(Array.from(objSelectedStudyOptions)));
        }

        // Load study mode state
        function fnLoadStudyModeState() {
            const strSaved = localStorage.getItem('studyModeState');
            if (strSaved) {
                return new Set(JSON.parse(strSaved));
            }
            return new Set(['all']);
        }

        // Load vocabulary data
        async function fnLoadVocabularyData() {
            try {
                // Ph√°t hi·ªán iPad tr∆∞·ªõc khi load d·ªØ li·ªáu
                fnDetectIPad();
                
                const resResponse = await fetch('storage/japan/vocabulary.json');
                if (!resResponse.ok) {
                    throw new Error('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu');
                }
                arrVocabularyData = await resResponse.json();
                
                // Get all lessons
                arrVocabularyData.forEach(item => {
                    objAllLessons.add(item.lesson);
                });
                
                // Cache DOM elements
                fnCacheDOMElements();
                
                // Setup MutationObserver for study mode
                // fnSetupStudyModeObserver();
                
                // Create lesson modal
                fnCreateLessonModal();
                
                // Load selected lessons
                objSelectedLessons = fnLoadSelectedLessons();
                fnUpdateFilteredData();
                fnUpdateDisplay();
                fnUpdateCounter();
                fnEnableButtons();
                fnUpdateSelectedLessonsDisplay();
                fnSaveSelectedLessons();
                
                // Load study mode state
                objSelectedStudyOptions = fnLoadStudyModeState();
            } catch (err) {
                console.error('L·ªói khi t·∫£i d·ªØ li·ªáu:', err);
                objDOMCache.divContent.innerHTML = `
                    <div class="error">
                        <h3>‚ùå L·ªói t·∫£i d·ªØ li·ªáu</h3>
                        <p>Kh√¥ng th·ªÉ t·∫£i file vocabulary.json. Vui l√≤ng ki·ªÉm tra ƒë∆∞·ªùng d·∫´n file.</p>
                        <p>Chi ti·∫øt l·ªói: ${err.message}</p>
                    </div>
                `;
            }
        }

        // Create lesson modal
        function fnCreateLessonModal() {
            const elLessonGrid = objDOMCache.grdLessons;
            const arrSortedLessons = Array.from(objAllLessons).sort((a, b) => parseInt(a) - parseInt(b));
            
            const fragment = document.createDocumentFragment();
            
            arrSortedLessons.forEach(lesson => {
                const elDiv = document.createElement('div');
                elDiv.innerHTML = `
                    <input type="checkbox" id="chkLesson-${lesson}" class="lesson-checkbox" value="${lesson}">
                    <label for="chkLesson-${lesson}" class="lesson-label">${lesson}</label>
                `;
                fragment.appendChild(elDiv);
            });
            
            elLessonGrid.innerHTML = '';
            elLessonGrid.appendChild(fragment);
        }

        // Update filtered data
        function fnUpdateFilteredData() {
            arrFilteredData = arrVocabularyData.filter(item => objSelectedLessons.has(item.lesson));
            numCurrentIndex = 0;
            blnRandomMode = false; // Reset random mode khi thay ƒë·ªïi b√†i h·ªçc
        }

        // Update selected lessons display
        function fnUpdateSelectedLessonsDisplay() {
            const elSelectedLessonsDiv = objDOMCache.divSelectedLessons;
            const elLessonTagsDiv = objDOMCache.divLessonTags;
            
            if (objSelectedLessons.size === 0) {
                elSelectedLessonsDiv.style.display = 'none';
                return;
            }
            
            elSelectedLessonsDiv.style.display = 'block';
            const arrSortedLessons = Array.from(objSelectedLessons).sort((a, b) => parseInt(a) - parseInt(b));
            
            const fragment = document.createDocumentFragment();
            arrSortedLessons.forEach(lesson => {
                const elTag = document.createElement('div');
                elTag.className = 'lesson-tag';
                elTag.innerHTML = `
                    B√†i ${lesson}
                    <button class="remove-btn" data-lesson="${lesson}">√ó</button>
                `;
                fragment.appendChild(elTag);
            });
            
            elLessonTagsDiv.innerHTML = '';
            elLessonTagsDiv.appendChild(fragment);
            
            // Add event listeners for remove buttons
            elLessonTagsDiv.addEventListener('click', function(evt) {
                if (evt.target.classList.contains('remove-btn')) {
                    const lesson = evt.target.dataset.lesson;
                    fnRemoveLesson(lesson);
                }
            });
        }

        // Remove lesson
        function fnRemoveLesson(lesson) {
            objSelectedLessons.delete(lesson);
            fnUpdateFilteredData();
            fnUpdateDisplay();
            fnUpdateCounter();
            fnEnableButtons();
            fnUpdateSelectedLessonsDisplay();
            fnSaveSelectedLessons();
        }

        // Update display
        function fnUpdateDisplay() {
            if (arrFilteredData.length === 0) {
                objDOMCache.divContent.innerHTML = `
                    <div class="vocabulary-card">
                        <div class="empty-state">
                            <h3>üìö Kh√¥ng c√≥ t·ª´ v·ª±ng n√†o</h3>
                            <p>Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt b√†i h·ªçc ƒë·ªÉ b·∫Øt ƒë·∫ßu h·ªçc.</p>
                        </div>
                    </div>
                `;
                return;
            }

            const objCurrentWord = arrFilteredData[numCurrentIndex];

            let elSpanClassWord = "";
            let elSpanClassKanji = "";
            let elSpanClassMeaning = "";
            let elSpanClassOrigin = "";

            // Apply selected options
            objSelectedStudyOptions.forEach(option => {
                if (option === 'word') {
                    elSpanClassWord = "hidden-text";
                } else if (option === 'kanji') {
                    elSpanClassKanji = "hidden-text";
                } else if (option === 'meaning') {
                    elSpanClassMeaning = "hidden-text";
                } else if (option === 'origin') {
                    elSpanClassOrigin = "hidden-text";
                }
            });

            const strNewContent = `
                <div class="vocabulary-card">
                    <div class="lesson-header">
                        <button class="nav-btn" id="btnPrev" ${numCurrentIndex === 0 ? 'disabled' : ''}>‚Üê Tr∆∞·ªõc</button>
                        <div class="audio-controls">
                            ${objCurrentWord.audio ? `
                                <button class="audio-btn" data-audio="${objCurrentWord.audio}">
                                    üîä Nghe ph√°t √¢m
                                </button>
                            ` : `
                                <button class="tts-btn">
                                    üîä Nghe ph√°t √¢m
                                </button>
                            `}
                        </div>
                        <div class="lesson-info">B√†i ${objCurrentWord.lesson}${blnRandomMode ? ' üîÄ' : ''}</div>
                        <div class="show-answer-controls">
                            <button class="show-answer-btn" id="btnShowAll" data-target="divAll">üëÅÔ∏è Hi·ªÉn th·ªã to√†n b·ªô</button>
                        </div>
                        <button class="nav-btn" id="btnNext" ${numCurrentIndex === arrFilteredData.length - 1 ? 'disabled' : ''}>Ti·∫øp ‚Üí</button>
                    </div>
                    
                    <div class="word" id="divWord">
                        <span class="${elSpanClassWord}">${objCurrentWord.word || ''}</span>
                        <canvas class="word-canvas" id="cnvWord-${numCurrentIndex}" style="display: none;"></canvas>
                        <button class="word-drawing-toggle" id="btnWordToggle-${numCurrentIndex}" title="Toggle Writing Mode">‚úèÔ∏è</button>
                    </div>
                    <div class="kanji" id="divKanji">
                        <span class="${elSpanClassKanji}">${objCurrentWord.kanji || ''}</span>
                        <canvas class="kanji-canvas" id="cnvKanji-${numCurrentIndex}" style="display: none;"></canvas>
                        <button class="kanji-drawing-toggle" id="btnKanjiToggle-${numCurrentIndex}" title="Toggle Writing Mode">‚úèÔ∏è</button>
                    </div>
                    <div class="meaning" id="divMeaning">
                        <span class="${elSpanClassMeaning}">${objCurrentWord.meaning || ''}</span>
                        <canvas class="meaning-canvas" id="cnvMeaning-${numCurrentIndex}" style="display: none;"></canvas>
                        <button class="meaning-drawing-toggle" id="btnMeaningToggle-${numCurrentIndex}" title="Toggle Writing Mode">‚úèÔ∏è</button>
                    </div>
                    <div class="vietnamese-origin" id="divOrigin">
                        <span class="${elSpanClassOrigin}">${objCurrentWord.vietnamese_origin || ''}</span>
                        <canvas class="origin-canvas" id="cnvOrigin-${numCurrentIndex}" style="display: none;"></canvas>
                        <button class="origin-drawing-toggle" id="btnOriginToggle-${numCurrentIndex}" title="Toggle Writing Mode">‚úèÔ∏è</button>
                    </div>
                </div>
            `;

            objDOMCache.divContent.innerHTML = strNewContent;

            // Add event listeners for audio buttons
            const elAudioBtn = objDOMCache.divContent.querySelector('.audio-btn');
            if (elAudioBtn) {
                elAudioBtn.addEventListener('click', function() {
                    fnPlayAudio(this.dataset.audio);
                });
            }

            // Add event listeners for TTS buttons
            const elTTSBtn = objDOMCache.divContent.querySelector('.tts-btn');
            if (elTTSBtn) {
                elTTSBtn.addEventListener('click', function() {
                    const strText = objCurrentWord.word || '';
                    if (strText && strText !== 'N/A') {
                        fnPlayTTS(strText, 'ja');
                    }
                });
            }

            // Add event listener for word drawing toggle button
            const elWordToggle = objDOMCache.divContent.querySelector('.word-drawing-toggle');
            if (elWordToggle) {
                elWordToggle.addEventListener('click', function() {
                    fnToggleWordDrawingMode(numCurrentIndex);
                });
            }

            // Add event listeners for other drawing toggle buttons
            const elKanjiToggle = objDOMCache.divContent.querySelector('.kanji-drawing-toggle');
            if (elKanjiToggle) {
                elKanjiToggle.addEventListener('click', function() {
                    fnToggleKanjiDrawingMode(numCurrentIndex);
                });
            }

            const elMeaningToggle = objDOMCache.divContent.querySelector('.meaning-drawing-toggle');
            if (elMeaningToggle) {
                elMeaningToggle.addEventListener('click', function() {
                    fnToggleMeaningDrawingMode(numCurrentIndex);
                });
            }

            const elOriginToggle = objDOMCache.divContent.querySelector('.origin-drawing-toggle');
            if (elOriginToggle) {
                elOriginToggle.addEventListener('click', function() {
                    fnToggleOriginDrawingMode(numCurrentIndex);
                });
            }

            // Add event listeners for show answer buttons
            const arrShowButtons = objDOMCache.divContent.querySelectorAll('.show-answer-btn');
            arrShowButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    const strTarget = this.dataset.target;
                    if (strTarget === 'divAll') {
                        const arrTargets = ['divWord', 'divKanji', 'divMeaning', 'divOrigin'];
                        for (let i = 0; i < arrTargets.length; i++) {
                            fnShowAnswer(arrTargets[i]);
                        }
                    } else {
                        fnShowAnswer(strTarget);
                    }
                });
            });

            // Add event listeners for navigation buttons
            const elBtnPrev = objDOMCache.divContent.querySelector('#btnPrev');
            const elBtnNext = objDOMCache.divContent.querySelector('#btnNext');
            
            if (elBtnPrev) {
                elBtnPrev.addEventListener('click', fnHandlePrevClick);
            }
            
            if (elBtnNext) {
                elBtnNext.addEventListener('click', fnHandleNextClick);
            }

            // Initialize study mode
            setTimeout(() => {
                fnInitStudyMode();
                // Apply current study mode to the new word
                fnApplyCurrentStudyMode();
                
                // Hi·ªÉn th·ªã canvas cho c√°c ph·∫ßn t·ª≠ b·ªã ·∫©n
                fnShowCanvasForHiddenElements();
                
                // T·ª± ƒë·ªông m·ªü word drawing mode n·∫øu l√† iPad
                if (blnIsIPad) {
                    setTimeout(() => {
                        fnToggleWordDrawingMode(numCurrentIndex);
                    }, 200);
                }
            }, 100);

            // Auto play audio/TTS when switching words
            if (objCurrentWord.word) {
                setTimeout(() => {
                    fnAutoPlayTTS(objCurrentWord);
                }, 300); // Delay 300ms ƒë·ªÉ user c√≥ th·ªÉ th·∫•y t·ª´ m·ªõi tr∆∞·ªõc
            }

            fnUpdateCounter();
            fnEnableButtons();
        }

        // Update counter
        function fnUpdateCounter() {
            objDOMCache.spnCounter.textContent = `${numCurrentIndex + 1} / ${arrFilteredData.length}`;
        }

        // Enable/disable buttons
        function fnEnableButtons() {
            const elBtnPrev = document.querySelector('#btnPrev');
            const elBtnNext = document.querySelector('#btnNext');
            
            if (elBtnPrev) {
                elBtnPrev.disabled = numCurrentIndex === 0;
            }
            
            if (elBtnNext) {
                elBtnNext.disabled = numCurrentIndex === arrFilteredData.length - 1;
            }
        }

        // Play audio
        const fnPlayAudioThrottled = fnThrottle(function(strAudioUrl) {
            if (elAudioElement) {
                elAudioElement.pause();
                elAudioElement = null;
            }

            elAudioElement = new Audio(strAudioUrl);
            elAudioElement.play().catch(err => {
                console.error('L·ªói khi ph√°t √¢m thanh:', err);
            });
        }, 500);

        function fnPlayAudio(strAudioUrl) {
            fnPlayAudioThrottled(strAudioUrl);
        }

        // TTS function
        function fnPlayTTS(strText, strLang = 'ja') {
            let elAudioElement = document.getElementById('tts-audio');
            if (!elAudioElement) {
                elAudioElement = document.createElement('audio');
                elAudioElement.id = 'tts-audio';
                document.body.appendChild(elAudioElement);
            }
            
            const strUrl = `https://proxy.junookyo.workers.dev/?language=${strLang}&text=${encodeURIComponent(strText)}&speed=1`;
            elAudioElement.src = strUrl;
            elAudioElement.play().catch(err => {
                console.error('L·ªói khi ph√°t TTS:', err);
            });
        }

        // Auto play TTS when switching words
        function fnAutoPlayTTS(objWord) {
            if (objWord.audio) {
                // N·∫øu c√≥ audio file th√¨ ph√°t audio
                fnPlayAudio(objWord.audio);
            } else if (objWord.word) {
                // N·∫øu kh√¥ng c√≥ audio th√¨ d√πng TTS
                fnPlayTTS(objWord.word, 'ja');
            }
        }

        // Word drawing functions
        function fnInitWordCanvas() {
            const elWordCanvas = document.getElementById(`cnvWord-${numCurrentIndex}`);
            if (!elWordCanvas) return;
            
            objWordCanvas = elWordCanvas;
            objWordContext = elWordCanvas.getContext('2d');
            
            // Set canvas size to match word container
            const elWordContainer = elWordCanvas.parentElement;
            const rect = elWordContainer.getBoundingClientRect();
            objWordCanvas.width = rect.width;
            objWordCanvas.height = rect.height;
            
            // Set drawing styles
            objWordContext.lineCap = 'round';
            objWordContext.lineJoin = 'round';
            objWordContext.strokeStyle = '#000000';
            objWordContext.lineWidth = 2;
            
            // Add event listeners
            fnAddWordDrawingEventListeners();
        }

        function fnInitKanjiCanvas() {
            const elKanjiCanvas = document.getElementById(`cnvKanji-${numCurrentIndex}`);
            if (!elKanjiCanvas) return;
            
            objKanjiCanvas = elKanjiCanvas;
            objKanjiContext = elKanjiCanvas.getContext('2d');
            
            // Set canvas size to match kanji container
            const elKanjiContainer = elKanjiCanvas.parentElement;
            const rect = elKanjiContainer.getBoundingClientRect();
            objKanjiCanvas.width = rect.width;
            objKanjiCanvas.height = rect.height;
            
            // Set drawing styles
            objKanjiContext.lineCap = 'round';
            objKanjiContext.lineJoin = 'round';
            objKanjiContext.strokeStyle = '#000000';
            objKanjiContext.lineWidth = 2;
            
            // Add event listeners
            fnAddKanjiDrawingEventListeners();
        }

        function fnInitMeaningCanvas() {
            const elMeaningCanvas = document.getElementById(`cnvMeaning-${numCurrentIndex}`);
            if (!elMeaningCanvas) return;
            
            objMeaningCanvas = elMeaningCanvas;
            objMeaningContext = elMeaningCanvas.getContext('2d');
            
            // Set canvas size to match meaning container
            const elMeaningContainer = elMeaningCanvas.parentElement;
            const rect = elMeaningContainer.getBoundingClientRect();
            objMeaningCanvas.width = rect.width;
            objMeaningCanvas.height = rect.height;
            
            // Set drawing styles
            objMeaningContext.lineCap = 'round';
            objMeaningContext.lineJoin = 'round';
            objMeaningContext.strokeStyle = '#000000';
            objMeaningContext.lineWidth = 2;
            
            // Add event listeners
            fnAddMeaningDrawingEventListeners();
        }

        function fnInitOriginCanvas() {
            const elOriginCanvas = document.getElementById(`cnvOrigin-${numCurrentIndex}`);
            if (!elOriginCanvas) return;
            
            objOriginCanvas = elOriginCanvas;
            objOriginContext = elOriginCanvas.getContext('2d');
            
            // Set canvas size to match origin container
            const elOriginContainer = elOriginCanvas.parentElement;
            const rect = elOriginContainer.getBoundingClientRect();
            objOriginCanvas.width = rect.width;
            objOriginCanvas.height = rect.height;
            
            // Set drawing styles
            objOriginContext.lineCap = 'round';
            objOriginContext.lineJoin = 'round';
            objOriginContext.strokeStyle = '#000000';
            objOriginContext.lineWidth = 2;
            
            // Add event listeners
            fnAddOriginDrawingEventListeners();
        }

        function fnAddWordDrawingEventListeners() {
            if (!objWordCanvas) return;
            
            // Mouse events
            objWordCanvas.addEventListener('mousedown', fnStartWordDrawing);
            objWordCanvas.addEventListener('mousemove', fnWordDraw);
            objWordCanvas.addEventListener('mouseup', fnStopWordDrawing);
            objWordCanvas.addEventListener('mouseleave', fnStopWordDrawing);
            
            // Touch events for iPad
            objWordCanvas.addEventListener('touchstart', fnHandleWordTouchStart, { passive: false });
            objWordCanvas.addEventListener('touchmove', fnHandleWordTouchMove, { passive: false });
            objWordCanvas.addEventListener('touchend', fnHandleWordTouchEnd, { passive: false });
            
            // Pointer events for Apple Pencil
            objWordCanvas.addEventListener('pointerdown', fnHandleWordPointerDown);
            objWordCanvas.addEventListener('pointermove', fnHandleWordPointerMove);
            objWordCanvas.addEventListener('pointerup', fnHandleWordPointerUp);
            objWordCanvas.addEventListener('pointerleave', fnHandleWordPointerUp);
        }

        function fnAddKanjiDrawingEventListeners() {
            if (!objKanjiCanvas) return;
            
            // Mouse events
            objKanjiCanvas.addEventListener('mousedown', fnStartKanjiDrawing);
            objKanjiCanvas.addEventListener('mousemove', fnKanjiDraw);
            objKanjiCanvas.addEventListener('mouseup', fnStopKanjiDrawing);
            objKanjiCanvas.addEventListener('mouseleave', fnStopKanjiDrawing);
            
            // Touch events for iPad
            objKanjiCanvas.addEventListener('touchstart', fnHandleKanjiTouchStart, { passive: false });
            objKanjiCanvas.addEventListener('touchmove', fnHandleKanjiTouchMove, { passive: false });
            objKanjiCanvas.addEventListener('touchend', fnHandleKanjiTouchEnd, { passive: false });
            
            // Pointer events for Apple Pencil
            objKanjiCanvas.addEventListener('pointerdown', fnHandleKanjiPointerDown);
            objKanjiCanvas.addEventListener('pointermove', fnHandleKanjiPointerMove);
            objKanjiCanvas.addEventListener('pointerup', fnHandleKanjiPointerUp);
            objKanjiCanvas.addEventListener('pointerleave', fnHandleKanjiPointerUp);
        }

        function fnAddMeaningDrawingEventListeners() {
            if (!objMeaningCanvas) return;
            
            // Mouse events
            objMeaningCanvas.addEventListener('mousedown', fnStartMeaningDrawing);
            objMeaningCanvas.addEventListener('mousemove', fnMeaningDraw);
            objMeaningCanvas.addEventListener('mouseup', fnStopMeaningDrawing);
            objMeaningCanvas.addEventListener('mouseleave', fnStopMeaningDrawing);
            
            // Touch events for iPad
            objMeaningCanvas.addEventListener('touchstart', fnHandleMeaningTouchStart, { passive: false });
            objMeaningCanvas.addEventListener('touchmove', fnHandleMeaningTouchMove, { passive: false });
            objMeaningCanvas.addEventListener('touchend', fnHandleMeaningTouchEnd, { passive: false });
            
            // Pointer events for Apple Pencil
            objMeaningCanvas.addEventListener('pointerdown', fnHandleMeaningPointerDown);
            objMeaningCanvas.addEventListener('pointermove', fnHandleMeaningPointerMove);
            objMeaningCanvas.addEventListener('pointerup', fnHandleMeaningPointerUp);
            objMeaningCanvas.addEventListener('pointerleave', fnHandleMeaningPointerUp);
        }

        function fnAddOriginDrawingEventListeners() {
            if (!objOriginCanvas) return;
            
            // Mouse events
            objOriginCanvas.addEventListener('mousedown', fnStartOriginDrawing);
            objOriginCanvas.addEventListener('mousemove', fnOriginDraw);
            objOriginCanvas.addEventListener('mouseup', fnStopOriginDrawing);
            objOriginCanvas.addEventListener('mouseleave', fnStopOriginDrawing);
            
            // Touch events for iPad
            objOriginCanvas.addEventListener('touchstart', fnHandleOriginTouchStart, { passive: false });
            objOriginCanvas.addEventListener('touchmove', fnHandleOriginTouchMove, { passive: false });
            objOriginCanvas.addEventListener('touchend', fnHandleOriginTouchEnd, { passive: false });
            
            // Pointer events for Apple Pencil
            objOriginCanvas.addEventListener('pointerdown', fnHandleOriginPointerDown);
            objOriginCanvas.addEventListener('pointermove', fnHandleOriginPointerMove);
            objOriginCanvas.addEventListener('pointerup', fnHandleOriginPointerUp);
            objOriginCanvas.addEventListener('pointerleave', fnHandleOriginPointerUp);
        }

        // Touch event handlers for word canvas
        function fnHandleWordTouchStart(evt) {
            evt.preventDefault();
            const touch = evt.touches[0];
            const rect = objWordCanvas.getBoundingClientRect();
            arrWordLastPoint = {
                x: touch.clientX - rect.left,
                y: touch.clientY - rect.top
            };
            blnIsWordDrawing = true;
        }

        function fnHandleWordTouchMove(evt) {
            evt.preventDefault();
            if (!blnIsWordDrawing) return;
            
            const touch = evt.touches[0];
            const rect = objWordCanvas.getBoundingClientRect();
            const currentPoint = {
                x: touch.clientX - rect.left,
                y: touch.clientY - rect.top
            };
            
            fnDrawWordLine(arrWordLastPoint, currentPoint);
            arrWordLastPoint = currentPoint;
        }

        function fnHandleWordTouchEnd(evt) {
            evt.preventDefault();
            blnIsWordDrawing = false;
            arrWordLastPoint = null;
        }

        // Pointer event handlers for word canvas
        function fnHandleWordPointerDown(evt) {
            evt.preventDefault();
            const rect = objWordCanvas.getBoundingClientRect();
            arrWordLastPoint = {
                x: evt.clientX - rect.left,
                y: evt.clientY - rect.top
            };
            blnIsWordDrawing = true;
        }

        function fnHandleWordPointerMove(evt) {
            evt.preventDefault();
            if (!blnIsWordDrawing) return;
            
            const rect = objWordCanvas.getBoundingClientRect();
            const currentPoint = {
                x: evt.clientX - rect.left,
                y: evt.clientY - rect.top
            };
            
            fnDrawWordLine(arrWordLastPoint, currentPoint);
            arrWordLastPoint = currentPoint;
        }

        function fnHandleWordPointerUp(evt) {
            evt.preventDefault();
            blnIsWordDrawing = false;
            arrWordLastPoint = null;
        }

        // Mouse event handlers for word canvas
        function fnStartWordDrawing(evt) {
            blnIsWordDrawing = true;
            const rect = objWordCanvas.getBoundingClientRect();
            arrWordLastPoint = {
                x: evt.clientX - rect.left,
                y: evt.clientY - rect.top
            };
        }

        function fnWordDraw(evt) {
            if (!blnIsWordDrawing) return;
            
            const rect = objWordCanvas.getBoundingClientRect();
            const currentPoint = {
                x: evt.clientX - rect.left,
                y: evt.clientY - rect.top
            };
            
            fnDrawWordLine(arrWordLastPoint, currentPoint);
            arrWordLastPoint = currentPoint;
        }

        function fnStopWordDrawing() {
            blnIsWordDrawing = false;
            arrWordLastPoint = null;
        }

        // Draw line on word canvas
        function fnDrawWordLine(startPoint, endPoint) {
            if (!startPoint || !endPoint || !objWordContext) return;
            
            objWordContext.beginPath();
            objWordContext.moveTo(startPoint.x, startPoint.y);
            objWordContext.lineTo(endPoint.x, endPoint.y);
            objWordContext.stroke();
        }

        // Draw line on kanji canvas
        function fnDrawKanjiLine(startPoint, endPoint) {
            if (!startPoint || !endPoint || !objKanjiContext) return;
            
            objKanjiContext.beginPath();
            objKanjiContext.moveTo(startPoint.x, startPoint.y);
            objKanjiContext.lineTo(endPoint.x, endPoint.y);
            objKanjiContext.stroke();
        }

        // Draw line on meaning canvas
        function fnDrawMeaningLine(startPoint, endPoint) {
            if (!startPoint || !endPoint || !objMeaningContext) return;
            
            objMeaningContext.beginPath();
            objMeaningContext.moveTo(startPoint.x, startPoint.y);
            objMeaningContext.lineTo(endPoint.x, endPoint.y);
            objMeaningContext.stroke();
        }

        // Draw line on origin canvas
        function fnDrawOriginLine(startPoint, endPoint) {
            if (!startPoint || !endPoint || !objOriginContext) return;
            
            objOriginContext.beginPath();
            objOriginContext.moveTo(startPoint.x, startPoint.y);
            objOriginContext.lineTo(endPoint.x, endPoint.y);
            objOriginContext.stroke();
        }

        // Toggle word drawing mode
        function fnToggleWordDrawingMode(numIndex) {
            const elCanvas = document.getElementById(`cnvWord-${numIndex}`);
            const elToggle = document.getElementById(`btnWordToggle-${numIndex}`);
            
            if (!elCanvas || !elToggle) return;
            
            blnWordDrawingMode = !blnWordDrawingMode;
            
            if (blnWordDrawingMode) {
                elCanvas.style.display = 'block';
                elToggle.classList.add('active');
                elToggle.innerHTML = '‚úèÔ∏è';
                // Initialize canvas when enabled
                setTimeout(() => fnInitWordCanvas(), 100);
            } else {
                elCanvas.style.display = 'none';
                elToggle.classList.remove('active');
                elToggle.innerHTML = '‚úèÔ∏è';
            }
        }

        // Clear word canvas
        function fnClearWordCanvas() {
            if (objWordContext && objWordCanvas) {
                objWordContext.clearRect(0, 0, objWordCanvas.width, objWordCanvas.height);
            }
        }

        // Study mode functions
        function fnInitStudyMode() {
            console.log('Initializing study mode...'); // Debug log
            
            const elStudyDropdown = document.getElementById('selStudyMode');
            console.log('Found dropdown:', elStudyDropdown); // Debug log
            
            if (elStudyDropdown) {
                console.log('Adding event listeners to dropdown'); // Debug log
                
                // Remove existing event listeners first
                const elNewDropdown = elStudyDropdown.cloneNode(true);
                elStudyDropdown.parentNode.replaceChild(elNewDropdown, elStudyDropdown);
                
                // Toggle dropdown
                elNewDropdown.addEventListener('click', function(evt) {
                    console.log('Dropdown clicked'); // Debug
                    evt.stopPropagation();
                    fnToggleStudyDropdown();
                });
                
                // Handle checkbox changes
                const arrCheckboxes = elNewDropdown.querySelectorAll('input[type="checkbox"]');
                console.log('Found checkboxes:', arrCheckboxes.length); // Debug
                arrCheckboxes.forEach(checkbox => {
                    checkbox.addEventListener('change', function(evt) {
                        console.log('Checkbox changed:', this.id); // Debug
                        evt.stopPropagation();
                        fnHandleStudyCheckboxChange(this);
                    });
                });
                
                // Close dropdown when clicking outside
                document.addEventListener('click', function(evt) {
                    if (!elNewDropdown.contains(evt.target)) {
                        console.log('Clicking outside, closing dropdown'); // Debug
                        fnCloseStudyDropdown();
                    }
                });
                
                // Restore checkbox states from objSelectedStudyOptions
                console.log('Restoring checkbox states:', Array.from(objSelectedStudyOptions)); // Debug
                arrCheckboxes.forEach(checkbox => {
                    const strValue = checkbox.closest('.study-option').dataset.value;
                    checkbox.checked = objSelectedStudyOptions.has(strValue);
                });
                
                fnUpdateStudyDropdownText();
                console.log('Study mode initialized successfully'); // Debug log
            } else {
                console.error('Study dropdown not found!'); // Debug log
            }
        }

        function fnToggleStudyDropdown() {
            const elStudyDropdown = document.getElementById('selStudyMode');
            
            console.log('Toggle dropdown called'); // Debug
            console.log('Found dropdown:', elStudyDropdown); // Debug
            
            if (elStudyDropdown) {
                const blnWasActive = elStudyDropdown.classList.contains('active');
                elStudyDropdown.classList.toggle('active');
                const blnIsActive = elStudyDropdown.classList.contains('active');
                
                console.log('Dropdown was active:', blnWasActive); // Debug
                console.log('Dropdown is now active:', blnIsActive); // Debug
                
                // Check if options are visible
                const elOptions = elStudyDropdown.querySelector('.study-dropdown-options');
                console.log('Options element:', elOptions); // Debug
                console.log('Options display:', elOptions ? elOptions.style.display : 'N/A'); // Debug
            } else {
                console.log('Dropdown not found!'); // Debug
            }
        }

        function fnCloseStudyDropdown() {
            const elStudyDropdown = document.getElementById('selStudyMode');
            if (elStudyDropdown) {
                elStudyDropdown.classList.remove('active');
            }
        }

        function fnHandleStudyCheckboxChange(elCheckbox) {
            const strValue = elCheckbox.closest('.study-option').dataset.value;
            const blnChecked = elCheckbox.checked;
            
            console.log('Checkbox changed:', strValue, blnChecked); // Debug log
            
            if (strValue === 'all') {
                // If "all" is checked, uncheck others and show all
                if (blnChecked) {
                    objSelectedStudyOptions.clear();
                    objSelectedStudyOptions.add('all');
                    fnResetStudyMode();
                    fnUncheckOtherOptions('all');
                } else {
                    // Don't allow unchecking "all" if no other options are selected
                    if (objSelectedStudyOptions.size === 1) {
                        elCheckbox.checked = true;
                        return;
                    }
                    objSelectedStudyOptions.delete('all');
                }
            } else {
                // If other option is checked, uncheck "all"
                if (blnChecked) {
                    objSelectedStudyOptions.delete('all');
                    objSelectedStudyOptions.add(strValue);
                    fnUncheckOption('all');
                } else {
                    objSelectedStudyOptions.delete(strValue);
                    
                    // If no options selected, check "all"
                    if (objSelectedStudyOptions.size === 0) {
                        objSelectedStudyOptions.add('all');
                        fnCheckOption('all');
                        fnResetStudyMode();
                    }
                }
            }

            // Apply study mode to current word
            fnApplyCurrentStudyMode();
            
            // Save study mode state
            fnSaveStudyModeState();
            
            fnUpdateStudyDropdownText();
            console.log('Selected options:', Array.from(objSelectedStudyOptions)); // Debug log
        }

        function fnUncheckOtherOptions(strExcludeValue) {
            const arrCheckboxes = document.querySelectorAll('#selStudyMode input[type="checkbox"]');
            arrCheckboxes.forEach(checkbox => {
                const strValue = checkbox.closest('.study-option').dataset.value;
                if (strValue !== strExcludeValue) {
                    checkbox.checked = false;
                }
            });
        }

        function fnUncheckOption(strValue) {
            const elCheckbox = document.querySelector(`#selStudyMode input[type="checkbox"][id="chk${strValue.charAt(0).toUpperCase() + strValue.slice(1)}"]`);
            if (elCheckbox) {
                elCheckbox.checked = false;
            }
        }

        function fnCheckOption(strValue) {
            const elCheckbox = document.querySelector(`#selStudyMode input[type="checkbox"][id="chk${strValue.charAt(0).toUpperCase() + strValue.slice(1)}"]`);
            if (elCheckbox) {
                elCheckbox.checked = true;
            }
        }

        function fnUpdateStudyDropdownText() {
            const elText = document.querySelector('#selStudyMode .study-dropdown-text');
            if (!elText) {
                console.log('Study dropdown text not found'); // Debug
                return;
            }
            
            if (objSelectedStudyOptions.has('all')) {
                elText.textContent = 'üìö Hi·ªán t·∫•t c·∫£';
            } else {
                const arrSelected = Array.from(objSelectedStudyOptions);
                if (arrSelected.length === 0) {
                    elText.textContent = 'üìö Hi·ªán t·∫•t c·∫£';
                } else if (arrSelected.length === 1) {
                    const strOption = arrSelected[0];
                    elText.textContent = strOption === 'word' ? '·∫®n t·ª´ v·ª±ng' :
                                       strOption === 'kanji' ? '·∫®n kanji' :
                                       strOption === 'meaning' ? '·∫®n nghƒ©a' : '·∫®n g·ªëc Vi·ªát';
                } else {
                    elText.textContent = `·∫®n ${arrSelected.length} m·ª•c`;
                }
            }
            
            console.log('Updated dropdown text:', elText.textContent); // Debug
        }

        function fnHideElement(strElementId) {
            const elElement = document.getElementById(strElementId);
            console.log('fnHideElement called for:', strElementId, 'Found:', !!elElement); // Debug
            
            if (!elElement) return;
            
            // Find the text content and wrap it in a span if needed
            let elTextContent = elElement.childNodes[1];
            if (elTextContent && elTextContent.classList) {
                // If it's already an element, just add the class
                elTextContent.classList.add('hidden-text');
                console.log('Added hidden-text class for:', strElementId); // Debug
            }
            
            // Update the corresponding show button text
            const strButtonId = `btnShow${strElementId.charAt(0).toUpperCase() + strElementId.slice(1)}`;
            const elButton = document.getElementById(strButtonId);
            if (elButton) {
                elButton.textContent = 'üëÅÔ∏è Hi·ªán';
                elButton.classList.add('active');
                console.log('Updated button:', strButtonId); // Debug
            }
            
            // Add to hidden elements set
            objHiddenElements.add(strElementId);
            console.log('Added to hidden elements:', strElementId); // Debug
        }

        function fnShowElement(strElementId) {
            const elElement = document.getElementById(strElementId);
            if (!elElement) return;
            
            // Find the hidden text span and unwrap it
            const elHiddenSpan = elElement.querySelector('.hidden-text');
            if (elHiddenSpan) {
                // Create a new text node
                const elSpanNode = document.createElement('span');
                elSpanNode.textContent = elHiddenSpan.textContent;
                // const elTextNode = document.createTextNode(elHiddenSpan.textContent);
                
                // Replace span with text node
                elElement.replaceChild(elSpanNode, elHiddenSpan);
            }
            
            // Update the corresponding show button text
            const strButtonId = `btnShow${strElementId.charAt(0).toUpperCase() + strElementId.slice(1)}`;
            const elButton = document.getElementById(strButtonId);
            if (elButton) {
                // Restore original button text based on element type
                const strOriginalText = fnGetOriginalButtonText(strElementId);
                elButton.textContent = strOriginalText;
                elButton.classList.remove('active');
            }
            
            // Remove from hidden elements set
            objHiddenElements.delete(strElementId);
        }

        function fnGetOriginalButtonText(strElementId) {
            switch (strElementId) {
                case 'divWord': return 'üëÅÔ∏è Hi·ªán t·ª´ v·ª±ng';
                case 'divKanji': return 'üëÅÔ∏è Hi·ªán kanji';
                case 'divMeaning': return 'üëÅÔ∏è Hi·ªán nghƒ©a';
                case 'divOrigin': return 'üëÅÔ∏è Hi·ªán g·ªëc Vi·ªát';
                default: return 'üëÅÔ∏è Hi·ªán';
            }
        }

        function fnResetStudyMode() {
            // Show all elements
            objHiddenElements.forEach(elementId => {
                fnShowElement(elementId);
            });
            
            // Clear hidden elements set
            objHiddenElements.clear();
            
            // Remove study mode class
            const elVocabCard = document.querySelector('.vocabulary-card');
            if (elVocabCard) {
                elVocabCard.classList.remove('study-mode-active');
            }
            
            // Reset dropdown
            const elStudyDropdown = document.getElementById('selStudyMode');
            if (elStudyDropdown) {
                // elStudyDropdown.value = 'all'; // Reset to 'all'
            }
            
            // strCurrentStudyMode = 'all';
        }

        function fnShowAnswer(strElementId) {
            fnShowElement(strElementId);
        }

        function fnApplyCurrentStudyMode() {
            console.log('Applying current study mode:', Array.from(objSelectedStudyOptions)); // Debug
            
            // Wait a bit for DOM to be ready
            setTimeout(() => {
                // Clear current hidden elements first
                objHiddenElements.forEach(elementId => {
                    fnShowElement(elementId);
                });
                objHiddenElements.clear();
                
                // Apply selected options
                objSelectedStudyOptions.forEach(option => {
                    if (option !== 'all') {
                        const strElementId = option === 'word' ? 'divWord' : 
                                           option === 'kanji' ? 'divKanji' : 
                                           option === 'meaning' ? 'divMeaning' : 'divOrigin';
                        console.log('Hiding element:', strElementId); // Debug
                        fnHideElement(strElementId);
                    }
                });
                
                console.log('Study mode applied successfully'); // Debug
            }, 150);
        }

        // Event handlers
        const fnHandlePrevClick = fnDebounce(function() {
            if (numCurrentIndex > 0) {
                numCurrentIndex--;
                fnUpdateDisplay();
                fnEnableButtons();
                
                // T·ª± ƒë·ªông m·ªü word drawing mode n·∫øu l√† iPad
                if (blnIsIPad) {
                    setTimeout(() => {
                        fnToggleWordDrawingMode(numCurrentIndex);
                    }, 200);
                }
            }
        }, 100);

        const fnHandleNextClick = fnDebounce(function() {
            if (numCurrentIndex < arrFilteredData.length - 1) {
                numCurrentIndex++;
                fnUpdateDisplay();
                fnEnableButtons();
                
                // T·ª± ƒë·ªông m·ªü word drawing mode n·∫øu l√† iPad
                if (blnIsIPad) {
                    setTimeout(() => {
                        fnToggleWordDrawingMode(numCurrentIndex);
                    }, 200);
                }
            } else {
                // Khi h·∫øt t·ª´ v·ª±ng, random l·∫°i v√† b·∫Øt ƒë·∫ßu t·ª´ ƒë·∫ßu
                fnRandomizeVocabulary();
                fnUpdateDisplay();
                fnUpdateCounter();
                fnEnableButtons();
                
                // T·ª± ƒë·ªông m·ªü word drawing mode n·∫øu l√† iPad
                if (blnIsIPad) {
                    setTimeout(() => {
                        fnToggleWordDrawingMode(0);
                    }, 200);
                }
            }
        }, 100);

        // Keyboard handler
        const fnHandleKeydown = fnThrottle(function(evt) {
            if (evt.key === 'ArrowLeft' || evt.key === 'ArrowUp') {
                if (numCurrentIndex > 0) {
                    numCurrentIndex--;
                    fnUpdateDisplay();
                    fnEnableButtons();
                    
                    // T·ª± ƒë·ªông m·ªü word drawing mode n·∫øu l√† iPad
                    if (blnIsIPad) {
                        setTimeout(() => {
                            fnToggleWordDrawingMode(numCurrentIndex);
                        }, 200);
                    }
                }
            } else if (evt.key === 'ArrowRight' || evt.key === 'ArrowDown') {
                if (numCurrentIndex < arrFilteredData.length - 1) {
                    numCurrentIndex++;
                    fnUpdateDisplay();
                    fnEnableButtons();
                    
                    // T·ª± ƒë·ªông m·ªü word drawing mode n·∫øu l√† iPad
                    if (blnIsIPad) {
                        setTimeout(() => {
                            fnToggleWordDrawingMode(numCurrentIndex);
                        }, 200);
                    }
                } else {
                    // Khi h·∫øt t·ª´ v·ª±ng, random l·∫°i v√† b·∫Øt ƒë·∫ßu t·ª´ ƒë·∫ßu
                    fnRandomizeVocabulary();
                    fnUpdateDisplay();
                    fnUpdateCounter();
                    fnEnableButtons();
                    
                    // T·ª± ƒë·ªông m·ªü word drawing mode n·∫øu l√† iPad
                    if (blnIsIPad) {
                        setTimeout(() => {
                            fnToggleWordDrawingMode(0);
                        }, 200);
                    }
                }
            } else if (evt.key === ' ') {
                evt.preventDefault();
                const objCurrentWord = arrFilteredData[numCurrentIndex];
                if (objCurrentWord) {
                    if (objCurrentWord.audio) {
                        fnPlayAudio(objCurrentWord.audio);
                    } else if (objCurrentWord.word) {
                        fnPlayTTS(objCurrentWord.word, 'ja');
                    }
                }
            } else if (evt.key === 'r' || evt.key === 'R') {
                // Ph√≠m R ƒë·ªÉ random
                evt.preventDefault();
                fnRandomizeVocabulary();
                fnUpdateDisplay();
                fnUpdateCounter();
                fnEnableButtons();
                
                // T·ª± ƒë·ªông m·ªü word drawing mode n·∫øu l√† iPad
                if (blnIsIPad) {
                    setTimeout(() => {
                        fnToggleWordDrawingMode(0);
                    }, 200);
                }
            }
        }, 150);

        // Modal functions
        function fnOpenModal() {
            objDOMCache.mdlLessonSelector.style.display = 'block';
            const arrCheckboxes = document.querySelectorAll('.lesson-checkbox');
            arrCheckboxes.forEach(checkbox => {
                checkbox.checked = objSelectedLessons.has(checkbox.value);
            });
        }

        function fnCloseModal() {
            objDOMCache.mdlLessonSelector.style.display = 'none';
        }

        function fnApplySelection() {
            const arrCheckboxes = document.querySelectorAll('.lesson-checkbox:checked');
            objSelectedLessons = new Set(Array.from(arrCheckboxes).map(cb => cb.value));
            
            fnUpdateFilteredData();
            
            // Random khi ch·ªçn b√†i h·ªçc m·ªõi
            if (arrFilteredData.length > 1) {
                fnRandomizeVocabulary();
            }
            
            fnUpdateDisplay();
            fnUpdateCounter();
            fnEnableButtons();
            fnUpdateSelectedLessonsDisplay();
            fnSaveSelectedLessons();
            fnCloseModal();
            
            // T·ª± ƒë·ªông m·ªü word drawing mode n·∫øu l√† iPad v√† c√≥ t·ª´ v·ª±ng
            if (blnIsIPad && arrFilteredData.length > 0) {
                setTimeout(() => {
                    fnToggleWordDrawingMode(0);
                }, 300);
            }
        }

        // Initialize event listeners
        function fnInitializeEventListeners() {
            // Navigation button events are now handled dynamically in fnUpdateDisplay
            // No need to add event listeners here anymore
            
            // Modal events
            document.getElementById('btnSelectLesson').addEventListener('click', fnOpenModal);
            document.getElementById('btnCloseModal').addEventListener('click', fnCloseModal);
            document.getElementById('btnCancel').addEventListener('click', fnCloseModal);
            document.getElementById('btnApply').addEventListener('click', fnApplySelection);

            // Select all events
            document.getElementById('btnSelectAll').addEventListener('click', function() {
                const arrCheckboxes = document.querySelectorAll('.lesson-checkbox');
                arrCheckboxes.forEach(checkbox => checkbox.checked = true);
            });

            document.getElementById('btnDeselectAll').addEventListener('click', function() {
                const arrCheckboxes = document.querySelectorAll('.lesson-checkbox');
                arrCheckboxes.forEach(checkbox => checkbox.checked = false);
            });

            document.getElementById('btnSelectRange').addEventListener('click', function() {
                const strStart = prompt('Nh·∫≠p b√†i h·ªçc b·∫Øt ƒë·∫ßu:');
                const strEnd = prompt('Nh·∫≠p b√†i h·ªçc k·∫øt th√∫c:');
                
                if (strStart && strEnd && !isNaN(strStart) && !isNaN(strEnd)) {
                    const numStart = parseInt(strStart);
                    const numEnd = parseInt(strEnd);
                    
                    const arrCheckboxes = document.querySelectorAll('.lesson-checkbox');
                    arrCheckboxes.forEach(checkbox => {
                        const numLesson = parseInt(checkbox.value);
                        checkbox.checked = numLesson >= numStart && numLesson <= numEnd;
                    });
                }
            });

            // Keyboard events
            document.addEventListener('keydown', fnHandleKeydown);

            // Modal outside click
            window.addEventListener('click', function(evt) {
                if (evt.target === objDOMCache.mdlLessonSelector) {
                    fnCloseModal();
                }
            });
        }

        // Load data when page loads
        document.addEventListener('DOMContentLoaded', function() {
            fnLoadVocabularyData().then(() => {
                fnInitializeEventListeners();
            });
        });

        // Setup MutationObserver for study mode
        function fnSetupStudyModeObserver() {
            if (objStudyModeObserver) {
                objStudyModeObserver.disconnect();
            }
            
            objStudyModeObserver = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'childList') {
                        mutation.addedNodes.forEach(function(node) {
                            if (node.nodeType === Node.ELEMENT_NODE) {
                                const elStudyDropdown = node.querySelector('#selStudyMode') || 
                                                      (node.id === 'selStudyMode' ? node : null);
                                if (elStudyDropdown) {
                                    console.log('Study dropdown detected via MutationObserver'); // Debug
                                    setTimeout(() => {
                                        fnInitStudyMode();
                                        fnApplyCurrentStudyMode();
                                    }, 50);
                                }
                            }
                        });
                    }
                });
            });
            
            // Observe the container where vocabulary card is rendered
            const elContainer = document.getElementById('divContent');
            if (elContainer) {
                objStudyModeObserver.observe(elContainer, {
                    childList: true,
                    subtree: true
                });
                console.log('Study mode observer setup'); // Debug
            }
        }

        // Function ƒë·ªÉ hi·ªÉn th·ªã canvas cho c√°c ph·∫ßn t·ª≠ b·ªã ·∫©n
        function fnShowCanvasForHiddenElements() {
            // Ki·ªÉm tra t·ª´ng ph·∫ßn t·ª≠ v√† hi·ªÉn th·ªã canvas n·∫øu b·ªã ·∫©n
            const elWord = document.getElementById('divWord');
            const elKanji = document.getElementById('divKanji');
            const elMeaning = document.getElementById('divMeaning');
            const elOrigin = document.getElementById('divOrigin');
            
            if (elWord && elWord.querySelector('.hidden-text')) {
                const elCanvas = document.getElementById(`cnvWord-${numCurrentIndex}`);
                if (elCanvas) {
                    elCanvas.style.display = 'block';
                }
            }
            
            if (elKanji && elKanji.querySelector('.hidden-text')) {
                const elCanvas = document.getElementById(`cnvKanji-${numCurrentIndex}`);
                if (elCanvas) {
                    elCanvas.style.display = 'block';
                }
            }
            
            if (elMeaning && elMeaning.querySelector('.hidden-text')) {
                const elCanvas = document.getElementById(`cnvMeaning-${numCurrentIndex}`);
                if (elCanvas) {
                    elCanvas.style.display = 'block';
                }
            }
            
            if (elOrigin && elOrigin.querySelector('.hidden-text')) {
                const elCanvas = document.getElementById(`cnvOrigin-${numCurrentIndex}`);
                if (elCanvas) {
                    elCanvas.style.display = 'block';
                }
            }
        }

        // Toggle functions for other canvas types
        function fnToggleKanjiDrawingMode(numIndex) {
            const elCanvas = document.getElementById(`cnvKanji-${numIndex}`);
            const elToggle = document.getElementById(`btnKanjiToggle-${numIndex}`);
            
            if (!elCanvas || !elToggle) return;
            
            blnKanjiDrawingMode = !blnKanjiDrawingMode;
            
            if (blnKanjiDrawingMode) {
                elCanvas.style.display = 'block';
                elToggle.classList.add('active');
                elToggle.innerHTML = '‚úèÔ∏è';
                setTimeout(() => fnInitKanjiCanvas(), 100);
            } else {
                elCanvas.style.display = 'none';
                elToggle.classList.remove('active');
                elToggle.innerHTML = '‚úèÔ∏è';
            }
        }

        function fnToggleMeaningDrawingMode(numIndex) {
            const elCanvas = document.getElementById(`cnvMeaning-${numIndex}`);
            const elToggle = document.getElementById(`btnMeaningToggle-${numIndex}`);
            
            if (!elCanvas || !elToggle) return;
            
            blnMeaningDrawingMode = !blnMeaningDrawingMode;
            
            if (blnMeaningDrawingMode) {
                elCanvas.style.display = 'block';
                elToggle.classList.add('active');
                elToggle.innerHTML = '‚úèÔ∏è';
                setTimeout(() => fnInitMeaningCanvas(), 100);
            } else {
                elCanvas.style.display = 'none';
                elToggle.classList.remove('active');
                elToggle.innerHTML = '‚úèÔ∏è';
            }
        }

        function fnToggleOriginDrawingMode(numIndex) {
            const elCanvas = document.getElementById(`cnvOrigin-${numIndex}`);
            const elToggle = document.getElementById(`btnOriginToggle-${numIndex}`);
            
            if (!elCanvas || !elToggle) return;
            
            blnOriginDrawingMode = !blnOriginDrawingMode;
            
            if (blnOriginDrawingMode) {
                elCanvas.style.display = 'block';
                elToggle.classList.add('active');
                elToggle.innerHTML = '‚úèÔ∏è';
                setTimeout(() => fnInitOriginCanvas(), 100);
            } else {
                elCanvas.style.display = 'none';
                elToggle.classList.remove('active');
                elToggle.innerHTML = '‚úèÔ∏è';
            }
        }

        // Mouse event handlers for kanji canvas
        function fnStartKanjiDrawing(evt) {
            blnIsKanjiDrawing = true;
            const rect = objKanjiCanvas.getBoundingClientRect();
            arrKanjiLastPoint = {
                x: evt.clientX - rect.left,
                y: evt.clientY - rect.top
            };
        }

        function fnKanjiDraw(evt) {
            if (!blnIsKanjiDrawing) return;
            
            const rect = objKanjiCanvas.getBoundingClientRect();
            const currentPoint = {
                x: evt.clientX - rect.left,
                y: evt.clientY - rect.top
            };
            
            fnDrawKanjiLine(arrKanjiLastPoint, currentPoint);
            arrKanjiLastPoint = currentPoint;
        }

        function fnStopKanjiDrawing() {
            blnIsKanjiDrawing = false;
            arrKanjiLastPoint = null;
        }

        // Mouse event handlers for meaning canvas
        function fnStartMeaningDrawing(evt) {
            blnIsMeaningDrawing = true;
            const rect = objMeaningCanvas.getBoundingClientRect();
            arrMeaningLastPoint = {
                x: evt.clientX - rect.left,
                y: evt.clientY - rect.top
            };
        }

        function fnMeaningDraw(evt) {
            if (!blnIsMeaningDrawing) return;
            
            const rect = objMeaningCanvas.getBoundingClientRect();
            const currentPoint = {
                x: evt.clientX - rect.left,
                y: evt.clientY - rect.top
            };
            
            fnDrawMeaningLine(arrMeaningLastPoint, currentPoint);
            arrMeaningLastPoint = currentPoint;
        }

        function fnStopMeaningDrawing() {
            blnIsMeaningDrawing = false;
            arrMeaningLastPoint = null;
        }

        // Mouse event handlers for origin canvas
        function fnStartOriginDrawing(evt) {
            blnIsOriginDrawing = true;
            const rect = objOriginCanvas.getBoundingClientRect();
            arrOriginLastPoint = {
                x: evt.clientX - rect.left,
                y: evt.clientY - rect.top
            };
        }

        function fnOriginDraw(evt) {
            if (!blnIsOriginDrawing) return;
            
            const rect = objOriginCanvas.getBoundingClientRect();
            const currentPoint = {
                x: evt.clientX - rect.left,
                y: evt.clientY - rect.top
            };
            
            fnDrawOriginLine(arrOriginLastPoint, currentPoint);
            arrOriginLastPoint = currentPoint;
        }

        function fnStopOriginDrawing() {
            blnIsOriginDrawing = false;
            arrOriginLastPoint = null;
        }

        // Touch event handlers for kanji canvas
        function fnHandleKanjiTouchStart(evt) {
            evt.preventDefault();
            const touch = evt.touches[0];
            const rect = objKanjiCanvas.getBoundingClientRect();
            arrKanjiLastPoint = {
                x: touch.clientX - rect.left,
                y: touch.clientY - rect.top
            };
            blnIsKanjiDrawing = true;
        }

        function fnHandleKanjiTouchMove(evt) {
            evt.preventDefault();
            if (!blnIsKanjiDrawing) return;
            
            const touch = evt.touches[0];
            const rect = objKanjiCanvas.getBoundingClientRect();
            const currentPoint = {
                x: touch.clientX - rect.left,
                y: touch.clientY - rect.top
            };
            
            fnDrawKanjiLine(arrKanjiLastPoint, currentPoint);
            arrKanjiLastPoint = currentPoint;
        }

        function fnHandleKanjiTouchEnd(evt) {
            evt.preventDefault();
            blnIsKanjiDrawing = false;
            arrKanjiLastPoint = null;
        }
    </script>
</body>
</html> 