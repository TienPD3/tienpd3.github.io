<!DOCTYPE html>
<html lang="vi">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Tá»« vá»±ng Nháº­t - Tá»« @vocabulary.json</title>
	<meta name="description" content="Báº£ng tá»« vá»±ng Nháº­t Báº£n vá»›i tÃ¬m kiáº¿m, lá»c theo bÃ i, sáº¯p xáº¿p vÃ  phÃ¡t Ã¢m thanh.">
	<style>
        @font-face {
            font-family: 'UTM Bauhaus';
            src: url('./css/fonts/UTM-Bauhaus-Light.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }
		:root {
			--bg: #0b0c10;
			--panel: #12141a;
			--panel-2: #171923;
			--text: #e8eaf0;
			--muted: #a7adc0;
			--brand: #4f8cff;
			--accent: #22c55e;
			--danger: #ef4444;
			--border: #2a2f3b;
		}
		@media (prefers-color-scheme: light) {
			:root {
				--bg: #f7f9fc;
				--panel: #ffffff;
				--panel-2: #f2f5fb;
				--text: #0e1116;
				--muted: #556078;
				--brand: #2563eb;
				--accent: #16a34a;
				--danger: #dc2626;
				--border: #e6eaf2;
			}
		}
		* { 
            margin: 0;
            padding: 0;
            box-sizing: border-box; 
            font-family: 'UTM Bauhaus', sans-serif !important;
        }
		html, body { height: 100%; }
		body {
			margin: 0;
			background: linear-gradient(180deg, var(--bg), var(--panel-2));
			color: var(--text);
			font: 14px/1.5 ui-sans-serif, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
		}

		.container {
			max-width: 1280px;
			margin: 0 auto;
			padding: 24px;
		}

		.header {
			display: flex;
			flex-wrap: wrap;
			align-items: center;
			gap: 12px 16px;
			margin-bottom: 16px;
		}
		.header-title {
			font-size: 22px;
			font-weight: 700;
			letter-spacing: 0.2px;
		}
		.header-actions {
			margin-left: auto;
			display: flex;
			gap: 10px;
			align-items: center;
		}

		.toolbar {
			position: sticky;
			top: 0;
			z-index: 5;
			background: linear-gradient(180deg, var(--panel), var(--panel-2));
			border-bottom: 1px solid var(--border);
			backdrop-filter: saturate(140%) blur(6px);
		}
		.toolbar-inner {
			display: grid;
			grid-template-columns: 1fr auto auto;
			gap: 12px;
			padding: 12px 24px;
			max-width: 1280px;
			margin: 0 auto;
		}

		.input, .select {
			appearance: none;
			border: 1px solid var(--border);
			background: var(--panel);
			color: var(--text);
			padding: 10px 12px;
			border-radius: 10px;
			outline: none;
			width: 100%;
		}
		.input:focus, .select:focus { border-color: var(--brand); box-shadow: 0 0 0 3px color-mix(in oklab, var(--brand), transparent 80%); }
		.btn {
			border: 1px solid var(--border);
			background: var(--panel);
			color: var(--text);
			padding: 10px 14px;
			border-radius: 10px;
			cursor: pointer;
			transition: transform .06s ease, background .2s ease, border-color .2s ease;
			white-space: nowrap;
		}
		.btn:hover { background: var(--panel-2); border-color: color-mix(in oklab, var(--brand), var(--border) 60%); }
		.btn:active { transform: translateY(1px); }
		.btn-primary { background: color-mix(in oklab, var(--brand), var(--panel) 20%); border-color: var(--brand); }
		.btn-primary:hover { background: var(--brand); }
		.btn-ghost { background: transparent; }

		.card {
			background: color-mix(in oklab, var(--panel), var(--panel-2) 40%);
			border: 1px solid var(--border);
			border-radius: 14px;
			box-shadow: 0 6px 30px color-mix(in oklab, #000, transparent 85%);
			overflow: hidden;
		}

		.table-wrap { overflow: auto; }
		table { width: 100%; border-collapse: collapse; }
		thead th {
			position: sticky;
			background: linear-gradient(180deg, var(--panel), var(--panel-2));
			border-bottom: 1px solid var(--border);
			padding: 12px;
			text-align: left;
			font-weight: 700;
			font-size: 17px;
			text-transform: uppercase;
			letter-spacing: .06em;
			cursor: pointer;
			user-select: none;
			white-space: nowrap;
		}
		.th-toggle { font-size: 12px; font-weight: 600; text-transform: none; letter-spacing: normal; margin-left: 8px; cursor: default; }
		.th-toggle input { 
			vertical-align: middle; 
			margin-right: 6px; 
			width: 16px; 
			height: 16px; 
			cursor: pointer;
			accent-color: var(--brand);
		}
		.th-toggle input:hover { 
			transform: scale(1.1); 
			transition: transform 0.1s ease;
		}
		/* Make No. column non-clickable and compact */
		thead th.col-no { cursor: default; width: 64px; }
		td.col-no { text-align: center; font-size: 18px; white-space: nowrap; }

		.hide-lesson td.col-lesson,
		.hide-word td.col-word,
		.hide-kanji td.col-kanji,
		.hide-origin td.col-origin,
		.hide-meaning td.col-meaning { color: transparent; }
		.hide-lesson td.col-lesson *,
		.hide-word td.col-word *,
		.hide-kanji td.col-kanji *,
		.hide-origin td.col-origin *,
		.hide-meaning td.col-meaning * { color: transparent !important; }
		.hide-audio td.col-audio { visibility: hidden; }
		/* Row-level reveal overrides when global hide is active */
		.hide-lesson tr.reveal-hidden td.col-lesson,
		.hide-lesson tr.reveal-hidden td.col-lesson *,
		.hide-word tr.reveal-hidden td.col-word,
		.hide-word tr.reveal-hidden td.col-word *,
		.hide-kanji tr.reveal-hidden td.col-kanji,
		.hide-kanji tr.reveal-hidden td.col-kanji *,
		.hide-origin tr.reveal-hidden td.col-origin,
		.hide-origin tr.reveal-hidden td.col-origin *,
		.hide-meaning tr.reveal-hidden td.col-meaning,
		.hide-meaning tr.reveal-hidden td.col-meaning * { color: inherit !important; visibility: visible !important; }
		tbody td {
			border-bottom: 1px solid var(--border);
			padding: 12px;
			vertical-align: top;
			font-size: 17px;
		}
		tbody tr:hover { background: color-mix(in oklab, var(--panel-2), transparent 0%); }
		.badge { display: inline-block; padding: 10px; border-radius: 100%; background: color-mix(in oklab, var(--brand), transparent 82%); color: var(--brand); font-weight: 600; font-size: 12px; }
		td.col-lesson .badge { cursor: pointer; }
		.badge:hover .badge-text { display: none; }
			
		.controls {
			display: flex; gap: 8px; flex-wrap: wrap; align-items: center;
		}
		.controls .btn { padding: 6px 10px; font-size: 12px; }
		.audio-btn { display: inline-flex; align-items: center; gap: 6px; }

		.footer {
			display: flex; align-items: center; justify-content: space-between; gap: 12px;
			padding: 12px 16px; border-top: 1px solid var(--border); background: linear-gradient(180deg, var(--panel), var(--panel-2));
		}
		.pagination { display: flex; gap: 8px; align-items: center; }
		.page-btn { padding: 8px 12px; border-radius: 8px; border: 1px solid var(--border); background: var(--panel); color: var(--text); cursor: pointer; }
		.page-btn[disabled] { opacity: .5; cursor: not-allowed; }
		.page-info { color: var(--muted); font-size: 12px; }

		.status { padding: 10px 14px; background: color-mix(in oklab, var(--brand), transparent 85%); color: var(--brand); border: 1px solid color-mix(in oklab, var(--brand), transparent 60%); border-radius: 10px; }
		.status.error { background: color-mix(in oklab, var(--danger), transparent 90%); color: var(--danger); border-color: color-mix(in oklab, var(--danger), transparent 60%); }

		@media (max-width: 900px) {
			.toolbar-inner { grid-template-columns: 1fr 1fr; }
			/* With No. column added, hide Origin (4) and Meaning (5) on small screens */
			thead th:nth-child(4), tbody td:nth-child(4) { display: none; }
			thead th:nth-child(5), tbody td:nth-child(5) { display: none; }
		}
	</style>
</head>
<body>
	<div class="toolbar" role="region" aria-label="Thanh cÃ´ng cá»¥">
		<div class="toolbar-inner">
			<input id="searchInput" class="input" type="search" placeholder="TÃ¬m kiáº¿m: tá»«, HÃ¡n tá»±, nghÄ©a, nguá»“n gá»‘c, bÃ i..." aria-label="TÃ¬m kiáº¿m tá»« vá»±ng">
			<select id="lessonFilter" class="select" aria-label="Lá»c theo bÃ i há»c">
				<option value="">Táº¥t cáº£ bÃ i (Lesson)</option>
			</select>
			<div class="controls">
				<button class="btn" id="resetBtn" type="button">XÃ³a lá»c</button>
				<button class="btn btn-primary" id="exportBtn" type="button">Random danh sÃ¡ch</button>
			</div>
		</div>
	</div>

	<div class="container">
		<div class="header">
			<div class="header-title"></div>
			<div class="header-actions">
				<span id="status" class="status" role="status">Äang táº£i dá»¯ liá»‡uâ€¦</span>
			</div>
		</div>

		<div class="card">
			<div class="table-wrap">
				<table aria-describedby="status">
					<thead>
						<tr>
							<th scope="col" class="col-no">No.</th>
							<th data-key="word" scope="col">Tá»« <label class="th-toggle"><input type="checkbox" id="toggle-word"></label></th>
							<th data-key="kanji" scope="col">HÃ¡n tá»± <label class="th-toggle"><input type="checkbox" id="toggle-kanji"></label></th>
							<th data-key="vietnamese_origin" scope="col">Nguá»“n gá»‘c (VN) <label class="th-toggle"><input type="checkbox" id="toggle-origin"></label></th>
							<th data-key="meaning" scope="col">NghÄ©a <label class="th-toggle"><input type="checkbox" id="toggle-meaning"></label></th>
							<th scope="col">Ã‚m thanh</th>
							<th data-key="lesson" scope="col">BÃ i</th>
                        </tr>
					</thead>
					<tbody id="tableBody"></tbody>
				</table>
			</div>
			<div class="footer">
				<div class="pagination">
					<button class="page-btn" id="firstPage" aria-label="Trang Ä‘áº§u">Â«</button>
					<button class="page-btn" id="prevPage" aria-label="Trang trÆ°á»›c">â€¹</button>
					<span class="page-info" id="pageInfo">Trang 1/1</span>
					<button class="page-btn" id="nextPage" aria-label="Trang sau">â€º</button>
					<button class="page-btn" id="lastPage" aria-label="Trang cuá»‘i">Â»</button>
				</div>
				<div class="page-info" id="rowInfo">0 má»¥c</div>
			</div>
		</div>
	</div>

	<script>
		(function() {
			/** State */
			let rawData = [];
			let filtered = [];
			let currentSort = { key: 'lesson', dir: 'asc' };
			let currentPage = 1;
			let pageSize = 50;
			let isRandomOrder = false;
			const LS_KEY_LESSON = 'dictionary:selectedLesson';
			const LS_PREFIX_HIDE = 'dictionary:hide:';
			const TOGGLE_ID_TO_CLASS = {
				'toggle-word': 'hide-word',
				'toggle-kanji': 'hide-kanji',
				'toggle-origin': 'hide-origin',
				'toggle-meaning': 'hide-meaning'
			};
 
			/** Elements */
			const statusEl = document.getElementById('status');
			const searchInput = document.getElementById('searchInput');
			const lessonFilter = document.getElementById('lessonFilter');
			const resetBtn = document.getElementById('resetBtn');
			const exportBtn = document.getElementById('exportBtn');
			const tbody = document.getElementById('tableBody');
			const pageInfo = document.getElementById('pageInfo');
			const rowInfo = document.getElementById('rowInfo');
			const firstPageBtn = document.getElementById('firstPage');
			const prevPageBtn = document.getElementById('prevPage');
			const nextPageBtn = document.getElementById('nextPage');
			const lastPageBtn = document.getElementById('lastPage');
			const paginationEl = document.querySelector('.pagination');
			
			const audio = new Audio();
			audio.preload = 'none';

			/** Helpers */
			const NO_MAP = {
				"00": { label: "Trá»©ng gÃ ", emoji: "ğŸ¥š" },
				"01": { label: "BÃºt", emoji: "âœï¸" },
				"02": { label: "Con vá»‹t", emoji: "ğŸ¦†" },
				"03": { label: "ÄÃ´i mÃ´i", emoji: "ğŸ‘„" },
				"04": { label: "Gháº¿", emoji: "ğŸª‘" },
				"05": { label: "BÃ n tay", emoji: "âœ‹" },
				"06": { label: "Con rá»“ng", emoji: "ğŸ‰" },
				"07": { label: "LÆ°á»¡i cÃ¢u", emoji: "ğŸ£" },
				"08": { label: "Cáº·p kÃ­nh", emoji: "ğŸ‘“" },
				"09": { label: "BÃ³ng bay", emoji: "ğŸˆ" },
				"10": { label: "CÃ¢y náº¿n", emoji: "ğŸ•¯ï¸" },
				"11": { label: "Song kiáº¿m", emoji: "âš”ï¸" },
				"12": { label: "Äá»“ng há»“", emoji: "ğŸ•°ï¸" },
				"13": { label: "TrÃ¡i tim", emoji: "â¤ï¸" },
				"14": { label: "CÃ¢y thÃ´ng", emoji: "ğŸ„" },
				"15": { label: "NgÃ´i sao", emoji: "â­" },
				"16": { label: "CÃ¡ ngá»±a", emoji: "ğŸ" },
				"17": { label: "CÃ¢y Ä‘Ã n", emoji: "ğŸ¸" },
				"18": { label: "BÃ¡nh xe", emoji: "ğŸš²" },
				"19": { label: "Con mÃ¨o", emoji: "ğŸ±" },
				"20": { label: "CÃ¡i kÃ©o", emoji: "âœ‚ï¸" },
				"21": { label: "ChÃ¬a khÃ³a", emoji: "ğŸ”‘" },
				"22": { label: "ÄÃ´i thiÃªn nga", emoji: "ğŸ¦¢ğŸ¦¢" },
				"23": { label: "CÃ¢y Ä‘Ã n violin", emoji: "ğŸ»" },
				"24": { label: "Há»™p quÃ ", emoji: "ğŸ" },
				"25": { label: "Äá»“ng xu", emoji: "ğŸª™" },
				"26": { label: "á»c sÃªn", emoji: "ğŸŒ" },
				"27": { label: "CÃ¢y bÃºa", emoji: "ğŸ”¨" },
				"28": { label: "BÃ¡nh chÆ°ng", emoji: "ğŸƒ" },
				"29": { label: "Con cÃ¡", emoji: "ğŸŸ" },
				"30": { label: "BÃ´ng tai", emoji: "ğŸ’" },
				"31": { label: "CÃ¢y gáº­y", emoji: "âš–ï¸" },
				"32": { label: "Xe Ä‘áº¡p", emoji: "ğŸš²" },
				"33": { label: "ÄÃ´i mÃ´ng", emoji: "ğŸ˜‚" },
				"34": { label: "CÃ¢y sÃºng", emoji: "ğŸ”«" },
				"35": { label: "Hoa há»“ng", emoji: "ğŸŒ¹" },
				"36": { label: "ÄÃ¡ lá»­a", emoji: "ğŸ”¥" },
				"37": { label: "Thang gá»—", emoji: "ğŸªœ" },
				"38": { label: "NgÆ°á»i tuyáº¿t", emoji: "â›„" },
				"39": { label: "CÃ¡i roi", emoji: "ğŸª„" },
				"40": { label: "Quáº£ bÃ³ng", emoji: "âš½" },
				"41": { label: "Cá»™t cá»", emoji: "ğŸš©" },
				"42": { label: "Quáº£ chuá»‘i", emoji: "ğŸŒ" },
				"43": { label: "Tai nghe", emoji: "ğŸ§" },
				"44": { label: "Gháº¿ sofa", emoji: "ğŸ›‹ï¸" },
				"45": { label: "ThÆ°á»›c káº»", emoji: "ğŸ“" },
				"46": { label: "ChuÃ´ng", emoji: "ğŸ””" },
				"47": { label: "Thuyá»n buá»“m", emoji: "â›µ" },
				"48": { label: "MÃ¡y bay", emoji: "âœˆï¸" },
				"49": { label: "Quáº£ lá»±u Ä‘áº¡n", emoji: "ğŸ’£" },
				"50": { label: "Quáº£ cam", emoji: "ğŸŠ" },
				"51": { label: "Con chim", emoji: "ğŸ¦" },
				"52": { label: "Con ngá»—ng", emoji: "ğŸ¦¢" },
				"53": { label: "CÃ¡i cÃ²ng", emoji: "â›“ï¸" },
				"54": { label: "Xe táº£i", emoji: "ğŸšš" },
				"55": { label: "Song ngÅ©", emoji: "âœ‹âœ‹" },
				"56": { label: "SÃ¡o trÃºc", emoji: "ğŸ¶" },
				"57": { label: "MÃ¡y áº£nh", emoji: "ğŸ“·" },
				"58": { label: "CÃ¢y náº¥m", emoji: "ğŸ„" },
				"59": { label: "Con ngá»±a", emoji: "ğŸ´" },
				"60": { label: "Quáº£ Ä‘Ã o", emoji: "ğŸ‘" },
				"61": { label: "ViÃªn Ä‘áº¡n", emoji: "ğŸ’¥" },
				"62": { label: "Con cua", emoji: "ğŸ¦€" },
				"63": { label: "CÃ¡i cÃ ng", emoji: "ğŸ”§" },
				"64": { label: "CÃ¢y chá»•i", emoji: "ğŸ§¹" },
				"65": { label: "TrÃ¡i bÃ³ng rá»•", emoji: "ğŸ€" },
				"66": { label: "ÄÃ´i ráº¯n", emoji: "ğŸğŸ" },
				"67": { label: "Dao cáº¯t", emoji: "ğŸ´" },
				"68": { label: "Xe tÄƒng", emoji: "ğŸ›¡ï¸" },
				"69": { label: "CÃ¡i khÃ³a sá»‘", emoji: "ğŸ”’" },
				"70": { label: "CÃ¡i liá»m", emoji: "ğŸŒ¾" },
				"71": { label: "ÄÃ¨n pin", emoji: "ğŸ”¦" },
				"72": { label: "DÃ¢y Ä‘Ã n", emoji: "ğŸ¶" },
				"73": { label: "CÃ¡i mÅ©", emoji: "ğŸ©" },
				"74": { label: "CÃ¢y chÃ¹y", emoji: "ğŸª“" },
				"75": { label: "Con á»‘c", emoji: "ğŸš" },
				"76": { label: "Quáº£ chanh", emoji: "ğŸ‹" },
				"77": { label: "Song kiáº¿m bÃ¡ vÆ°Æ¡ng", emoji: "âš”ï¸âš”ï¸" },
				"78": { label: "BÃ¡nh pizza", emoji: "ğŸ•" },
				"79": { label: "Con ong", emoji: "ğŸ" },
				"80": { label: "Cáº·p kÃ­nh", emoji: "ğŸ‘“" },
				"81": { label: "Táº¥m gÆ°Æ¡ng", emoji: "ğŸª" },
				"82": { label: "CÃ¢y dÃ¹", emoji: "â˜‚ï¸" },
				"83": { label: "Chá»¯ B lá»›n", emoji: "ğŸ…±ï¸" },
				"84": { label: "CÃ¢y cung", emoji: "ğŸ¹" },
				"85": { label: "NgÃ´i nhÃ ", emoji: "ğŸ " },
				"86": { label: "Quáº£ nho", emoji: "ğŸ‡" },
				"87": { label: "CÃ¢y Ä‘Ã n piano", emoji: "ğŸ¹" },
				"88": { label: "XÃ­ch xe", emoji: "â›“ï¸" },
				"89": { label: "Con khá»‰", emoji: "ğŸ’" },
				"90": { label: "Quáº£ bÃ³ng bay", emoji: "ğŸˆ" },
				"91": { label: "CÃ¢y sÃºng lá»¥c", emoji: "ğŸ”«" },
				"92": { label: "ÄÃ´i giÃ y", emoji: "ğŸ‘Ÿ" },
				"93": { label: "TÃ u há»a", emoji: "ğŸš‚" },
				"94": { label: "Con rÃ¹a", emoji: "ğŸ¢" },
				"95": { label: "CÃ¡i ná»“i", emoji: "ğŸ²" },
				"96": { label: "Con chÃ³", emoji: "ğŸ•" },
				"97": { label: "CÃ¡i kÃ©o cáº¯t giáº¥y", emoji: "âœ‚ï¸" },
				"98": { label: "Äá»“ng há»“ cÃ¡t", emoji: "â³" },
				"99": { label: "ÄÃ´i bÃ³ng bÃ n", emoji: "ğŸ“" }
			};

			function encodeNo(n) {
				let s = String(n);
				if (s.length % 2 === 1) s = '0' + s;
				const emojis = [];
				const labels = [];
				for (let i = 0; i < s.length; i += 2) {
					const key = s.slice(i, i + 2);
					const ent = NO_MAP[key];
					if (ent) {
						emojis.push(ent.emoji);
						labels.push(ent.label);
					} else {
						emojis.push(key);
						labels.push(key);
					}
				}
				return { emojis: emojis.join(' '), label: labels.join(' + ') };
			}

			function normalizeText(s) {
				return (s || '').toString().toLowerCase().normalize('NFKD');
			}

			function isSingleLessonMode() {
				return !!lessonFilter.value;
			}

			// TTS fallback for rows without audio
			function fnPlayTTS(strText, strLang = 'ja') {
				let elAudioElement = document.getElementById('tts-audio');
				if (!elAudioElement) {
					elAudioElement = document.createElement('audio');
					elAudioElement.id = 'tts-audio';
					document.body.appendChild(elAudioElement);
				}
				const strUrl = `https://proxy.junookyo.workers.dev/?language=${strLang}&text=${encodeURIComponent(strText || '')}&speed=1`;
				elAudioElement.src = strUrl;
				elAudioElement.play().catch(err => {
					console.error('Lá»—i khi phÃ¡t TTS:', err);
					setStatus('KhÃ´ng phÃ¡t Ä‘Æ°á»£c TTS', true);
					setTimeout(() => setStatus(''), 2000);
				});
			}

			function compare(a, b, key) {
				const va = (a[key] ?? '').toString();
				const vb = (b[key] ?? '').toString();
				if (key === 'lesson') {
					const na = parseInt(va, 10);
					const nb = parseInt(vb, 10);
					if (!Number.isNaN(na) && !Number.isNaN(nb)) return na - nb;
				}
				return va.localeCompare(vb, 'vi');
			}

			function applySort() {
				if (isRandomOrder) return;
				const { key, dir } = currentSort;
				filtered.sort((a, b) => {
					const cmp = compare(a, b, key);
					return dir === 'asc' ? cmp : -cmp;
				});
			}

			function applyFilters() {
				isRandomOrder = false;
				const q = normalizeText(searchInput.value);
				const lesson = lessonFilter.value;
				filtered = rawData.filter(it => {
					if (lesson && it.lesson !== lesson) return false;
					if (!q) return true;
					const haystacks = [it.word, it.kanji, it.meaning, it.vietnamese_origin, it.lesson].map(normalizeText).join('\n');
					return haystacks.includes(q);
				});
				applySort();
				currentPage = 1;
				render();
			}

			function getPageCount() {
				if (isSingleLessonMode()) return 1;
				return Math.max(1, Math.ceil(filtered.length / pageSize));
			}

			function render() {
				const total = filtered.length;
				const pages = getPageCount();
				currentPage = Math.min(Math.max(1, currentPage), pages);
				const startIndex = isSingleLessonMode() ? 0 : (currentPage - 1) * pageSize;
				let rows;
				if (isSingleLessonMode()) {
					rows = filtered;
				} else {
					rows = filtered.slice(startIndex, startIndex + pageSize);
				}

				tbody.innerHTML = rows.map((row, i) => {
					const audioHtml = row.audio
						? `<button class="btn audio-btn" data-audio="${encodeURI(row.audio)}" aria-label="PhÃ¡t Ã¢m thanh">ğŸ§ PhÃ¡t</button>`
						: `<button class="btn audio-btn" data-tts="${escapeHtml(row.word || '')}" aria-label="PhÃ¡t TTS">ğŸ§ PhÃ¡t</button>`;
					const no = startIndex + i + 1;
					const noEnc = encodeNo(no);
					return `
						<tr>
							<td class="col-no"><span class="no-value" title="${escapeHtml(noEnc.label)}" aria-label="${escapeHtml(noEnc.label)}">${noEnc.emojis}</span></td>
							<td class="word col-word">${escapeHtml(row.word || 'â€•')}</td>
							<td class="kanji col-kanji">${escapeHtml(row.kanji || 'â€•')}</td>
							<td class="cell-muted col-origin">${escapeHtml(row.vietnamese_origin || 'â€•')}</td>
							<td class="meaning col-meaning">${escapeHtml(row.meaning || 'â€•')}</td>
							<td class="col-audio">${audioHtml}</td>
							<td class="col-lesson"><span class="badge" title="BÃ i ${escapeHtml(row.lesson || '')}">${escapeHtml(row.lesson || '')}</span></td>
						</tr>
					`;
				}).join('');

                Array.from(tbody.querySelectorAll('td .badge')).forEach(badge => {
					const tr = badge.closest('tr');
					if (!tr) return;
					badge.addEventListener('mouseenter', () => tr.classList.add('reveal-hidden'), { passive: true });
					badge.addEventListener('mouseleave', () => tr.classList.remove('reveal-hidden'), { passive: true });
				});

				pageInfo.textContent = `Trang ${currentPage}/${pages}`;
				rowInfo.textContent = `${total.toLocaleString('vi-VN')} má»¥c`;
				firstPageBtn.disabled = currentPage === 1;
				prevPageBtn.disabled = currentPage === 1;
				nextPageBtn.disabled = currentPage === pages;
				lastPageBtn.disabled = currentPage === pages;
				paginationEl.style.display = isSingleLessonMode() ? 'none' : 'flex';
			}

			function escapeHtml(s) {
				return (s ?? '').toString()
					.replaceAll('&', '&amp;')
					.replaceAll('<', '&lt;')
					.replaceAll('>', '&gt;')
					.replaceAll('"', '&quot;')
					.replaceAll("'", '&#39;');
			}

			function updateLessonsFilterOptions() {
				const lessons = Array.from(new Set(rawData.map(r => r.lesson).filter(Boolean))).sort((a, b) => parseInt(a, 10) - parseInt(b, 10));
				lessonFilter.innerHTML = '<option value="">Táº¥t cáº£ bÃ i (Lesson)</option>' + lessons.map(l => `<option value="${escapeHtml(l)}">BÃ i ${escapeHtml(l)}</option>`).join('');
			}

			function setStatus(text, isError = false) {
				statusEl.textContent = text;
				statusEl.classList.toggle('error', !!isError);
			}

			function onHeaderClick(e) {
				if (e.target.closest('.th-toggle')) return;
				const th = e.target.closest('th');
				if (!th) return;
				const key = th.dataset.key;
				if (!key) return;
				if (currentSort.key === key) {
					currentSort.dir = currentSort.dir === 'asc' ? 'desc' : 'asc';
				} else {
					currentSort = { key, dir: 'asc' };
				}
				isRandomOrder = false;
				applyFilters();
			}

			function exportCsv() {
				const headers = ['lesson','word','kanji','vietnamese_origin','meaning','audio'];
				// Create a shuffled copy of the filtered data (Fisherâ€“Yates)
				const data = filtered.slice();
				for (let i = data.length - 1; i > 0; i--) {
					const j = Math.floor(Math.random() * (i + 1));
					[data[i], data[j]] = [data[j], data[i]];
				}
				const lines = [headers.join(',')].concat(data.map(r => headers.map(h => toCsv(r[h])).join(',')));
				const blob = new Blob(["\uFEFF" + lines.join('\n')], { type: 'text/csv;charset=utf-8' });
				const url = URL.createObjectURL(blob);
				const a = document.createElement('a');
				a.href = url;
				a.download = 'vocabulary.csv';
				a.click();
				setTimeout(() => URL.revokeObjectURL(url), 1000);
			}
			function toCsv(v) {
				const s = (v ?? '').toString().replaceAll('"', '""');
				return '"' + s + '"';
			}

			function randomizeList() {
				if (!filtered.length) {
					setStatus('KhÃ´ng cÃ³ má»¥c nÃ o Ä‘á»ƒ random', true);
					setTimeout(() => setStatus(''), 2000);
					return;
				}
				for (let i = filtered.length - 1; i > 0; i--) {
					const j = Math.floor(Math.random() * (i + 1));
					[filtered[i], filtered[j]] = [filtered[j], filtered[i]];
				}
				isRandomOrder = true;
				currentPage = 1;
				render();
				setStatus(`ÄÃ£ random danh sÃ¡ch (${filtered.length.toLocaleString('vi-VN')} má»¥c)`);
			}

			/** Events */
			document.querySelector('thead').addEventListener('click', onHeaderClick);
			document.querySelector('thead').addEventListener('change', (e) => {
				const input = e.target.closest('input[type="checkbox"][id^="toggle-"]');
				if (!input) return;
				const cls = TOGGLE_ID_TO_CLASS[input.id];
				if (!cls) return;
				document.body.classList.toggle(cls, input.checked);
				localStorage.setItem(LS_PREFIX_HIDE + input.id, input.checked ? '1' : '0');
			});
			tbody.addEventListener('click', (e) => {
				const ttsBtn = e.target.closest('button[data-tts]');
				if (ttsBtn) {
					const text = ttsBtn.getAttribute('data-tts') || '';
					fnPlayTTS(text, 'ja');
					return;
				}
				const audioBtn = e.target.closest('button[data-audio]');
				if (audioBtn) {
					const src = audioBtn.getAttribute('data-audio');
					try {
						audio.pause();
						audio.src = src;
						audio.play();
					} catch (err) {
						console.error(err);
						setStatus('KhÃ´ng phÃ¡t Ä‘Æ°á»£c Ã¢m thanh', true);
						setTimeout(() => setStatus(''), 2000);
					}
					return;
				}
				const lessonCell = e.target.closest('td.col-lesson');
				if (lessonCell) {
					const tr = lessonCell.closest('tr');
					if (tr) tr.classList.toggle('reveal-hidden');
				}
			});
			searchInput.addEventListener('input', debounce(applyFilters, 120));
			lessonFilter.addEventListener('change', () => {
				const val = lessonFilter.value;
				if (val) localStorage.setItem(LS_KEY_LESSON, val);
				else localStorage.removeItem(LS_KEY_LESSON);
				applyFilters();
			});
			resetBtn.addEventListener('click', () => {
				searchInput.value = '';
				lessonFilter.value = '';
				localStorage.removeItem(LS_KEY_LESSON);
				currentSort = { key: 'lesson', dir: 'asc' };
				applyFilters();
			});
			exportBtn.addEventListener('click', randomizeList);

			firstPageBtn.addEventListener('click', () => { currentPage = 1; render(); });
			prevPageBtn.addEventListener('click', () => { currentPage = Math.max(1, currentPage - 1); render(); });
			nextPageBtn.addEventListener('click', () => { currentPage = Math.min(getPageCount(), currentPage + 1); render(); });
			lastPageBtn.addEventListener('click', () => { currentPage = getPageCount(); render(); });

			/** Debounce */
			function debounce(fn, wait) {
				let t = null;
				return function(...args) {
					clearTimeout(t);
					t = setTimeout(() => fn.apply(this, args), wait);
				};
			}

			/** Init: fetch data */
			(async function init() {
				try {
					setStatus('Äang táº£i dá»¯ liá»‡uâ€¦');
					// Resolve JSON path relative to this page
					const jsonPath = new URL('storage/japan/vocabulary.json', location.href).pathname;
					const res = await fetch(jsonPath, { cache: 'no-store' });
					if (!res.ok) throw new Error('HTTP ' + res.status);
					rawData = await res.json();
					updateLessonsFilterOptions();
					const savedLesson = localStorage.getItem(LS_KEY_LESSON);
					if (savedLesson && Array.from(lessonFilter.options).some(o => o.value === savedLesson)) {
						lessonFilter.value = savedLesson;
					}
					// Restore per-column hide states
					Object.entries(TOGGLE_ID_TO_CLASS).forEach(([id, cls]) => {
						const el = document.getElementById(id);
						if (!el) return;
						const saved = localStorage.getItem(LS_PREFIX_HIDE + id) === '1';
						el.checked = saved;
						document.body.classList.toggle(cls, saved);
					});
					applyFilters();
					setStatus(`${rawData.length.toLocaleString('vi-VN')} má»¥c Ä‘Ã£ táº£i`);
					setTimeout(() => setStatus('ÄÃ£ táº£i xong'), 1200);
				} catch (err) {
					console.error(err);
					setStatus('Lá»—i táº£i dá»¯ liá»‡u. Vui lÃ²ng kiá»ƒm tra Ä‘Æ°á»ng dáº«n JSON.', true);
				}
			})();
		})();
	</script>
</body>
</html>
