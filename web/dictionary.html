<!DOCTYPE html>
<html lang="vi">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Từ vựng Nhật - Từ @vocabulary.json</title>
	<meta name="description" content="Bảng từ vựng Nhật Bản với tìm kiếm, lọc theo bài, sắp xếp và phát âm thanh.">
	<style>
        @font-face {
            font-family: 'UTM Bauhaus';
            src: url('./css/fonts/UTM-Bauhaus-Light.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }
		:root {
			--bg: #0b0c10;
			--panel: #12141a;
			--panel-2: #171923;
			--text: #e8eaf0;
			--muted: #a7adc0;
			--brand: #4f8cff;
			--accent: #22c55e;
			--danger: #ef4444;
			--border: #2a2f3b;
		}
		@media (prefers-color-scheme: light) {
			:root {
				--bg: #f7f9fc;
				--panel: #ffffff;
				--panel-2: #f2f5fb;
				--text: #0e1116;
				--muted: #556078;
				--brand: #2563eb;
				--accent: #16a34a;
				--danger: #dc2626;
				--border: #e6eaf2;
			}
		}
		* { 
            margin: 0;
            padding: 0;
            box-sizing: border-box; 
            font-family: 'UTM Bauhaus', sans-serif !important;
        }
		html, body { height: 100%; }
		body {
			margin: 0;
			background: linear-gradient(180deg, var(--bg), var(--panel-2));
			color: var(--text);
			font: 14px/1.5 ui-sans-serif, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
		}

		.container {
			max-width: 1280px;
			margin: 0 auto;
			padding: 24px;
		}

		.header {
			display: flex;
			flex-wrap: wrap;
			align-items: center;
			gap: 12px 16px;
			margin-bottom: 16px;
		}
		.header-title {
			font-size: 22px;
			font-weight: 700;
			letter-spacing: 0.2px;
		}
		.header-actions {
			margin-left: auto;
			display: flex;
			gap: 10px;
			align-items: center;
		}

		.toolbar {
			position: sticky;
			top: 0;
			z-index: 5;
			background: linear-gradient(180deg, var(--panel), var(--panel-2));
			border-bottom: 1px solid var(--border);
			backdrop-filter: saturate(140%) blur(6px);
		}
		.toolbar-inner {
			display: grid;
			grid-template-columns: 1fr auto auto;
			gap: 12px;
			padding: 12px 24px;
			max-width: 1280px;
			margin: 0 auto;
		}

		.input, .select {
			appearance: none;
			border: 1px solid var(--border);
			background: var(--panel);
			color: var(--text);
			padding: 10px 12px;
			border-radius: 10px;
			outline: none;
			width: 100%;
		}
		.input:focus, .select:focus { border-color: var(--brand); box-shadow: 0 0 0 3px color-mix(in oklab, var(--brand), transparent 80%); }
		.btn {
			border: 1px solid var(--border);
			background: var(--panel);
			color: var(--text);
			padding: 10px 14px;
			border-radius: 10px;
			cursor: pointer;
			transition: transform .06s ease, background .2s ease, border-color .2s ease;
			white-space: nowrap;
		}
		.btn:hover { background: var(--panel-2); border-color: color-mix(in oklab, var(--brand), var(--border) 60%); }
		.btn:active { transform: translateY(1px); }
		.btn-primary { background: color-mix(in oklab, var(--brand), var(--panel) 20%); border-color: var(--brand); }
		.btn-primary:hover { background: var(--brand); }
		.btn-ghost { background: transparent; }

		.card {
			background: color-mix(in oklab, var(--panel), var(--panel-2) 40%);
			border: 1px solid var(--border);
			border-radius: 14px;
			box-shadow: 0 6px 30px color-mix(in oklab, #000, transparent 85%);
			overflow: hidden;
		}

		.table-wrap { overflow: auto; }
		table { width: 100%; border-collapse: collapse; }
		thead th {
			position: sticky;
			background: linear-gradient(180deg, var(--panel), var(--panel-2));
			border-bottom: 1px solid var(--border);
			padding: 12px;
			text-align: left;
			font-weight: 700;
			font-size: 17px;
			text-transform: uppercase;
			letter-spacing: .06em;
			cursor: pointer;
			user-select: none;
			white-space: nowrap;
		}
		.th-toggle { font-size: 12px; font-weight: 600; text-transform: none; letter-spacing: normal; margin-left: 8px; cursor: default; }
		.th-toggle input { 
			vertical-align: middle; 
			margin-right: 6px; 
			width: 16px; 
			height: 16px; 
			cursor: pointer;
			accent-color: var(--brand);
		}
		.th-toggle input:hover { 
			transform: scale(1.1); 
			transition: transform 0.1s ease;
		}
		.hide-lesson td.col-lesson,
		.hide-word td.col-word,
		.hide-kanji td.col-kanji,
		.hide-origin td.col-origin,
		.hide-meaning td.col-meaning { color: transparent; }
		.hide-lesson td.col-lesson *,
		.hide-word td.col-word *,
		.hide-kanji td.col-kanji *,
		.hide-origin td.col-origin *,
		.hide-meaning td.col-meaning * { color: transparent !important; }
		.hide-audio td.col-audio { visibility: hidden; }
		/* Row-level reveal overrides when global hide is active */
		.hide-lesson tr.reveal-hidden td.col-lesson,
		.hide-lesson tr.reveal-hidden td.col-lesson *,
		.hide-word tr.reveal-hidden td.col-word,
		.hide-word tr.reveal-hidden td.col-word *,
		.hide-kanji tr.reveal-hidden td.col-kanji,
		.hide-kanji tr.reveal-hidden td.col-kanji *,
		.hide-origin tr.reveal-hidden td.col-origin,
		.hide-origin tr.reveal-hidden td.col-origin *,
		.hide-meaning tr.reveal-hidden td.col-meaning,
		.hide-meaning tr.reveal-hidden td.col-meaning * { color: inherit !important; visibility: visible !important; }
		tbody td {
			border-bottom: 1px solid var(--border);
			padding: 12px;
			vertical-align: top;
			font-size: 17px;
		}
		tbody tr:hover { background: color-mix(in oklab, var(--panel-2), transparent 0%); }
		.badge { display: inline-block; padding: 10px; border-radius: 100%; background: color-mix(in oklab, var(--brand), transparent 82%); color: var(--brand); font-weight: 600; font-size: 12px; }
		td.col-lesson .badge { cursor: pointer; }
		.badge:hover .badge-text { display: none; }
			
		.controls {
			display: flex; gap: 8px; flex-wrap: wrap; align-items: center;
		}
		.controls .btn { padding: 6px 10px; font-size: 12px; }
		.audio-btn { display: inline-flex; align-items: center; gap: 6px; }

		.footer {
			display: flex; align-items: center; justify-content: space-between; gap: 12px;
			padding: 12px 16px; border-top: 1px solid var(--border); background: linear-gradient(180deg, var(--panel), var(--panel-2));
		}
		.pagination { display: flex; gap: 8px; align-items: center; }
		.page-btn { padding: 8px 12px; border-radius: 8px; border: 1px solid var(--border); background: var(--panel); color: var(--text); cursor: pointer; }
		.page-btn[disabled] { opacity: .5; cursor: not-allowed; }
		.page-info { color: var(--muted); font-size: 12px; }

		.status { padding: 10px 14px; background: color-mix(in oklab, var(--brand), transparent 85%); color: var(--brand); border: 1px solid color-mix(in oklab, var(--brand), transparent 60%); border-radius: 10px; }
		.status.error { background: color-mix(in oklab, var(--danger), transparent 90%); color: var(--danger); border-color: color-mix(in oklab, var(--danger), transparent 60%); }

		@media (max-width: 900px) {
			.toolbar-inner { grid-template-columns: 1fr 1fr; }
			thead th:nth-child(3), tbody td:nth-child(3) { display: none; }
			thead th:nth-child(4), tbody td:nth-child(4) { display: none; }
		}
	</style>
</head>
<body>
	<div class="toolbar" role="region" aria-label="Thanh công cụ">
		<div class="toolbar-inner">
			<input id="searchInput" class="input" type="search" placeholder="Tìm kiếm: từ, Hán tự, nghĩa, nguồn gốc, bài..." aria-label="Tìm kiếm từ vựng">
			<select id="lessonFilter" class="select" aria-label="Lọc theo bài học">
				<option value="">Tất cả bài (Lesson)</option>
			</select>
			<div class="controls">
				<button class="btn" id="resetBtn" type="button">Xóa lọc</button>
				<button class="btn btn-primary" id="exportBtn" type="button">Xuất CSV</button>
			</div>
		</div>
	</div>

	<div class="container">
		<div class="header">
			<div class="header-title"></div>
			<div class="header-actions">
				<span id="status" class="status" role="status">Đang tải dữ liệu…</span>
			</div>
		</div>

		<div class="card">
			<div class="table-wrap">
				<table aria-describedby="status">
					<thead>
						<tr>
							<th data-key="word" scope="col">Từ <label class="th-toggle"><input type="checkbox" id="toggle-word"></label></th>
							<th data-key="kanji" scope="col">Hán tự <label class="th-toggle"><input type="checkbox" id="toggle-kanji"></label></th>
							<th data-key="vietnamese_origin" scope="col">Nguồn gốc (VN) <label class="th-toggle"><input type="checkbox" id="toggle-origin"></label></th>
							<th data-key="meaning" scope="col">Nghĩa <label class="th-toggle"><input type="checkbox" id="toggle-meaning"></label></th>
							<th scope="col">Âm thanh</th>
							<th data-key="lesson" scope="col">Bài</th>
                        </tr>
					</thead>
					<tbody id="tableBody"></tbody>
				</table>
			</div>
			<div class="footer">
				<div class="pagination">
					<button class="page-btn" id="firstPage" aria-label="Trang đầu">«</button>
					<button class="page-btn" id="prevPage" aria-label="Trang trước">‹</button>
					<span class="page-info" id="pageInfo">Trang 1/1</span>
					<button class="page-btn" id="nextPage" aria-label="Trang sau">›</button>
					<button class="page-btn" id="lastPage" aria-label="Trang cuối">»</button>
				</div>
				<div class="page-info" id="rowInfo">0 mục</div>
			</div>
		</div>
	</div>

	<script>
		(function() {
			/** State */
			let rawData = [];
			let filtered = [];
			let currentSort = { key: 'lesson', dir: 'asc' };
			let currentPage = 1;
			let pageSize = 50;
			const LS_KEY_LESSON = 'dictionary:selectedLesson';
			const LS_PREFIX_HIDE = 'dictionary:hide:';
			const TOGGLE_ID_TO_CLASS = {
				'toggle-word': 'hide-word',
				'toggle-kanji': 'hide-kanji',
				'toggle-origin': 'hide-origin',
				'toggle-meaning': 'hide-meaning'
			};
 
			/** Elements */
			const statusEl = document.getElementById('status');
			const searchInput = document.getElementById('searchInput');
			const lessonFilter = document.getElementById('lessonFilter');
			const resetBtn = document.getElementById('resetBtn');
			const exportBtn = document.getElementById('exportBtn');
			const tbody = document.getElementById('tableBody');
			const pageInfo = document.getElementById('pageInfo');
			const rowInfo = document.getElementById('rowInfo');
			const firstPageBtn = document.getElementById('firstPage');
			const prevPageBtn = document.getElementById('prevPage');
			const nextPageBtn = document.getElementById('nextPage');
			const lastPageBtn = document.getElementById('lastPage');
			const paginationEl = document.querySelector('.pagination');
			
			const audio = new Audio();
			audio.preload = 'none';

			/** Helpers */
			function normalizeText(s) {
				return (s || '').toString().toLowerCase().normalize('NFKD');
			}

			function isSingleLessonMode() {
				return !!lessonFilter.value;
			}

			// TTS fallback for rows without audio
			function fnPlayTTS(strText, strLang = 'ja') {
				let elAudioElement = document.getElementById('tts-audio');
				if (!elAudioElement) {
					elAudioElement = document.createElement('audio');
					elAudioElement.id = 'tts-audio';
					document.body.appendChild(elAudioElement);
				}
				const strUrl = `https://proxy.junookyo.workers.dev/?language=${strLang}&text=${encodeURIComponent(strText || '')}&speed=1`;
				elAudioElement.src = strUrl;
				elAudioElement.play().catch(err => {
					console.error('Lỗi khi phát TTS:', err);
					setStatus('Không phát được TTS', true);
					setTimeout(() => setStatus(''), 2000);
				});
			}

			function compare(a, b, key) {
				const va = (a[key] ?? '').toString();
				const vb = (b[key] ?? '').toString();
				if (key === 'lesson') {
					const na = parseInt(va, 10);
					const nb = parseInt(vb, 10);
					if (!Number.isNaN(na) && !Number.isNaN(nb)) return na - nb;
				}
				return va.localeCompare(vb, 'vi');
			}

			function applySort() {
				const { key, dir } = currentSort;
				filtered.sort((a, b) => {
					const cmp = compare(a, b, key);
					return dir === 'asc' ? cmp : -cmp;
				});
			}

			function applyFilters() {
				const q = normalizeText(searchInput.value);
				const lesson = lessonFilter.value;
				filtered = rawData.filter(it => {
					if (lesson && it.lesson !== lesson) return false;
					if (!q) return true;
					const haystacks = [it.word, it.kanji, it.meaning, it.vietnamese_origin, it.lesson].map(normalizeText).join('\n');
					return haystacks.includes(q);
				});
				applySort();
				currentPage = 1;
				render();
			}

			function getPageCount() {
				if (isSingleLessonMode()) return 1;
				return Math.max(1, Math.ceil(filtered.length / pageSize));
			}

			function render() {
				const total = filtered.length;
				const pages = getPageCount();
				currentPage = Math.min(Math.max(1, currentPage), pages);
				let rows;
				if (isSingleLessonMode()) {
					rows = filtered;
				} else {
					const start = (currentPage - 1) * pageSize;
					rows = filtered.slice(start, start + pageSize);
				}

				tbody.innerHTML = rows.map(row => {
					const audioHtml = row.audio
						? `<button class="btn audio-btn" data-audio="${encodeURI(row.audio)}" aria-label="Phát âm thanh">🎧 Phát</button>`
						: `<button class="btn audio-btn" data-tts="${escapeHtml(row.word || '')}" aria-label="Phát TTS">🎧 Phát</button>`;
					return `
						<tr>
							<td class="word col-word">${escapeHtml(row.word || '―')}</td>
							<td class="kanji col-kanji">${escapeHtml(row.kanji || '―')}</td>
							<td class="cell-muted col-origin">${escapeHtml(row.vietnamese_origin || '―')}</td>
							<td class="meaning col-meaning">${escapeHtml(row.meaning || '―')}</td>
							<td class="col-audio">${audioHtml}</td>
							<td class="col-lesson"><span class="badge" title="Bài ${escapeHtml(row.lesson || '')}">${escapeHtml(row.lesson || '')}</span></td>
						</tr>
					`;
				}).join('');

                Array.from(tbody.querySelectorAll('td .badge')).forEach(badge => {
					const tr = badge.closest('tr');
					if (!tr) return;
					badge.addEventListener('mouseenter', () => tr.classList.add('reveal-hidden'), { passive: true });
					badge.addEventListener('mouseleave', () => tr.classList.remove('reveal-hidden'), { passive: true });
				});

				pageInfo.textContent = `Trang ${currentPage}/${pages}`;
				rowInfo.textContent = `${total.toLocaleString('vi-VN')} mục`;
				firstPageBtn.disabled = currentPage === 1;
				prevPageBtn.disabled = currentPage === 1;
				nextPageBtn.disabled = currentPage === pages;
				lastPageBtn.disabled = currentPage === pages;
				paginationEl.style.display = isSingleLessonMode() ? 'none' : 'flex';
			}

			function escapeHtml(s) {
				return (s ?? '').toString()
					.replaceAll('&', '&amp;')
					.replaceAll('<', '&lt;')
					.replaceAll('>', '&gt;')
					.replaceAll('"', '&quot;')
					.replaceAll("'", '&#39;');
			}

			function updateLessonsFilterOptions() {
				const lessons = Array.from(new Set(rawData.map(r => r.lesson).filter(Boolean))).sort((a, b) => parseInt(a, 10) - parseInt(b, 10));
				lessonFilter.innerHTML = '<option value="">Tất cả bài (Lesson)</option>' + lessons.map(l => `<option value="${escapeHtml(l)}">Bài ${escapeHtml(l)}</option>`).join('');
			}

			function setStatus(text, isError = false) {
				statusEl.textContent = text;
				statusEl.classList.toggle('error', !!isError);
			}

			function onHeaderClick(e) {
				if (e.target.closest('.th-toggle')) return;
				const th = e.target.closest('th');
				if (!th) return;
				const key = th.dataset.key;
				if (!key) return;
				if (currentSort.key === key) {
					currentSort.dir = currentSort.dir === 'asc' ? 'desc' : 'asc';
				} else {
					currentSort = { key, dir: 'asc' };
				}
				applyFilters();
			}

			function exportCsv() {
				const headers = ['lesson','word','kanji','vietnamese_origin','meaning','audio'];
				const lines = [headers.join(',')].concat(filtered.map(r => headers.map(h => toCsv(r[h])).join(',')));
				const blob = new Blob(["\uFEFF" + lines.join('\n')], { type: 'text/csv;charset=utf-8' });
				const url = URL.createObjectURL(blob);
				const a = document.createElement('a');
				a.href = url;
				a.download = 'vocabulary.csv';
				a.click();
				setTimeout(() => URL.revokeObjectURL(url), 1000);
			}
			function toCsv(v) {
				const s = (v ?? '').toString().replaceAll('"', '""');
				return '"' + s + '"';
			}

			/** Events */
			document.querySelector('thead').addEventListener('click', onHeaderClick);
			document.querySelector('thead').addEventListener('change', (e) => {
				const input = e.target.closest('input[type="checkbox"][id^="toggle-"]');
				if (!input) return;
				const cls = TOGGLE_ID_TO_CLASS[input.id];
				if (!cls) return;
				document.body.classList.toggle(cls, input.checked);
				localStorage.setItem(LS_PREFIX_HIDE + input.id, input.checked ? '1' : '0');
			});
			tbody.addEventListener('click', (e) => {
				const ttsBtn = e.target.closest('button[data-tts]');
				if (ttsBtn) {
					const text = ttsBtn.getAttribute('data-tts') || '';
					fnPlayTTS(text, 'ja');
					return;
				}
				const audioBtn = e.target.closest('button[data-audio]');
				if (audioBtn) {
					const src = audioBtn.getAttribute('data-audio');
					try {
						audio.pause();
						audio.src = src;
						audio.play();
					} catch (err) {
						console.error(err);
						setStatus('Không phát được âm thanh', true);
						setTimeout(() => setStatus(''), 2000);
					}
					return;
				}
				const lessonCell = e.target.closest('td.col-lesson');
				if (lessonCell) {
					const tr = lessonCell.closest('tr');
					if (tr) tr.classList.toggle('reveal-hidden');
				}
			});
			searchInput.addEventListener('input', debounce(applyFilters, 120));
			lessonFilter.addEventListener('change', () => {
				const val = lessonFilter.value;
				if (val) localStorage.setItem(LS_KEY_LESSON, val);
				else localStorage.removeItem(LS_KEY_LESSON);
				applyFilters();
			});
			resetBtn.addEventListener('click', () => {
				searchInput.value = '';
				lessonFilter.value = '';
				localStorage.removeItem(LS_KEY_LESSON);
				currentSort = { key: 'lesson', dir: 'asc' };
				applyFilters();
			});
			exportBtn.addEventListener('click', exportCsv);

			firstPageBtn.addEventListener('click', () => { currentPage = 1; render(); });
			prevPageBtn.addEventListener('click', () => { currentPage = Math.max(1, currentPage - 1); render(); });
			nextPageBtn.addEventListener('click', () => { currentPage = Math.min(getPageCount(), currentPage + 1); render(); });
			lastPageBtn.addEventListener('click', () => { currentPage = getPageCount(); render(); });

			/** Debounce */
			function debounce(fn, wait) {
				let t = null;
				return function(...args) {
					clearTimeout(t);
					t = setTimeout(() => fn.apply(this, args), wait);
				};
			}

			/** Init: fetch data */
			(async function init() {
				try {
					setStatus('Đang tải dữ liệu…');
					// Resolve JSON path relative to this page
					const jsonPath = new URL('../website/file/jp/vocabulary.json', location.href).pathname;
					const res = await fetch(jsonPath, { cache: 'no-store' });
					if (!res.ok) throw new Error('HTTP ' + res.status);
					rawData = await res.json();
					updateLessonsFilterOptions();
					const savedLesson = localStorage.getItem(LS_KEY_LESSON);
					if (savedLesson && Array.from(lessonFilter.options).some(o => o.value === savedLesson)) {
						lessonFilter.value = savedLesson;
					}
					// Restore per-column hide states
					Object.entries(TOGGLE_ID_TO_CLASS).forEach(([id, cls]) => {
						const el = document.getElementById(id);
						if (!el) return;
						const saved = localStorage.getItem(LS_PREFIX_HIDE + id) === '1';
						el.checked = saved;
						document.body.classList.toggle(cls, saved);
					});
					applyFilters();
					setStatus(`${rawData.length.toLocaleString('vi-VN')} mục đã tải`);
					setTimeout(() => setStatus('Đã tải xong'), 1200);
				} catch (err) {
					console.error(err);
					setStatus('Lỗi tải dữ liệu. Vui lòng kiểm tra đường dẫn JSON.', true);
				}
			})();
		})();
	</script>
</body>
</html>
